-- WARNING: This schema is for context only and is not meant to be run.
-- Table order and constraints may not be valid for execution.

CREATE TABLE public.access_activity_logs (
  id bigint NOT NULL DEFAULT nextval('access_activity_logs_id_seq'::regclass),
  system_user_id bigint NOT NULL,
  access_type text NOT NULL,
  page_name text,
  api_endpoint text,
  http_method text,
  action_performed text,
  action_result text,
  ip_address text,
  device_info text,
  session_id bigint,
  response_time_ms integer,
  request_params jsonb DEFAULT '{}'::jsonb,
  response_data jsonb DEFAULT '{}'::jsonb,
  created_at timestamp with time zone NOT NULL DEFAULT now(),
  CONSTRAINT access_activity_logs_pkey PRIMARY KEY (id),
  CONSTRAINT access_activity_logs_system_user_id_fkey FOREIGN KEY (system_user_id) REFERENCES public.system_users(id),
  CONSTRAINT access_activity_logs_session_id_fkey FOREIGN KEY (session_id) REFERENCES public.system_user_sessions(id)
);
CREATE TABLE public.access_api_endpoints (
  id bigint NOT NULL DEFAULT nextval('access_api_endpoints_id_seq'::regclass),
  endpoint_id text NOT NULL UNIQUE,
  endpoint_path text NOT NULL,
  http_method text NOT NULL,
  endpoint_description text,
  module_name USER-DEFINED NOT NULL,
  required_permissions ARRAY,
  rate_limit_per_minute integer DEFAULT 60,
  rate_limit_per_hour integer DEFAULT 1000,
  is_active boolean DEFAULT true,
  is_public boolean DEFAULT false,
  created_at timestamp with time zone NOT NULL DEFAULT now(),
  CONSTRAINT access_api_endpoints_pkey PRIMARY KEY (id)
);
CREATE TABLE public.access_approval_requests (
  id bigint NOT NULL DEFAULT nextval('access_approval_requests_id_seq'::regclass),
  workflow_id bigint NOT NULL,
  requester_user_id bigint NOT NULL,
  requester_name text,
  request_type text NOT NULL,
  request_reason text NOT NULL,
  request_data jsonb DEFAULT '{}'::jsonb,
  entity_type text NOT NULL,
  entity_id text NOT NULL,
  pending_approvers ARRAY,
  approved_by ARRAY,
  rejected_by bigint,
  approval_status text DEFAULT 'PENDING'::text,
  final_decision text,
  decision_notes text,
  decided_at timestamp with time zone,
  expires_at timestamp with time zone,
  created_at timestamp with time zone NOT NULL DEFAULT now(),
  updated_at timestamp with time zone NOT NULL DEFAULT now(),
  CONSTRAINT access_approval_requests_pkey PRIMARY KEY (id),
  CONSTRAINT access_approval_requests_workflow_id_fkey FOREIGN KEY (workflow_id) REFERENCES public.access_approval_workflows(id),
  CONSTRAINT access_approval_requests_requester_user_id_fkey FOREIGN KEY (requester_user_id) REFERENCES public.system_users(id)
);
CREATE TABLE public.access_approval_workflows (
  id bigint NOT NULL DEFAULT nextval('access_approval_workflows_id_seq'::regclass),
  workflow_id text NOT NULL UNIQUE,
  workflow_name text NOT NULL,
  workflow_description text,
  trigger_action text NOT NULL,
  trigger_module USER-DEFINED NOT NULL,
  approval_chain jsonb NOT NULL,
  requires_all_approvals boolean DEFAULT false,
  conditions jsonb DEFAULT '{}'::jsonb,
  approval_timeout_hours integer DEFAULT 24,
  is_active boolean DEFAULT true,
  created_at timestamp with time zone NOT NULL DEFAULT now(),
  updated_at timestamp with time zone NOT NULL DEFAULT now(),
  CONSTRAINT access_approval_workflows_pkey PRIMARY KEY (id)
);
CREATE TABLE public.access_delegation (
  id bigint NOT NULL DEFAULT nextval('access_delegation_id_seq'::regclass),
  delegator_user_id bigint NOT NULL,
  delegator_name text,
  delegate_user_id bigint NOT NULL,
  delegate_name text,
  delegated_permissions ARRAY,
  delegated_roles ARRAY,
  delegation_reason text NOT NULL,
  valid_from timestamp with time zone NOT NULL DEFAULT now(),
  valid_until timestamp with time zone NOT NULL,
  is_active boolean DEFAULT true,
  is_revoked boolean DEFAULT false,
  revoked_at timestamp with time zone,
  revoked_by bigint,
  revoke_reason text,
  approved_by bigint,
  approved_at timestamp with time zone,
  created_at timestamp with time zone NOT NULL DEFAULT now(),
  CONSTRAINT access_delegation_pkey PRIMARY KEY (id),
  CONSTRAINT access_delegation_delegator_user_id_fkey FOREIGN KEY (delegator_user_id) REFERENCES public.system_users(id),
  CONSTRAINT access_delegation_delegate_user_id_fkey FOREIGN KEY (delegate_user_id) REFERENCES public.system_users(id),
  CONSTRAINT access_delegation_revoked_by_fkey FOREIGN KEY (revoked_by) REFERENCES public.system_users(id),
  CONSTRAINT access_delegation_approved_by_fkey FOREIGN KEY (approved_by) REFERENCES public.system_users(id)
);
CREATE TABLE public.access_emergency_mode (
  id bigint NOT NULL DEFAULT nextval('access_emergency_mode_id_seq'::regclass),
  system_user_id bigint NOT NULL,
  system_user_name text,
  emergency_reason text NOT NULL,
  emergency_type text NOT NULL,
  elevated_permissions ARRAY,
  approved_by bigint,
  approved_at timestamp with time zone,
  activated_at timestamp with time zone NOT NULL DEFAULT now(),
  expires_at timestamp with time zone NOT NULL,
  is_active boolean DEFAULT true,
  is_revoked boolean DEFAULT false,
  revoked_at timestamp with time zone,
  revoked_by bigint,
  actions_performed jsonb DEFAULT '[]'::jsonb,
  created_at timestamp with time zone NOT NULL DEFAULT now(),
  CONSTRAINT access_emergency_mode_pkey PRIMARY KEY (id),
  CONSTRAINT access_emergency_mode_system_user_id_fkey FOREIGN KEY (system_user_id) REFERENCES public.system_users(id),
  CONSTRAINT access_emergency_mode_approved_by_fkey FOREIGN KEY (approved_by) REFERENCES public.system_users(id),
  CONSTRAINT access_emergency_mode_revoked_by_fkey FOREIGN KEY (revoked_by) REFERENCES public.system_users(id)
);
CREATE TABLE public.access_feature_flags (
  id bigint NOT NULL DEFAULT nextval('access_feature_flags_id_seq'::regclass),
  feature_id text NOT NULL UNIQUE,
  feature_name text NOT NULL UNIQUE,
  feature_description text,
  is_enabled boolean DEFAULT false,
  rollout_percentage integer DEFAULT 0,
  enabled_for_roles ARRAY,
  enabled_for_users ARRAY,
  environment text DEFAULT 'production'::text,
  created_at timestamp with time zone NOT NULL DEFAULT now(),
  updated_at timestamp with time zone NOT NULL DEFAULT now(),
  CONSTRAINT access_feature_flags_pkey PRIMARY KEY (id)
);
CREATE TABLE public.access_modules (
  id bigint NOT NULL DEFAULT nextval('access_modules_id_seq'::regclass),
  module_id text NOT NULL UNIQUE,
  module_name text NOT NULL UNIQUE,
  module_display_name text NOT NULL,
  module_description text,
  module_type USER-DEFINED NOT NULL,
  parent_module_id bigint,
  display_order integer DEFAULT 0,
  module_icon text,
  is_active boolean DEFAULT true,
  created_at timestamp with time zone NOT NULL DEFAULT now(),
  CONSTRAINT access_modules_pkey PRIMARY KEY (id),
  CONSTRAINT access_modules_parent_module_id_fkey FOREIGN KEY (parent_module_id) REFERENCES public.access_modules(id)
);
CREATE TABLE public.access_pages (
  id bigint NOT NULL DEFAULT nextval('access_pages_id_seq'::regclass),
  page_id text NOT NULL UNIQUE,
  module_id bigint NOT NULL,
  page_name text NOT NULL,
  page_display_name text NOT NULL,
  page_description text,
  route_path text NOT NULL UNIQUE,
  required_permissions ARRAY,
  is_active boolean DEFAULT true,
  created_at timestamp with time zone NOT NULL DEFAULT now(),
  CONSTRAINT access_pages_pkey PRIMARY KEY (id),
  CONSTRAINT access_pages_module_id_fkey FOREIGN KEY (module_id) REFERENCES public.access_modules(id)
);
CREATE TABLE public.access_restrictions (
  id bigint NOT NULL DEFAULT nextval('access_restrictions_id_seq'::regclass),
  system_user_id bigint NOT NULL,
  restriction_type text NOT NULL,
  allowed_days ARRAY,
  allowed_time_start time without time zone,
  allowed_time_end time without time zone,
  timezone text DEFAULT 'UTC'::text,
  allowed_ips ARRAY,
  blocked_ips ARRAY,
  allowed_countries ARRAY,
  allowed_cities ARRAY,
  allowed_device_types ARRAY,
  is_active boolean DEFAULT true,
  created_by bigint,
  created_at timestamp with time zone NOT NULL DEFAULT now(),
  CONSTRAINT access_restrictions_pkey PRIMARY KEY (id),
  CONSTRAINT access_restrictions_system_user_id_fkey FOREIGN KEY (system_user_id) REFERENCES public.system_users(id),
  CONSTRAINT access_restrictions_created_by_fkey FOREIGN KEY (created_by) REFERENCES public.system_users(id)
);
CREATE TABLE public.access_ui_components (
  id bigint NOT NULL DEFAULT nextval('access_ui_components_id_seq'::regclass),
  component_id text NOT NULL UNIQUE,
  page_id bigint,
  component_name text NOT NULL,
  component_type text,
  required_permission_id bigint,
  is_active boolean DEFAULT true,
  created_at timestamp with time zone NOT NULL DEFAULT now(),
  CONSTRAINT access_ui_components_pkey PRIMARY KEY (id),
  CONSTRAINT access_ui_components_page_id_fkey FOREIGN KEY (page_id) REFERENCES public.access_pages(id),
  CONSTRAINT access_ui_components_required_permission_id_fkey FOREIGN KEY (required_permission_id) REFERENCES public.system_permissions(id)
);
CREATE TABLE public.action_audit_log (
  id bigint NOT NULL DEFAULT nextval('action_audit_log_id_seq'::regclass),
  agent_id bigint NOT NULL,
  agent_email text NOT NULL,
  agent_name text,
  agent_role text,
  dashboard_type text NOT NULL,
  action_type text NOT NULL,
  resource_type text,
  resource_id text,
  action_details jsonb DEFAULT '{}'::jsonb,
  previous_values jsonb,
  new_values jsonb,
  ip_address text,
  user_agent text,
  request_path text,
  request_method text,
  action_status text DEFAULT 'SUCCESS'::text,
  error_message text,
  created_at timestamp with time zone NOT NULL DEFAULT now(),
  order_type text,
  CONSTRAINT action_audit_log_pkey PRIMARY KEY (id),
  CONSTRAINT action_audit_log_agent_id_fkey FOREIGN KEY (agent_id) REFERENCES public.system_users(id)
);
CREATE TABLE public.activity_logs (
  id bigint NOT NULL DEFAULT nextval('activity_logs_id_seq'::regclass),
  actor_id integer,
  action character varying NOT NULL,
  entity_type character varying NOT NULL,
  entity_id bigint NOT NULL,
  created_at timestamp with time zone NOT NULL DEFAULT now(),
  CONSTRAINT activity_logs_pkey PRIMARY KEY (id),
  CONSTRAINT activity_logs_actor_id_fkey FOREIGN KEY (actor_id) REFERENCES public.system_users(id)
);
CREATE TABLE public.admin_action_logs (
  id bigint NOT NULL DEFAULT nextval('admin_action_logs_id_seq'::regclass),
  admin_user_id integer NOT NULL,
  action text NOT NULL,
  entity_type text NOT NULL,
  entity_id integer NOT NULL,
  old_value jsonb,
  new_value jsonb,
  reason text,
  ip_address text,
  user_agent text,
  metadata jsonb DEFAULT '{}'::jsonb,
  created_at timestamp with time zone NOT NULL DEFAULT now(),
  CONSTRAINT admin_action_logs_pkey PRIMARY KEY (id)
);
CREATE TABLE public.advertisement_management_access (
  id bigint NOT NULL DEFAULT nextval('advertisement_management_access_id_seq'::regclass),
  system_user_id bigint NOT NULL UNIQUE,
  can_create_banner_ad boolean DEFAULT false,
  can_create_popup_ad boolean DEFAULT false,
  can_create_listing_ad boolean DEFAULT false,
  customer_app_access boolean DEFAULT false,
  merchant_app_access boolean DEFAULT false,
  rider_app_access boolean DEFAULT false,
  can_update_ad boolean DEFAULT false,
  can_activate_ad boolean DEFAULT false,
  can_deactivate_ad boolean DEFAULT false,
  can_view_ad_analytics boolean DEFAULT false,
  created_at timestamp with time zone NOT NULL DEFAULT now(),
  updated_at timestamp with time zone NOT NULL DEFAULT now(),
  CONSTRAINT advertisement_management_access_pkey PRIMARY KEY (id),
  CONSTRAINT advertisement_management_access_system_user_id_fkey FOREIGN KEY (system_user_id) REFERENCES public.system_users(id)
);
CREATE TABLE public.agent_activity_logs (
  id bigint NOT NULL DEFAULT nextval('agent_activity_logs_id_seq'::regclass),
  agent_user_id bigint NOT NULL,
  activity_date date NOT NULL DEFAULT CURRENT_DATE,
  online_time_minutes integer DEFAULT 0,
  break_time_minutes integer DEFAULT 0,
  active_time_minutes integer DEFAULT 0,
  tickets_assigned integer DEFAULT 0,
  tickets_resolved integer DEFAULT 0,
  tickets_closed integer DEFAULT 0,
  tickets_reopened integer DEFAULT 0,
  tickets_updated integer DEFAULT 0,
  tickets_replied integer DEFAULT 0,
  avg_first_response_time_minutes numeric,
  avg_resolution_time_minutes numeric,
  csat_score numeric,
  dsat_count integer DEFAULT 0,
  csat_count integer DEFAULT 0,
  service_breakdown jsonb DEFAULT '{}'::jsonb,
  status_summary jsonb DEFAULT '{}'::jsonb,
  metadata jsonb DEFAULT '{}'::jsonb,
  created_at timestamp with time zone NOT NULL DEFAULT now(),
  updated_at timestamp with time zone NOT NULL DEFAULT now(),
  CONSTRAINT agent_activity_logs_pkey PRIMARY KEY (id),
  CONSTRAINT agent_activity_logs_agent_user_id_fkey FOREIGN KEY (agent_user_id) REFERENCES public.system_users(id)
);
CREATE TABLE public.agent_availability_logs (
  id bigint NOT NULL DEFAULT nextval('agent_availability_logs_id_seq'::regclass),
  agent_user_id bigint NOT NULL,
  status text NOT NULL CHECK (status = ANY (ARRAY['online'::text, 'offline'::text, 'away'::text, 'busy'::text, 'break'::text])),
  previous_status text,
  reason text,
  ip_address text,
  user_agent text,
  changed_at timestamp with time zone NOT NULL DEFAULT now(),
  duration_minutes integer,
  CONSTRAINT agent_availability_logs_pkey PRIMARY KEY (id),
  CONSTRAINT agent_availability_logs_agent_user_id_fkey FOREIGN KEY (agent_user_id) REFERENCES public.system_users(id)
);
CREATE TABLE public.agent_break_logs (
  id bigint NOT NULL DEFAULT nextval('agent_break_logs_id_seq'::regclass),
  agent_user_id bigint NOT NULL,
  break_type text DEFAULT 'other'::text CHECK (break_type = ANY (ARRAY['lunch'::text, 'tea'::text, 'personal'::text, 'other'::text])),
  reason text,
  break_started_at timestamp with time zone NOT NULL DEFAULT now(),
  break_ended_at timestamp with time zone,
  duration_minutes integer,
  is_active boolean DEFAULT true,
  metadata jsonb DEFAULT '{}'::jsonb,
  created_at timestamp with time zone NOT NULL DEFAULT now(),
  updated_at timestamp with time zone NOT NULL DEFAULT now(),
  CONSTRAINT agent_break_logs_pkey PRIMARY KEY (id),
  CONSTRAINT agent_break_logs_agent_user_id_fkey FOREIGN KEY (agent_user_id) REFERENCES public.system_users(id)
);
CREATE TABLE public.agent_profiles (
  id bigint NOT NULL DEFAULT nextval('agent_profiles_id_seq'::regclass),
  user_id bigint NOT NULL UNIQUE,
  max_concurrent_tickets integer DEFAULT 10,
  max_daily_tickets integer DEFAULT 50,
  skill_tags ARRAY,
  supported_languages ARRAY DEFAULT ARRAY['en'::text],
  availability_schedule jsonb DEFAULT '{}'::jsonb,
  avg_resolution_time_minutes integer,
  avg_first_response_time_minutes integer,
  total_tickets_resolved integer DEFAULT 0,
  csat_avg_score numeric,
  is_online boolean DEFAULT false,
  last_online_at timestamp with time zone,
  created_at timestamp with time zone NOT NULL DEFAULT now(),
  updated_at timestamp with time zone NOT NULL DEFAULT now(),
  break_started_at timestamp with time zone,
  current_status text DEFAULT 'offline'::text CHECK (current_status = ANY (ARRAY['online'::text, 'offline'::text, 'break'::text, 'busy'::text])),
  total_online_time_minutes integer DEFAULT 0,
  total_break_time_minutes integer DEFAULT 0,
  last_activity_at timestamp with time zone,
  CONSTRAINT agent_profiles_pkey PRIMARY KEY (id),
  CONSTRAINT agent_profiles_user_id_fkey FOREIGN KEY (user_id) REFERENCES public.system_users(id)
);
CREATE TABLE public.api_call_logs (
  id bigint NOT NULL DEFAULT nextval('api_call_logs_id_seq'::regclass),
  provider_type USER-DEFINED NOT NULL,
  endpoint text NOT NULL,
  method text NOT NULL,
  request_payload jsonb,
  response_status_code integer,
  response_body jsonb,
  response_time_ms integer,
  success boolean DEFAULT false,
  error_message text,
  order_id bigint,
  created_at timestamp with time zone NOT NULL DEFAULT now(),
  CONSTRAINT api_call_logs_pkey PRIMARY KEY (id),
  CONSTRAINT api_call_logs_order_id_fkey FOREIGN KEY (order_id) REFERENCES public.orders(id)
);
CREATE TABLE public.api_rate_limits (
  id bigint NOT NULL DEFAULT nextval('api_rate_limits_id_seq'::regclass),
  rider_id integer,
  endpoint text NOT NULL,
  ip_address text,
  request_count integer NOT NULL DEFAULT 1,
  window_start timestamp with time zone NOT NULL,
  window_end timestamp with time zone NOT NULL,
  limit_exceeded boolean DEFAULT false,
  created_at timestamp with time zone NOT NULL DEFAULT now(),
  updated_at timestamp with time zone NOT NULL DEFAULT now(),
  CONSTRAINT api_rate_limits_pkey PRIMARY KEY (id),
  CONSTRAINT api_rate_limits_rider_id_fkey FOREIGN KEY (rider_id) REFERENCES public.riders(id)
);
CREATE TABLE public.app_versions (
  id bigint NOT NULL DEFAULT nextval('app_versions_id_seq'::regclass),
  platform text NOT NULL,
  version_code integer NOT NULL,
  version_name text NOT NULL,
  force_update_required boolean DEFAULT false,
  min_supported_version_code integer,
  release_notes text,
  release_notes_i18n jsonb DEFAULT '{}'::jsonb,
  download_url text,
  active boolean DEFAULT true,
  released_at timestamp with time zone NOT NULL DEFAULT now(),
  created_at timestamp with time zone NOT NULL DEFAULT now(),
  CONSTRAINT app_versions_pkey PRIMARY KEY (id)
);
CREATE TABLE public.area_assignments (
  id bigint NOT NULL DEFAULT nextval('area_assignments_id_seq'::regclass),
  system_user_id bigint NOT NULL,
  area_type USER-DEFINED NOT NULL,
  area_code text NOT NULL,
  area_name text NOT NULL,
  service_type USER-DEFINED,
  cities ARRAY,
  postal_codes ARRAY,
  geo_boundary jsonb,
  is_active boolean DEFAULT true,
  valid_from timestamp with time zone DEFAULT now(),
  valid_until timestamp with time zone,
  assigned_by bigint,
  assigned_at timestamp with time zone NOT NULL DEFAULT now(),
  created_at timestamp with time zone NOT NULL DEFAULT now(),
  CONSTRAINT area_assignments_pkey PRIMARY KEY (id),
  CONSTRAINT area_assignments_system_user_id_fkey FOREIGN KEY (system_user_id) REFERENCES public.system_users(id),
  CONSTRAINT area_assignments_assigned_by_fkey FOREIGN KEY (assigned_by) REFERENCES public.system_users(id)
);
CREATE TABLE public.area_managers (
  id bigint NOT NULL DEFAULT nextval('area_managers_id_seq'::regclass),
  user_id integer NOT NULL,
  manager_type USER-DEFINED NOT NULL,
  area_code text,
  locality_code text,
  city text,
  status USER-DEFINED NOT NULL DEFAULT 'ACTIVE'::area_manager_status,
  created_at timestamp with time zone NOT NULL DEFAULT now(),
  updated_at timestamp with time zone NOT NULL DEFAULT now(),
  CONSTRAINT area_managers_pkey PRIMARY KEY (id),
  CONSTRAINT area_managers_user_id_fkey FOREIGN KEY (user_id) REFERENCES public.system_users(id)
);
CREATE TABLE public.blacklist_history (
  id bigint NOT NULL DEFAULT nextval('blacklist_history_id_seq'::regclass),
  rider_id integer NOT NULL,
  reason text NOT NULL,
  banned boolean NOT NULL DEFAULT true,
  admin_user_id integer,
  created_at timestamp with time zone NOT NULL DEFAULT now(),
  service_type USER-DEFINED NOT NULL DEFAULT 'FOOD'::service_type,
  is_permanent boolean NOT NULL DEFAULT false,
  expires_at timestamp with time zone,
  source text NOT NULL DEFAULT 'agent'::text,
  CONSTRAINT blacklist_history_pkey PRIMARY KEY (id),
  CONSTRAINT blacklist_history_rider_id_fkey FOREIGN KEY (rider_id) REFERENCES public.riders(id)
);
CREATE TABLE public.cities (
  id bigint NOT NULL DEFAULT nextval('cities_id_seq'::regclass),
  name text NOT NULL,
  state text NOT NULL,
  country_code text NOT NULL DEFAULT 'IN'::text,
  timezone text,
  is_active boolean NOT NULL DEFAULT true,
  created_at timestamp with time zone NOT NULL DEFAULT now(),
  updated_at timestamp with time zone NOT NULL DEFAULT now(),
  CONSTRAINT cities_pkey PRIMARY KEY (id)
);
CREATE TABLE public.city_vehicle_rules (
  id bigint NOT NULL DEFAULT nextval('city_vehicle_rules_id_seq'::regclass),
  city_id bigint NOT NULL,
  service_type_id bigint NOT NULL,
  rule_type text NOT NULL,
  rule_config jsonb DEFAULT '{}'::jsonb,
  effective_from timestamp with time zone,
  effective_to timestamp with time zone,
  is_active boolean NOT NULL DEFAULT true,
  created_at timestamp with time zone NOT NULL DEFAULT now(),
  updated_at timestamp with time zone NOT NULL DEFAULT now(),
  CONSTRAINT city_vehicle_rules_pkey PRIMARY KEY (id),
  CONSTRAINT city_vehicle_rules_city_id_fkey FOREIGN KEY (city_id) REFERENCES public.cities(id),
  CONSTRAINT city_vehicle_rules_service_type_id_fkey FOREIGN KEY (service_type_id) REFERENCES public.service_types(id)
);
CREATE TABLE public.cod_collections (
  id bigint NOT NULL DEFAULT nextval('cod_collections_id_seq'::regclass),
  order_id bigint NOT NULL,
  amount numeric NOT NULL CHECK (amount > 0::numeric),
  collected_at timestamp with time zone NOT NULL DEFAULT now(),
  collected_by integer NOT NULL,
  collection_method text DEFAULT 'cash'::text,
  transaction_id text,
  receipt_url text,
  deposited_to_bank boolean DEFAULT false,
  deposited_at timestamp with time zone,
  metadata jsonb DEFAULT '{}'::jsonb,
  created_at timestamp with time zone NOT NULL DEFAULT now(),
  CONSTRAINT cod_collections_pkey PRIMARY KEY (id),
  CONSTRAINT cod_collections_order_id_fkey FOREIGN KEY (order_id) REFERENCES public.orders(id),
  CONSTRAINT cod_collections_collected_by_fkey FOREIGN KEY (collected_by) REFERENCES public.riders(id)
);
CREATE TABLE public.commission_history (
  id bigint NOT NULL DEFAULT nextval('commission_history_id_seq'::regclass),
  order_type USER-DEFINED NOT NULL,
  commission_percentage numeric,
  commission_fixed_amount numeric,
  commission_type text NOT NULL DEFAULT 'percentage'::text,
  city text,
  zone text,
  effective_from timestamp with time zone NOT NULL,
  effective_to timestamp with time zone,
  created_by integer,
  created_at timestamp with time zone NOT NULL DEFAULT now(),
  CONSTRAINT commission_history_pkey PRIMARY KEY (id)
);
CREATE TABLE public.compliance_audit_trail (
  id bigint NOT NULL DEFAULT nextval('compliance_audit_trail_id_seq'::regclass),
  compliance_type text NOT NULL,
  compliance_category text,
  system_user_id bigint,
  system_user_name text,
  role_at_time text,
  action_performed text NOT NULL,
  action_justification text,
  affected_entities jsonb DEFAULT '[]'::jsonb,
  affected_customer_count integer DEFAULT 0,
  data_accessed boolean DEFAULT false,
  data_exported boolean DEFAULT false,
  data_modified boolean DEFAULT false,
  data_deleted boolean DEFAULT false,
  approval_required boolean DEFAULT false,
  approved_by bigint,
  approved_at timestamp with time zone,
  compliance_metadata jsonb DEFAULT '{}'::jsonb,
  created_at timestamp with time zone NOT NULL DEFAULT now(),
  CONSTRAINT compliance_audit_trail_pkey PRIMARY KEY (id),
  CONSTRAINT compliance_audit_trail_system_user_id_fkey FOREIGN KEY (system_user_id) REFERENCES public.system_users(id),
  CONSTRAINT compliance_audit_trail_approved_by_fkey FOREIGN KEY (approved_by) REFERENCES public.system_users(id)
);
CREATE TABLE public.customer_activity_log (
  id bigint NOT NULL DEFAULT nextval('customer_activity_log_id_seq'::regclass),
  customer_id bigint NOT NULL,
  activity_type text NOT NULL,
  activity_description text,
  service_type USER-DEFINED,
  order_id bigint,
  device_id text,
  ip_address text,
  location_lat numeric,
  location_lon numeric,
  activity_metadata jsonb DEFAULT '{}'::jsonb,
  created_at timestamp with time zone NOT NULL DEFAULT now(),
  CONSTRAINT customer_activity_log_pkey PRIMARY KEY (id),
  CONSTRAINT customer_activity_log_customer_id_fkey FOREIGN KEY (customer_id) REFERENCES public.customers(id),
  CONSTRAINT customer_activity_log_order_id_fkey FOREIGN KEY (order_id) REFERENCES public.orders(id)
);
CREATE TABLE public.customer_address_history (
  id bigint NOT NULL DEFAULT nextval('customer_address_history_id_seq'::regclass),
  address_id bigint NOT NULL,
  customer_id bigint NOT NULL,
  address_snapshot jsonb NOT NULL,
  change_type text NOT NULL,
  changed_fields ARRAY,
  created_at timestamp with time zone NOT NULL DEFAULT now(),
  CONSTRAINT customer_address_history_pkey PRIMARY KEY (id),
  CONSTRAINT customer_address_history_address_id_fkey FOREIGN KEY (address_id) REFERENCES public.customer_addresses(id),
  CONSTRAINT customer_address_history_customer_id_fkey FOREIGN KEY (customer_id) REFERENCES public.customers(id)
);
CREATE TABLE public.customer_addresses (
  id bigint NOT NULL DEFAULT nextval('customer_addresses_id_seq'::regclass),
  customer_id bigint NOT NULL,
  address_id text NOT NULL UNIQUE,
  label USER-DEFINED NOT NULL DEFAULT 'HOME'::address_type,
  custom_label text,
  address_line1 text NOT NULL,
  address_line2 text,
  address_auto text,
  address_manual text,
  landmark text,
  city text NOT NULL,
  state text NOT NULL,
  postal_code text NOT NULL,
  country text DEFAULT 'IN'::text,
  latitude numeric CHECK (latitude IS NULL OR latitude >= '-90'::integer::numeric AND latitude <= 90::numeric),
  longitude numeric CHECK (longitude IS NULL OR longitude >= '-180'::integer::numeric AND longitude <= 180::numeric),
  is_delivery_address boolean DEFAULT true,
  is_pickup_address boolean DEFAULT false,
  contact_name text,
  contact_mobile text,
  delivery_instructions text,
  access_code text,
  floor_number text,
  is_default boolean DEFAULT false,
  is_verified boolean DEFAULT false,
  is_active boolean DEFAULT true,
  order_count integer DEFAULT 0,
  last_used_at timestamp with time zone,
  created_at timestamp with time zone NOT NULL DEFAULT now(),
  updated_at timestamp with time zone NOT NULL DEFAULT now(),
  deleted_at timestamp with time zone,
  CONSTRAINT customer_addresses_pkey PRIMARY KEY (id),
  CONSTRAINT customer_addresses_customer_id_fkey FOREIGN KEY (customer_id) REFERENCES public.customers(id)
);
CREATE TABLE public.customer_audit_log (
  id bigint NOT NULL DEFAULT nextval('customer_audit_log_id_seq'::regclass),
  customer_id bigint NOT NULL,
  action_type text NOT NULL,
  action_field text,
  old_value jsonb,
  new_value jsonb,
  actor_type text NOT NULL,
  actor_id bigint,
  actor_name text,
  ip_address text,
  device_id text,
  user_agent text,
  audit_metadata jsonb DEFAULT '{}'::jsonb,
  created_at timestamp with time zone NOT NULL DEFAULT now(),
  CONSTRAINT customer_audit_log_pkey PRIMARY KEY (id),
  CONSTRAINT customer_audit_log_customer_id_fkey FOREIGN KEY (customer_id) REFERENCES public.customers(id)
);
CREATE TABLE public.customer_auth (
  id bigint NOT NULL DEFAULT nextval('customer_auth_id_seq'::regclass),
  customer_id bigint NOT NULL UNIQUE,
  auth_provider text DEFAULT 'phone'::text,
  auth_uid text,
  last_otp text,
  last_otp_sent_at timestamp with time zone,
  otp_attempts integer DEFAULT 0,
  otp_locked_until timestamp with time zone,
  password_hash text,
  password_salt text,
  password_last_changed_at timestamp with time zone,
  two_factor_enabled boolean DEFAULT false,
  two_factor_secret text,
  recovery_email text,
  recovery_mobile text,
  created_at timestamp with time zone NOT NULL DEFAULT now(),
  updated_at timestamp with time zone NOT NULL DEFAULT now(),
  CONSTRAINT customer_auth_pkey PRIMARY KEY (id),
  CONSTRAINT customer_auth_customer_id_fkey FOREIGN KEY (customer_id) REFERENCES public.customers(id)
);
CREATE TABLE public.customer_blocks (
  id bigint NOT NULL DEFAULT nextval('customer_blocks_id_seq'::regclass),
  customer_id bigint NOT NULL,
  block_type text NOT NULL,
  service_type USER-DEFINED,
  block_reason text NOT NULL,
  block_reason_code text,
  block_notes text,
  blocked_by text NOT NULL,
  blocked_by_id integer,
  blocked_by_name text,
  blocked_at timestamp with time zone NOT NULL DEFAULT now(),
  blocked_until timestamp with time zone,
  auto_unblock boolean DEFAULT false,
  is_unblocked boolean DEFAULT false,
  unblocked_at timestamp with time zone,
  unblocked_by integer,
  unblock_reason text,
  created_at timestamp with time zone NOT NULL DEFAULT now(),
  updated_at timestamp with time zone NOT NULL DEFAULT now(),
  CONSTRAINT customer_blocks_pkey PRIMARY KEY (id),
  CONSTRAINT customer_blocks_customer_id_fkey FOREIGN KEY (customer_id) REFERENCES public.customers(id)
);
CREATE TABLE public.customer_consent_log (
  id bigint NOT NULL DEFAULT nextval('customer_consent_log_id_seq'::regclass),
  customer_id bigint NOT NULL,
  consent_type text NOT NULL,
  consent_version text NOT NULL,
  consent_given boolean NOT NULL,
  consent_date timestamp with time zone NOT NULL DEFAULT now(),
  consent_withdrawn boolean DEFAULT false,
  consent_withdrawn_at timestamp with time zone,
  ip_address text,
  device_id text,
  created_at timestamp with time zone NOT NULL DEFAULT now(),
  CONSTRAINT customer_consent_log_pkey PRIMARY KEY (id),
  CONSTRAINT customer_consent_log_customer_id_fkey FOREIGN KEY (customer_id) REFERENCES public.customers(id)
);
CREATE TABLE public.customer_contacts (
  id bigint NOT NULL DEFAULT nextval('customer_contacts_id_seq'::regclass),
  customer_id bigint NOT NULL,
  contact_name text NOT NULL,
  contact_mobile text NOT NULL,
  contact_email text,
  relation text,
  relation_detail text,
  is_emergency_contact boolean DEFAULT false,
  is_verified boolean DEFAULT false,
  verified_at timestamp with time zone,
  is_active boolean DEFAULT true,
  created_at timestamp with time zone NOT NULL DEFAULT now(),
  updated_at timestamp with time zone NOT NULL DEFAULT now(),
  CONSTRAINT customer_contacts_pkey PRIMARY KEY (id),
  CONSTRAINT customer_contacts_customer_id_fkey FOREIGN KEY (customer_id) REFERENCES public.customers(id)
);
CREATE TABLE public.customer_coupon_usage (
  id bigint NOT NULL DEFAULT nextval('customer_coupon_usage_id_seq'::regclass),
  customer_id bigint NOT NULL,
  customer_coupon_id bigint,
  order_id bigint NOT NULL,
  coupon_code text NOT NULL,
  discount_applied numeric NOT NULL,
  order_amount numeric,
  created_at timestamp with time zone NOT NULL DEFAULT now(),
  CONSTRAINT customer_coupon_usage_pkey PRIMARY KEY (id),
  CONSTRAINT customer_coupon_usage_customer_id_fkey FOREIGN KEY (customer_id) REFERENCES public.customers(id),
  CONSTRAINT customer_coupon_usage_customer_coupon_id_fkey FOREIGN KEY (customer_coupon_id) REFERENCES public.customer_coupons(id),
  CONSTRAINT customer_coupon_usage_order_id_fkey FOREIGN KEY (order_id) REFERENCES public.orders(id)
);
CREATE TABLE public.customer_coupons (
  id bigint NOT NULL DEFAULT nextval('customer_coupons_id_seq'::regclass),
  customer_id bigint NOT NULL,
  coupon_code text NOT NULL,
  coupon_title text,
  coupon_description text,
  coupon_type text NOT NULL,
  discount_value numeric,
  discount_percentage numeric,
  max_discount_amount numeric,
  min_order_amount numeric,
  applicable_services ARRAY,
  applicable_merchant_ids ARRAY,
  usage_limit integer DEFAULT 1,
  used_count integer DEFAULT 0,
  valid_from timestamp with time zone NOT NULL,
  valid_till timestamp with time zone NOT NULL,
  status USER-DEFINED NOT NULL DEFAULT 'ACTIVE'::coupon_status,
  coupon_source text,
  created_at timestamp with time zone NOT NULL DEFAULT now(),
  updated_at timestamp with time zone NOT NULL DEFAULT now(),
  CONSTRAINT customer_coupons_pkey PRIMARY KEY (id),
  CONSTRAINT customer_coupons_customer_id_fkey FOREIGN KEY (customer_id) REFERENCES public.customers(id)
);
CREATE TABLE public.customer_daily_analytics (
  id bigint NOT NULL DEFAULT nextval('customer_daily_analytics_id_seq'::regclass),
  customer_id bigint NOT NULL,
  analytics_date date NOT NULL,
  total_orders integer DEFAULT 0,
  completed_orders integer DEFAULT 0,
  cancelled_orders integer DEFAULT 0,
  food_orders integer DEFAULT 0,
  parcel_orders integer DEFAULT 0,
  ride_orders integer DEFAULT 0,
  total_spent numeric DEFAULT 0.0,
  total_saved numeric DEFAULT 0.0,
  tips_given numeric DEFAULT 0.0,
  avg_rating_given numeric,
  ratings_count integer DEFAULT 0,
  app_opens integer DEFAULT 0,
  time_spent_minutes integer DEFAULT 0,
  created_at timestamp with time zone NOT NULL DEFAULT now(),
  updated_at timestamp with time zone NOT NULL DEFAULT now(),
  CONSTRAINT customer_daily_analytics_pkey PRIMARY KEY (id),
  CONSTRAINT customer_daily_analytics_customer_id_fkey FOREIGN KEY (customer_id) REFERENCES public.customers(id)
);
CREATE TABLE public.customer_data_deletion_requests (
  id bigint NOT NULL DEFAULT nextval('customer_data_deletion_requests_id_seq'::regclass),
  customer_id bigint NOT NULL,
  deletion_reason text NOT NULL,
  deletion_type text DEFAULT 'FULL'::text,
  data_categories ARRAY,
  retain_order_history boolean DEFAULT true,
  retain_payment_history boolean DEFAULT true,
  request_status text DEFAULT 'PENDING'::text,
  approved_by integer,
  approved_at timestamp with time zone,
  rejection_reason text,
  deletion_started_at timestamp with time zone,
  deletion_completed_at timestamp with time zone,
  deletion_report jsonb DEFAULT '{}'::jsonb,
  created_at timestamp with time zone NOT NULL DEFAULT now(),
  updated_at timestamp with time zone NOT NULL DEFAULT now(),
  CONSTRAINT customer_data_deletion_requests_pkey PRIMARY KEY (id),
  CONSTRAINT customer_data_deletion_requests_customer_id_fkey FOREIGN KEY (customer_id) REFERENCES public.customers(id)
);
CREATE TABLE public.customer_devices (
  id bigint NOT NULL DEFAULT nextval('customer_devices_id_seq'::regclass),
  customer_id bigint NOT NULL,
  device_id text NOT NULL,
  device_fingerprint text,
  device_type USER-DEFINED NOT NULL,
  device_os text,
  device_os_version text,
  device_model text,
  device_brand text,
  app_version text,
  app_build_number text,
  ip_address text,
  ip_location text,
  network_type text,
  fcm_token text,
  apns_token text,
  push_enabled boolean DEFAULT true,
  is_primary boolean DEFAULT false,
  is_trusted boolean DEFAULT false,
  is_active boolean DEFAULT true,
  first_seen_at timestamp with time zone NOT NULL DEFAULT now(),
  last_active_at timestamp with time zone NOT NULL DEFAULT now(),
  last_ip text,
  created_at timestamp with time zone NOT NULL DEFAULT now(),
  updated_at timestamp with time zone NOT NULL DEFAULT now(),
  CONSTRAINT customer_devices_pkey PRIMARY KEY (id),
  CONSTRAINT customer_devices_customer_id_fkey FOREIGN KEY (customer_id) REFERENCES public.customers(id)
);
CREATE TABLE public.customer_disputes (
  id bigint NOT NULL DEFAULT nextval('customer_disputes_id_seq'::regclass),
  dispute_id text NOT NULL UNIQUE,
  customer_id bigint NOT NULL,
  order_id bigint NOT NULL,
  ticket_id bigint,
  dispute_type text NOT NULL,
  dispute_reason text NOT NULL,
  dispute_description text,
  disputed_against text NOT NULL,
  disputed_against_id bigint,
  evidence_urls ARRAY,
  evidence_description text,
  disputed_amount numeric,
  refund_amount numeric,
  dispute_status text DEFAULT 'OPEN'::text,
  resolution text,
  resolution_amount numeric,
  resolved_at timestamp with time zone,
  resolved_by integer,
  legal_case_number text,
  legal_notes text,
  created_at timestamp with time zone NOT NULL DEFAULT now(),
  updated_at timestamp with time zone NOT NULL DEFAULT now(),
  CONSTRAINT customer_disputes_pkey PRIMARY KEY (id),
  CONSTRAINT customer_disputes_customer_id_fkey FOREIGN KEY (customer_id) REFERENCES public.customers(id),
  CONSTRAINT customer_disputes_order_id_fkey FOREIGN KEY (order_id) REFERENCES public.orders(id),
  CONSTRAINT customer_disputes_ticket_id_fkey FOREIGN KEY (ticket_id) REFERENCES public.customer_tickets(id)
);
CREATE TABLE public.customer_favorites (
  id bigint NOT NULL DEFAULT nextval('customer_favorites_id_seq'::regclass),
  customer_id bigint NOT NULL,
  favorite_type text NOT NULL,
  merchant_store_id bigint,
  menu_item_id bigint,
  route_name text,
  route_from_lat numeric,
  route_from_lon numeric,
  route_to_lat numeric,
  route_to_lon numeric,
  order_count integer DEFAULT 0,
  last_ordered_at timestamp with time zone,
  created_at timestamp with time zone NOT NULL DEFAULT now(),
  CONSTRAINT customer_favorites_pkey PRIMARY KEY (id),
  CONSTRAINT customer_favorites_customer_id_fkey FOREIGN KEY (customer_id) REFERENCES public.customers(id),
  CONSTRAINT customer_favorites_menu_item_id_fkey FOREIGN KEY (menu_item_id) REFERENCES public.merchant_menu_items(id)
);
CREATE TABLE public.customer_fraud_alerts (
  id bigint NOT NULL DEFAULT nextval('customer_fraud_alerts_id_seq'::regclass),
  customer_id bigint NOT NULL,
  order_id bigint,
  alert_type text NOT NULL,
  alert_severity USER-DEFINED NOT NULL DEFAULT 'MEDIUM'::risk_level,
  alert_description text NOT NULL,
  evidence jsonb DEFAULT '{}'::jsonb,
  action_taken text,
  action_taken_at timestamp with time zone,
  action_taken_by integer,
  is_resolved boolean DEFAULT false,
  resolved_at timestamp with time zone,
  resolution_notes text,
  created_at timestamp with time zone NOT NULL DEFAULT now(),
  CONSTRAINT customer_fraud_alerts_pkey PRIMARY KEY (id),
  CONSTRAINT customer_fraud_alerts_customer_id_fkey FOREIGN KEY (customer_id) REFERENCES public.customers(id),
  CONSTRAINT customer_fraud_alerts_order_id_fkey FOREIGN KEY (order_id) REFERENCES public.orders(id)
);
CREATE TABLE public.customer_login_history (
  id bigint NOT NULL DEFAULT nextval('customer_login_history_id_seq'::regclass),
  customer_id bigint NOT NULL,
  login_method text NOT NULL,
  login_success boolean DEFAULT true,
  device_id text,
  device_type USER-DEFINED,
  device_model text,
  ip_address text,
  ip_location text,
  user_agent text,
  failure_reason text,
  session_id bigint,
  created_at timestamp with time zone NOT NULL DEFAULT now(),
  CONSTRAINT customer_login_history_pkey PRIMARY KEY (id),
  CONSTRAINT customer_login_history_customer_id_fkey FOREIGN KEY (customer_id) REFERENCES public.customers(id),
  CONSTRAINT customer_login_history_session_id_fkey FOREIGN KEY (session_id) REFERENCES public.customer_sessions(id)
);
CREATE TABLE public.customer_loyalty (
  id bigint NOT NULL DEFAULT nextval('customer_loyalty_id_seq'::regclass),
  customer_id bigint NOT NULL UNIQUE,
  loyalty_tier USER-DEFINED NOT NULL DEFAULT 'BRONZE'::loyalty_tier,
  tier_updated_at timestamp with time zone,
  total_orders integer DEFAULT 0,
  food_orders_count integer DEFAULT 0,
  parcel_orders_count integer DEFAULT 0,
  ride_orders_count integer DEFAULT 0,
  total_spent numeric DEFAULT 0.0,
  food_spent numeric DEFAULT 0.0,
  parcel_spent numeric DEFAULT 0.0,
  ride_spent numeric DEFAULT 0.0,
  reward_points_earned integer DEFAULT 0,
  reward_points_redeemed integer DEFAULT 0,
  reward_points_balance integer DEFAULT 0,
  current_order_streak integer DEFAULT 0,
  longest_order_streak integer DEFAULT 0,
  streak_last_order_date date,
  achievements ARRAY,
  badges ARRAY,
  tier_benefits jsonb DEFAULT '{}'::jsonb,
  last_order_date date,
  last_updated_at timestamp with time zone NOT NULL DEFAULT now(),
  created_at timestamp with time zone NOT NULL DEFAULT now(),
  CONSTRAINT customer_loyalty_pkey PRIMARY KEY (id),
  CONSTRAINT customer_loyalty_customer_id_fkey FOREIGN KEY (customer_id) REFERENCES public.customers(id)
);
CREATE TABLE public.customer_management_access (
  id bigint NOT NULL DEFAULT nextval('customer_management_access_id_seq'::regclass),
  system_user_id bigint NOT NULL UNIQUE,
  can_view_customer_profile boolean DEFAULT true,
  can_view_customer_orders boolean DEFAULT true,
  can_view_customer_financial boolean DEFAULT false,
  can_view_customer_pii boolean DEFAULT false,
  can_update_customer_details boolean DEFAULT false,
  can_update_customer_addresses boolean DEFAULT false,
  can_update_payment_methods boolean DEFAULT false,
  can_block_customer boolean DEFAULT false,
  can_unblock_customer boolean DEFAULT false,
  can_block_device boolean DEFAULT false,
  can_reset_password boolean DEFAULT false,
  can_process_refund boolean DEFAULT false,
  can_adjust_wallet boolean DEFAULT false,
  can_issue_coupon boolean DEFAULT false,
  can_view_tickets boolean DEFAULT true,
  can_respond_to_tickets boolean DEFAULT true,
  refund_approval_limit numeric DEFAULT 0,
  wallet_adjustment_limit numeric DEFAULT 0,
  created_at timestamp with time zone NOT NULL DEFAULT now(),
  updated_at timestamp with time zone NOT NULL DEFAULT now(),
  CONSTRAINT customer_management_access_pkey PRIMARY KEY (id),
  CONSTRAINT customer_management_access_system_user_id_fkey FOREIGN KEY (system_user_id) REFERENCES public.system_users(id)
);
CREATE TABLE public.customer_notification_preferences (
  id bigint NOT NULL DEFAULT nextval('customer_notification_preferences_id_seq'::regclass),
  customer_id bigint NOT NULL UNIQUE,
  order_updates boolean DEFAULT true,
  promotional_notifications boolean DEFAULT true,
  offer_notifications boolean DEFAULT true,
  loyalty_notifications boolean DEFAULT true,
  push_notifications boolean DEFAULT true,
  email_notifications boolean DEFAULT true,
  sms_notifications boolean DEFAULT true,
  whatsapp_notifications boolean DEFAULT false,
  quiet_hours_enabled boolean DEFAULT false,
  quiet_hours_start time without time zone,
  quiet_hours_end time without time zone,
  created_at timestamp with time zone NOT NULL DEFAULT now(),
  updated_at timestamp with time zone NOT NULL DEFAULT now(),
  CONSTRAINT customer_notification_preferences_pkey PRIMARY KEY (id),
  CONSTRAINT customer_notification_preferences_customer_id_fkey FOREIGN KEY (customer_id) REFERENCES public.customers(id)
);
CREATE TABLE public.customer_orders_summary (
  id bigint NOT NULL DEFAULT nextval('customer_orders_summary_id_seq'::regclass),
  customer_id bigint NOT NULL,
  order_id bigint NOT NULL,
  service_type USER-DEFINED NOT NULL,
  order_type USER-DEFINED NOT NULL,
  order_value numeric DEFAULT 0.0,
  discount_applied numeric DEFAULT 0.0,
  amount_paid numeric DEFAULT 0.0,
  order_status USER-DEFINED,
  order_placed_at timestamp with time zone,
  order_completed_at timestamp with time zone,
  order_cancelled_at timestamp with time zone,
  customer_rating_given smallint,
  customer_review_given boolean DEFAULT false,
  created_at timestamp with time zone NOT NULL DEFAULT now(),
  CONSTRAINT customer_orders_summary_pkey PRIMARY KEY (id),
  CONSTRAINT customer_orders_summary_customer_id_fkey FOREIGN KEY (customer_id) REFERENCES public.customers(id),
  CONSTRAINT customer_orders_summary_order_id_fkey FOREIGN KEY (order_id) REFERENCES public.orders(id)
);
CREATE TABLE public.customer_payment_history (
  id bigint NOT NULL DEFAULT nextval('customer_payment_history_id_seq'::regclass),
  customer_id bigint NOT NULL,
  order_id bigint,
  payment_id text NOT NULL UNIQUE,
  payment_method USER-DEFINED NOT NULL,
  payment_provider text,
  payment_amount numeric NOT NULL,
  payment_status text NOT NULL,
  pg_order_id text,
  pg_payment_id text,
  pg_transaction_id text,
  failure_reason text,
  failure_code text,
  payment_metadata jsonb DEFAULT '{}'::jsonb,
  created_at timestamp with time zone NOT NULL DEFAULT now(),
  CONSTRAINT customer_payment_history_pkey PRIMARY KEY (id),
  CONSTRAINT customer_payment_history_customer_id_fkey FOREIGN KEY (customer_id) REFERENCES public.customers(id),
  CONSTRAINT customer_payment_history_order_id_fkey FOREIGN KEY (order_id) REFERENCES public.orders(id)
);
CREATE TABLE public.customer_payment_methods (
  id bigint NOT NULL DEFAULT nextval('customer_payment_methods_id_seq'::regclass),
  customer_id bigint NOT NULL,
  payment_type USER-DEFINED NOT NULL,
  provider text,
  card_token text,
  card_last4 text,
  card_brand text,
  card_expiry_month integer,
  card_expiry_year integer,
  card_holder_name text,
  upi_id text,
  upi_verified boolean DEFAULT false,
  wallet_provider text,
  wallet_phone text,
  bank_name text,
  is_default boolean DEFAULT false,
  is_verified boolean DEFAULT false,
  is_active boolean DEFAULT true,
  token_reference text,
  usage_count integer DEFAULT 0,
  last_used_at timestamp with time zone,
  created_at timestamp with time zone NOT NULL DEFAULT now(),
  updated_at timestamp with time zone NOT NULL DEFAULT now(),
  deleted_at timestamp with time zone,
  CONSTRAINT customer_payment_methods_pkey PRIMARY KEY (id),
  CONSTRAINT customer_payment_methods_customer_id_fkey FOREIGN KEY (customer_id) REFERENCES public.customers(id)
);
CREATE TABLE public.customer_preferences (
  id bigint NOT NULL DEFAULT nextval('customer_preferences_id_seq'::regclass),
  customer_id bigint NOT NULL UNIQUE,
  default_service USER-DEFINED DEFAULT 'FOOD'::service_type,
  contact_less_delivery_default boolean DEFAULT false,
  leave_at_door_default boolean DEFAULT false,
  preferred_payment_method USER-DEFINED,
  auto_apply_wallet boolean DEFAULT true,
  save_delivery_instructions boolean DEFAULT true,
  reorder_favorites boolean DEFAULT true,
  allow_calls boolean DEFAULT true,
  allow_sms boolean DEFAULT true,
  allow_whatsapp boolean DEFAULT true,
  created_at timestamp with time zone NOT NULL DEFAULT now(),
  updated_at timestamp with time zone NOT NULL DEFAULT now(),
  CONSTRAINT customer_preferences_pkey PRIMARY KEY (id),
  CONSTRAINT customer_preferences_customer_id_fkey FOREIGN KEY (customer_id) REFERENCES public.customers(id)
);
CREATE TABLE public.customer_privacy_settings (
  id bigint NOT NULL DEFAULT nextval('customer_privacy_settings_id_seq'::regclass),
  customer_id bigint NOT NULL UNIQUE,
  share_location boolean DEFAULT true,
  share_profile_with_riders boolean DEFAULT true,
  show_order_history boolean DEFAULT true,
  marketing_consent boolean DEFAULT false,
  marketing_consent_date timestamp with time zone,
  share_data_with_partners boolean DEFAULT false,
  gdpr_consent boolean DEFAULT true,
  gdpr_consent_date timestamp with time zone,
  data_processing_consent boolean DEFAULT true,
  created_at timestamp with time zone NOT NULL DEFAULT now(),
  updated_at timestamp with time zone NOT NULL DEFAULT now(),
  CONSTRAINT customer_privacy_settings_pkey PRIMARY KEY (id),
  CONSTRAINT customer_privacy_settings_customer_id_fkey FOREIGN KEY (customer_id) REFERENCES public.customers(id)
);
CREATE TABLE public.customer_profiles_history (
  id bigint NOT NULL DEFAULT nextval('customer_profiles_history_id_seq'::regclass),
  customer_id bigint NOT NULL,
  field_name text NOT NULL,
  old_value text,
  new_value text,
  change_reason text,
  changed_by text NOT NULL,
  changed_by_id integer,
  created_at timestamp with time zone NOT NULL DEFAULT now(),
  CONSTRAINT customer_profiles_history_pkey PRIMARY KEY (id),
  CONSTRAINT customer_profiles_history_customer_id_fkey FOREIGN KEY (customer_id) REFERENCES public.customers(id)
);
CREATE TABLE public.customer_ratings_given (
  id bigint NOT NULL DEFAULT nextval('customer_ratings_given_id_seq'::regclass),
  customer_id bigint NOT NULL,
  order_id bigint,
  service_type USER-DEFINED NOT NULL,
  target_type text NOT NULL,
  target_id bigint,
  overall_rating smallint NOT NULL CHECK (overall_rating >= 1 AND overall_rating <= 5),
  food_quality_rating smallint CHECK (food_quality_rating >= 1 AND food_quality_rating <= 5),
  delivery_rating smallint CHECK (delivery_rating >= 1 AND delivery_rating <= 5),
  packaging_rating smallint CHECK (packaging_rating >= 1 AND packaging_rating <= 5),
  review_title text,
  review_text text,
  review_images ARRAY,
  review_tags ARRAY,
  helpful_count integer DEFAULT 0,
  not_helpful_count integer DEFAULT 0,
  merchant_response text,
  merchant_responded_at timestamp with time zone,
  is_verified boolean DEFAULT false,
  is_featured boolean DEFAULT false,
  is_flagged boolean DEFAULT false,
  flag_reason text,
  created_at timestamp with time zone NOT NULL DEFAULT now(),
  updated_at timestamp with time zone NOT NULL DEFAULT now(),
  CONSTRAINT customer_ratings_given_pkey PRIMARY KEY (id),
  CONSTRAINT customer_ratings_given_customer_id_fkey FOREIGN KEY (customer_id) REFERENCES public.customers(id),
  CONSTRAINT customer_ratings_given_order_id_fkey FOREIGN KEY (order_id) REFERENCES public.orders(id)
);
CREATE TABLE public.customer_ratings_received (
  id bigint NOT NULL DEFAULT nextval('customer_ratings_received_id_seq'::regclass),
  customer_id bigint NOT NULL,
  order_id bigint,
  rider_id integer,
  rating smallint NOT NULL CHECK (rating >= 1 AND rating <= 5),
  comment text,
  behavior_rating smallint CHECK (behavior_rating >= 1 AND behavior_rating <= 5),
  punctuality_rating smallint CHECK (punctuality_rating >= 1 AND punctuality_rating <= 5),
  created_at timestamp with time zone NOT NULL DEFAULT now(),
  CONSTRAINT customer_ratings_received_pkey PRIMARY KEY (id),
  CONSTRAINT customer_ratings_received_customer_id_fkey FOREIGN KEY (customer_id) REFERENCES public.customers(id),
  CONSTRAINT customer_ratings_received_order_id_fkey FOREIGN KEY (order_id) REFERENCES public.orders(id),
  CONSTRAINT customer_ratings_received_rider_id_fkey FOREIGN KEY (rider_id) REFERENCES public.riders(id)
);
CREATE TABLE public.customer_referral_rewards (
  id bigint NOT NULL DEFAULT nextval('customer_referral_rewards_id_seq'::regclass),
  referral_id bigint NOT NULL,
  customer_id bigint NOT NULL,
  reward_type text NOT NULL,
  reward_amount numeric NOT NULL,
  reward_mode text,
  coupon_code text,
  coupon_id bigint,
  reward_status text DEFAULT 'PENDING'::text,
  credited_at timestamp with time zone,
  created_at timestamp with time zone NOT NULL DEFAULT now(),
  CONSTRAINT customer_referral_rewards_pkey PRIMARY KEY (id),
  CONSTRAINT customer_referral_rewards_referral_id_fkey FOREIGN KEY (referral_id) REFERENCES public.customer_referrals(id),
  CONSTRAINT customer_referral_rewards_customer_id_fkey FOREIGN KEY (customer_id) REFERENCES public.customers(id),
  CONSTRAINT customer_referral_rewards_coupon_id_fkey FOREIGN KEY (coupon_id) REFERENCES public.customer_coupons(id)
);
CREATE TABLE public.customer_referrals (
  id bigint NOT NULL DEFAULT nextval('customer_referrals_id_seq'::regclass),
  referrer_customer_id bigint NOT NULL,
  referred_customer_id bigint NOT NULL UNIQUE,
  referral_code text NOT NULL,
  referral_status text DEFAULT 'PENDING'::text,
  referrer_reward_amount numeric,
  referrer_reward_type text,
  referrer_reward_given boolean DEFAULT false,
  referrer_reward_given_at timestamp with time zone,
  referred_reward_amount numeric,
  referred_reward_type text,
  referred_reward_given boolean DEFAULT false,
  referred_reward_given_at timestamp with time zone,
  required_orders integer DEFAULT 1,
  completed_orders integer DEFAULT 0,
  completion_deadline timestamp with time zone,
  completed_at timestamp with time zone,
  created_at timestamp with time zone NOT NULL DEFAULT now(),
  updated_at timestamp with time zone NOT NULL DEFAULT now(),
  CONSTRAINT customer_referrals_pkey PRIMARY KEY (id),
  CONSTRAINT customer_referrals_referrer_customer_id_fkey FOREIGN KEY (referrer_customer_id) REFERENCES public.customers(id),
  CONSTRAINT customer_referrals_referred_customer_id_fkey FOREIGN KEY (referred_customer_id) REFERENCES public.customers(id)
);
CREATE TABLE public.customer_refund_requests (
  id bigint NOT NULL DEFAULT nextval('customer_refund_requests_id_seq'::regclass),
  refund_request_id text NOT NULL UNIQUE,
  customer_id bigint NOT NULL,
  order_id bigint NOT NULL,
  refund_type text NOT NULL,
  refund_reason text NOT NULL,
  refund_reason_code text,
  refund_description text,
  requested_amount numeric NOT NULL,
  approved_amount numeric,
  refund_items jsonb DEFAULT '[]'::jsonb,
  refund_status text DEFAULT 'PENDING'::text,
  processed_by integer,
  processed_at timestamp with time zone,
  rejection_reason text,
  completed_at timestamp with time zone,
  refund_mode text,
  created_at timestamp with time zone NOT NULL DEFAULT now(),
  updated_at timestamp with time zone NOT NULL DEFAULT now(),
  CONSTRAINT customer_refund_requests_pkey PRIMARY KEY (id),
  CONSTRAINT customer_refund_requests_customer_id_fkey FOREIGN KEY (customer_id) REFERENCES public.customers(id),
  CONSTRAINT customer_refund_requests_order_id_fkey FOREIGN KEY (order_id) REFERENCES public.orders(id)
);
CREATE TABLE public.customer_review_helpfulness (
  id bigint NOT NULL DEFAULT nextval('customer_review_helpfulness_id_seq'::regclass),
  review_id bigint NOT NULL,
  voted_by_customer_id bigint NOT NULL,
  is_helpful boolean NOT NULL,
  created_at timestamp with time zone NOT NULL DEFAULT now(),
  CONSTRAINT customer_review_helpfulness_pkey PRIMARY KEY (id),
  CONSTRAINT customer_review_helpfulness_review_id_fkey FOREIGN KEY (review_id) REFERENCES public.customer_ratings_given(id),
  CONSTRAINT customer_review_helpfulness_voted_by_customer_id_fkey FOREIGN KEY (voted_by_customer_id) REFERENCES public.customers(id)
);
CREATE TABLE public.customer_reviews (
  id bigint GENERATED ALWAYS AS IDENTITY NOT NULL,
  created_at timestamp with time zone NOT NULL DEFAULT timezone('utc'::text, now()),
  name text,
  email text,
  review text,
  stars integer,
  status text DEFAULT 'pending'::text,
  is_read boolean DEFAULT false,
  response_by text,
  response_message text,
  CONSTRAINT customer_reviews_pkey PRIMARY KEY (id)
);
CREATE TABLE public.customer_reward_transactions (
  id bigint NOT NULL DEFAULT nextval('customer_reward_transactions_id_seq'::regclass),
  customer_id bigint NOT NULL,
  transaction_type text NOT NULL,
  points integer NOT NULL,
  balance_before integer NOT NULL,
  balance_after integer NOT NULL,
  reference_id text,
  reference_type text,
  description text NOT NULL,
  expires_at timestamp with time zone,
  created_at timestamp with time zone NOT NULL DEFAULT now(),
  CONSTRAINT customer_reward_transactions_pkey PRIMARY KEY (id),
  CONSTRAINT customer_reward_transactions_customer_id_fkey FOREIGN KEY (customer_id) REFERENCES public.customers(id)
);
CREATE TABLE public.customer_saved_locations (
  id bigint NOT NULL DEFAULT nextval('customer_saved_locations_id_seq'::regclass),
  customer_id bigint NOT NULL,
  location_name text NOT NULL,
  location_type text,
  formatted_address text NOT NULL,
  latitude numeric NOT NULL,
  longitude numeric NOT NULL,
  usage_count integer DEFAULT 0,
  last_used_at timestamp with time zone,
  is_favorite boolean DEFAULT false,
  created_at timestamp with time zone NOT NULL DEFAULT now(),
  updated_at timestamp with time zone NOT NULL DEFAULT now(),
  CONSTRAINT customer_saved_locations_pkey PRIMARY KEY (id),
  CONSTRAINT customer_saved_locations_customer_id_fkey FOREIGN KEY (customer_id) REFERENCES public.customers(id)
);
CREATE TABLE public.customer_service_analytics (
  id bigint NOT NULL DEFAULT nextval('customer_service_analytics_id_seq'::regclass),
  customer_id bigint NOT NULL,
  service_type USER-DEFINED NOT NULL,
  total_orders integer DEFAULT 0,
  completed_orders integer DEFAULT 0,
  cancelled_orders integer DEFAULT 0,
  cancellation_rate numeric DEFAULT 0.0,
  total_spent numeric DEFAULT 0.0,
  average_order_value numeric DEFAULT 0.0,
  first_order_at timestamp with time zone,
  last_order_at timestamp with time zone,
  avg_days_between_orders numeric,
  avg_rating_given numeric,
  ratings_given_count integer DEFAULT 0,
  favorite_merchant_ids ARRAY,
  last_updated_at timestamp with time zone NOT NULL DEFAULT now(),
  created_at timestamp with time zone NOT NULL DEFAULT now(),
  CONSTRAINT customer_service_analytics_pkey PRIMARY KEY (id),
  CONSTRAINT customer_service_analytics_customer_id_fkey FOREIGN KEY (customer_id) REFERENCES public.customers(id)
);
CREATE TABLE public.customer_sessions (
  id bigint NOT NULL DEFAULT nextval('customer_sessions_id_seq'::regclass),
  customer_id bigint NOT NULL,
  device_id bigint,
  session_token text NOT NULL UNIQUE,
  refresh_token text,
  ip_address text,
  user_agent text,
  location_lat numeric,
  location_lon numeric,
  is_active boolean DEFAULT true,
  created_at timestamp with time zone NOT NULL DEFAULT now(),
  expires_at timestamp with time zone NOT NULL,
  last_activity_at timestamp with time zone NOT NULL DEFAULT now(),
  logged_out_at timestamp with time zone,
  CONSTRAINT customer_sessions_pkey PRIMARY KEY (id),
  CONSTRAINT customer_sessions_customer_id_fkey FOREIGN KEY (customer_id) REFERENCES public.customers(id),
  CONSTRAINT customer_sessions_device_id_fkey FOREIGN KEY (device_id) REFERENCES public.customer_devices(id)
);
CREATE TABLE public.customer_suspicious_activity (
  id bigint NOT NULL DEFAULT nextval('customer_suspicious_activity_id_seq'::regclass),
  customer_id bigint NOT NULL,
  activity_type text NOT NULL,
  activity_description text NOT NULL,
  detected_by text NOT NULL,
  detection_confidence numeric,
  risk_score numeric,
  evidence jsonb DEFAULT '{}'::jsonb,
  requires_review boolean DEFAULT true,
  reviewed boolean DEFAULT false,
  reviewed_at timestamp with time zone,
  reviewed_by integer,
  review_notes text,
  action_recommended text,
  action_taken text,
  created_at timestamp with time zone NOT NULL DEFAULT now(),
  CONSTRAINT customer_suspicious_activity_pkey PRIMARY KEY (id),
  CONSTRAINT customer_suspicious_activity_customer_id_fkey FOREIGN KEY (customer_id) REFERENCES public.customers(id)
);
CREATE TABLE public.customer_ticket_messages (
  id bigint NOT NULL DEFAULT nextval('customer_ticket_messages_id_seq'::regclass),
  ticket_id bigint NOT NULL,
  message_text text NOT NULL,
  message_type text DEFAULT 'TEXT'::text,
  sender_type text NOT NULL,
  sender_id bigint,
  sender_name text,
  attachments ARRAY,
  is_read boolean DEFAULT false,
  read_at timestamp with time zone,
  created_at timestamp with time zone NOT NULL DEFAULT now(),
  CONSTRAINT customer_ticket_messages_pkey PRIMARY KEY (id),
  CONSTRAINT customer_ticket_messages_ticket_id_fkey FOREIGN KEY (ticket_id) REFERENCES public.customer_tickets(id)
);
CREATE TABLE public.customer_tickets (
  id bigint NOT NULL DEFAULT nextval('customer_tickets_id_seq'::regclass),
  ticket_id text NOT NULL UNIQUE,
  customer_id bigint NOT NULL,
  order_id bigint,
  service_type USER-DEFINED,
  issue_category text NOT NULL,
  issue_subcategory text,
  subject text NOT NULL,
  description text NOT NULL,
  attachments ARRAY,
  priority text NOT NULL DEFAULT 'MEDIUM'::text,
  status USER-DEFINED NOT NULL DEFAULT 'OPEN'::ticket_status_customer,
  assigned_to_agent_id integer,
  assigned_to_agent_name text,
  assigned_at timestamp with time zone,
  resolution text,
  resolution_time_minutes integer,
  resolved_at timestamp with time zone,
  resolved_by integer,
  customer_satisfaction_rating smallint CHECK (customer_satisfaction_rating >= 1 AND customer_satisfaction_rating <= 5),
  follow_up_required boolean DEFAULT false,
  follow_up_date timestamp with time zone,
  created_at timestamp with time zone NOT NULL DEFAULT now(),
  updated_at timestamp with time zone NOT NULL DEFAULT now(),
  CONSTRAINT customer_tickets_pkey PRIMARY KEY (id),
  CONSTRAINT customer_tickets_customer_id_fkey FOREIGN KEY (customer_id) REFERENCES public.customers(id),
  CONSTRAINT customer_tickets_order_id_fkey FOREIGN KEY (order_id) REFERENCES public.orders(id)
);
CREATE TABLE public.customer_tips_given (
  id bigint NOT NULL DEFAULT nextval('customer_tips_given_id_seq'::regclass),
  customer_id bigint NOT NULL,
  order_id bigint NOT NULL,
  rider_id integer NOT NULL,
  tip_amount numeric NOT NULL CHECK (tip_amount > 0::numeric),
  tip_message text,
  tip_paid boolean DEFAULT false,
  paid_at timestamp with time zone,
  created_at timestamp with time zone NOT NULL DEFAULT now(),
  CONSTRAINT customer_tips_given_pkey PRIMARY KEY (id),
  CONSTRAINT customer_tips_given_customer_id_fkey FOREIGN KEY (customer_id) REFERENCES public.customers(id),
  CONSTRAINT customer_tips_given_order_id_fkey FOREIGN KEY (order_id) REFERENCES public.orders(id),
  CONSTRAINT customer_tips_given_rider_id_fkey FOREIGN KEY (rider_id) REFERENCES public.riders(id)
);
CREATE TABLE public.customer_trust_score (
  id bigint NOT NULL DEFAULT nextval('customer_trust_score_id_seq'::regclass),
  customer_id bigint NOT NULL UNIQUE,
  trust_score numeric DEFAULT 100.0,
  fraud_score numeric DEFAULT 0.0,
  risk_level USER-DEFINED DEFAULT 'LOW'::risk_level,
  payment_reliability_score numeric DEFAULT 100.0,
  order_completion_score numeric DEFAULT 100.0,
  false_complaint_score numeric DEFAULT 100.0,
  verification_score numeric DEFAULT 100.0,
  is_fraudulent boolean DEFAULT false,
  is_suspicious boolean DEFAULT false,
  requires_review boolean DEFAULT false,
  last_calculated_at timestamp with time zone NOT NULL DEFAULT now(),
  created_at timestamp with time zone NOT NULL DEFAULT now(),
  updated_at timestamp with time zone NOT NULL DEFAULT now(),
  CONSTRAINT customer_trust_score_pkey PRIMARY KEY (id),
  CONSTRAINT customer_trust_score_customer_id_fkey FOREIGN KEY (customer_id) REFERENCES public.customers(id)
);
CREATE TABLE public.customer_verification_history (
  id bigint NOT NULL DEFAULT nextval('customer_verification_history_id_seq'::regclass),
  customer_id bigint NOT NULL,
  verification_type USER-DEFINED NOT NULL,
  verification_method text,
  verification_status text NOT NULL,
  attempt_number integer DEFAULT 1,
  failure_reason text,
  ip_address text,
  device_id text,
  created_at timestamp with time zone NOT NULL DEFAULT now(),
  CONSTRAINT customer_verification_history_pkey PRIMARY KEY (id),
  CONSTRAINT customer_verification_history_customer_id_fkey FOREIGN KEY (customer_id) REFERENCES public.customers(id)
);
CREATE TABLE public.customer_wallet (
  id bigint NOT NULL DEFAULT nextval('customer_wallet_id_seq'::regclass),
  customer_id bigint NOT NULL UNIQUE,
  current_balance numeric DEFAULT 0.0 CHECK (current_balance >= 0::numeric),
  locked_amount numeric DEFAULT 0.0 CHECK (locked_amount >= 0::numeric),
  available_balance numeric DEFAULT 0.0 CHECK (available_balance >= 0::numeric),
  max_balance numeric DEFAULT 10000.0,
  min_transaction_amount numeric DEFAULT 1.0,
  max_transaction_amount numeric DEFAULT 10000.0,
  is_active boolean DEFAULT true,
  kyc_verified boolean DEFAULT false,
  last_transaction_at timestamp with time zone,
  created_at timestamp with time zone NOT NULL DEFAULT now(),
  updated_at timestamp with time zone NOT NULL DEFAULT now(),
  CONSTRAINT customer_wallet_pkey PRIMARY KEY (id),
  CONSTRAINT customer_wallet_customer_id_fkey FOREIGN KEY (customer_id) REFERENCES public.customers(id)
);
CREATE TABLE public.customer_wallet_transactions (
  id bigint NOT NULL DEFAULT nextval('customer_wallet_transactions_id_seq'::regclass),
  customer_id bigint NOT NULL,
  transaction_id text NOT NULL UNIQUE,
  transaction_type USER-DEFINED NOT NULL,
  amount numeric NOT NULL CHECK (amount >= 0::numeric),
  balance_before numeric NOT NULL,
  balance_after numeric NOT NULL,
  reference_id text,
  reference_type text,
  description text NOT NULL,
  status text DEFAULT 'COMPLETED'::text,
  pg_transaction_id text,
  pg_response jsonb DEFAULT '{}'::jsonb,
  transaction_metadata jsonb DEFAULT '{}'::jsonb,
  created_at timestamp with time zone NOT NULL DEFAULT now(),
  CONSTRAINT customer_wallet_transactions_pkey PRIMARY KEY (id),
  CONSTRAINT customer_wallet_transactions_customer_id_fkey FOREIGN KEY (customer_id) REFERENCES public.customers(id)
);
CREATE TABLE public.customers (
  id bigint NOT NULL DEFAULT nextval('customers_id_seq'::regclass),
  customer_id text NOT NULL UNIQUE,
  full_name text NOT NULL,
  first_name text,
  last_name text,
  email text UNIQUE,
  email_verified boolean DEFAULT false,
  primary_mobile text NOT NULL UNIQUE CHECK (primary_mobile ~ '^\+?[0-9]{10,15}$'::text),
  primary_mobile_normalized text,
  primary_mobile_country_code text DEFAULT '+91'::text,
  mobile_verified boolean DEFAULT true,
  alternate_mobile text,
  whatsapp_number text,
  gender USER-DEFINED,
  date_of_birth date,
  profile_image_url text,
  bio text,
  preferred_language text DEFAULT 'en'::text,
  referral_code text UNIQUE,
  referred_by text,
  referrer_customer_id bigint,
  account_status USER-DEFINED NOT NULL DEFAULT 'ACTIVE'::customer_status,
  status_reason text,
  risk_flag USER-DEFINED DEFAULT 'LOW'::risk_level,
  trust_score numeric DEFAULT 100.0 CHECK (trust_score >= 0::numeric AND trust_score <= 100::numeric),
  fraud_score numeric DEFAULT 0.0 CHECK (fraud_score >= 0::numeric AND fraud_score <= 100::numeric),
  wallet_balance numeric DEFAULT 0.0 CHECK (wallet_balance >= 0::numeric),
  wallet_locked_amount numeric DEFAULT 0.0,
  is_identity_verified boolean DEFAULT false,
  is_email_verified boolean DEFAULT false,
  is_mobile_verified boolean DEFAULT true,
  last_login_at timestamp with time zone,
  last_order_at timestamp with time zone,
  last_activity_at timestamp with time zone,
  deleted_at timestamp with time zone,
  deleted_by integer,
  deletion_reason text,
  created_at timestamp with time zone NOT NULL DEFAULT now(),
  updated_at timestamp with time zone NOT NULL DEFAULT now(),
  created_via text DEFAULT 'app'::text,
  updated_by text,
  CONSTRAINT customers_pkey PRIMARY KEY (id),
  CONSTRAINT customers_referrer_customer_id_fkey FOREIGN KEY (referrer_customer_id) REFERENCES public.customers(id)
);
CREATE TABLE public.dashboard_access (
  id bigint NOT NULL DEFAULT nextval('dashboard_access_id_seq'::regclass),
  system_user_id bigint NOT NULL,
  dashboard_type text NOT NULL,
  access_level text NOT NULL DEFAULT 'VIEW_ONLY'::text,
  is_active boolean DEFAULT true,
  granted_by bigint NOT NULL,
  granted_by_name text,
  granted_at timestamp with time zone NOT NULL DEFAULT now(),
  revoked_at timestamp with time zone,
  revoked_by bigint,
  revoke_reason text,
  created_at timestamp with time zone NOT NULL DEFAULT now(),
  updated_at timestamp with time zone NOT NULL DEFAULT now(),
  order_type text,
  CONSTRAINT dashboard_access_pkey PRIMARY KEY (id),
  CONSTRAINT dashboard_access_system_user_id_fkey FOREIGN KEY (system_user_id) REFERENCES public.system_users(id),
  CONSTRAINT dashboard_access_granted_by_fkey FOREIGN KEY (granted_by) REFERENCES public.system_users(id),
  CONSTRAINT dashboard_access_revoked_by_fkey FOREIGN KEY (revoked_by) REFERENCES public.system_users(id)
);
CREATE TABLE public.dashboard_access_points (
  id bigint NOT NULL DEFAULT nextval('dashboard_access_points_id_seq'::regclass),
  system_user_id bigint NOT NULL,
  dashboard_type text NOT NULL,
  access_point_group text NOT NULL,
  access_point_name text NOT NULL,
  access_point_description text,
  allowed_actions jsonb NOT NULL DEFAULT '[]'::jsonb,
  context jsonb DEFAULT '{}'::jsonb,
  is_active boolean DEFAULT true,
  granted_by bigint NOT NULL,
  granted_by_name text,
  granted_at timestamp with time zone NOT NULL DEFAULT now(),
  revoked_at timestamp with time zone,
  revoked_by bigint,
  revoke_reason text,
  created_at timestamp with time zone NOT NULL DEFAULT now(),
  updated_at timestamp with time zone NOT NULL DEFAULT now(),
  order_type text,
  CONSTRAINT dashboard_access_points_pkey PRIMARY KEY (id),
  CONSTRAINT dashboard_access_points_system_user_id_fkey FOREIGN KEY (system_user_id) REFERENCES public.system_users(id),
  CONSTRAINT dashboard_access_points_granted_by_fkey FOREIGN KEY (granted_by) REFERENCES public.system_users(id),
  CONSTRAINT dashboard_access_points_revoked_by_fkey FOREIGN KEY (revoked_by) REFERENCES public.system_users(id)
);
CREATE TABLE public.duty_logs (
  id bigint NOT NULL DEFAULT nextval('duty_logs_id_seq'::regclass),
  rider_id integer NOT NULL,
  status USER-DEFINED NOT NULL,
  timestamp timestamp with time zone NOT NULL DEFAULT now(),
  service_types jsonb DEFAULT '[]'::jsonb,
  vehicle_id bigint,
  lat double precision,
  lon double precision,
  session_id text,
  device_id text,
  metadata jsonb DEFAULT '{}'::jsonb,
  CONSTRAINT duty_logs_pkey PRIMARY KEY (id),
  CONSTRAINT duty_logs_rider_id_fkey FOREIGN KEY (rider_id) REFERENCES public.riders(id),
  CONSTRAINT duty_logs_vehicle_id_fkey FOREIGN KEY (vehicle_id) REFERENCES public.rider_vehicles(id)
);
CREATE TABLE public.entity_scope_assignments (
  id bigint NOT NULL DEFAULT nextval('entity_scope_assignments_id_seq'::regclass),
  system_user_id bigint NOT NULL,
  entity_type text NOT NULL,
  entity_id bigint NOT NULL,
  access_level USER-DEFINED NOT NULL DEFAULT 'READ'::access_level,
  assignment_reason text,
  is_active boolean DEFAULT true,
  valid_from timestamp with time zone DEFAULT now(),
  valid_until timestamp with time zone,
  assigned_by bigint,
  assigned_at timestamp with time zone NOT NULL DEFAULT now(),
  created_at timestamp with time zone NOT NULL DEFAULT now(),
  CONSTRAINT entity_scope_assignments_pkey PRIMARY KEY (id),
  CONSTRAINT entity_scope_assignments_system_user_id_fkey FOREIGN KEY (system_user_id) REFERENCES public.system_users(id),
  CONSTRAINT entity_scope_assignments_assigned_by_fkey FOREIGN KEY (assigned_by) REFERENCES public.system_users(id)
);
CREATE TABLE public.fraud_logs (
  id bigint NOT NULL DEFAULT nextval('fraud_logs_id_seq'::regclass),
  rider_id integer,
  order_id bigint,
  fraud_type text NOT NULL,
  severity text NOT NULL DEFAULT 'medium'::text,
  description text NOT NULL,
  evidence jsonb DEFAULT '{}'::jsonb,
  action_taken text,
  resolved boolean NOT NULL DEFAULT false,
  resolved_at timestamp with time zone,
  resolved_by integer,
  metadata jsonb DEFAULT '{}'::jsonb,
  created_at timestamp with time zone NOT NULL DEFAULT now(),
  CONSTRAINT fraud_logs_pkey PRIMARY KEY (id),
  CONSTRAINT fraud_logs_rider_id_fkey FOREIGN KEY (rider_id) REFERENCES public.riders(id),
  CONSTRAINT fraud_logs_order_id_fkey FOREIGN KEY (order_id) REFERENCES public.orders(id)
);
CREATE TABLE public.gatimitra_registrations (
  rider_name character varying NOT NULL,
  phone character varying NOT NULL,
  email character varying NOT NULL,
  location character varying NOT NULL,
  message text,
  created_at timestamp with time zone NOT NULL DEFAULT now(),
  status character varying NOT NULL DEFAULT 'pending'::character varying,
  city character varying DEFAULT '255'::character varying,
  id integer NOT NULL DEFAULT nextval('gatimitra_registrations_temp_id_seq'::regclass),
  CONSTRAINT gatimitra_registrations_pkey PRIMARY KEY (id)
);
CREATE TABLE public.gatimitra_reviews (
  name character varying NOT NULL,
  email character varying NOT NULL,
  stars integer NOT NULL CHECK (stars >= 1 AND stars <= 5),
  review character varying NOT NULL,
  created_at timestamp with time zone NOT NULL DEFAULT now(),
  response_by character varying,
  response_message character varying,
  is_read boolean DEFAULT false,
  id integer NOT NULL DEFAULT nextval('gatimitra_reviews_temp_id_seq1'::regclass),
  CONSTRAINT gatimitra_reviews_pkey PRIMARY KEY (id)
);
CREATE TABLE public.insurance_policies (
  id bigint NOT NULL DEFAULT nextval('insurance_policies_id_seq'::regclass),
  rider_id integer NOT NULL,
  vehicle_id bigint,
  policy_number text NOT NULL,
  provider text NOT NULL,
  coverage_amount numeric,
  premium_amount numeric,
  start_date date NOT NULL,
  end_date date NOT NULL,
  document_url text,
  status text NOT NULL DEFAULT 'active'::text,
  renewal_reminder_sent boolean DEFAULT false,
  created_at timestamp with time zone NOT NULL DEFAULT now(),
  updated_at timestamp with time zone NOT NULL DEFAULT now(),
  CONSTRAINT insurance_policies_pkey PRIMARY KEY (id),
  CONSTRAINT insurance_policies_rider_id_fkey FOREIGN KEY (rider_id) REFERENCES public.riders(id),
  CONSTRAINT insurance_policies_vehicle_id_fkey FOREIGN KEY (vehicle_id) REFERENCES public.rider_vehicles(id)
);
CREATE TABLE public.job_applications (
  id bigint NOT NULL DEFAULT nextval('job_applications_id_seq'::regclass),
  job_id bigint NOT NULL,
  full_name text NOT NULL,
  email text NOT NULL,
  phone text NOT NULL,
  city text,
  state text,
  experience_years text,
  current_company text,
  expected_salary text,
  notice_period text,
  portfolio_url text,
  linkedin_url text,
  github_url text,
  resume_url text,
  cover_letter text,
  application_status text DEFAULT 'Applied'::text,
  admin_notes text,
  applied_at timestamp without time zone DEFAULT now(),
  updated_at timestamp without time zone DEFAULT now(),
  CONSTRAINT job_applications_pkey PRIMARY KEY (id),
  CONSTRAINT job_applications_job_id_fkey FOREIGN KEY (job_id) REFERENCES public.job_listings(id)
);
CREATE TABLE public.job_listings (
  id bigint NOT NULL DEFAULT nextval('job_listings_id_seq'::regclass),
  role text NOT NULL,
  location text,
  experience text,
  salary text,
  category text,
  description text,
  requirements text,
  responsibilities text,
  status text DEFAULT 'Open'::text,
  close_reason text,
  closed_at timestamp without time zone,
  created_at timestamp without time zone DEFAULT now(),
  updated_at timestamp without time zone DEFAULT now(),
  CONSTRAINT job_listings_pkey PRIMARY KEY (id)
);
CREATE TABLE public.location_logs (
  id bigint NOT NULL DEFAULT nextval('location_logs_id_seq'::regclass),
  rider_id integer NOT NULL,
  lat double precision NOT NULL,
  lon double precision NOT NULL,
  battery_percent integer,
  accuracy double precision,
  speed double precision,
  heading double precision,
  created_at timestamp with time zone NOT NULL DEFAULT now(),
  CONSTRAINT location_logs_pkey PRIMARY KEY (id, created_at),
  CONSTRAINT location_logs_rider_id_fkey FOREIGN KEY (rider_id) REFERENCES public.riders(id)
);
CREATE TABLE public.location_logs_y2025m01 (
  id bigint NOT NULL DEFAULT nextval('location_logs_id_seq'::regclass),
  rider_id integer NOT NULL,
  lat double precision NOT NULL,
  lon double precision NOT NULL,
  battery_percent integer,
  accuracy double precision,
  speed double precision,
  heading double precision,
  created_at timestamp with time zone NOT NULL DEFAULT now(),
  CONSTRAINT location_logs_y2025m01_pkey PRIMARY KEY (id, created_at),
  CONSTRAINT location_logs_rider_id_fkey FOREIGN KEY (rider_id) REFERENCES public.riders(id)
);
CREATE TABLE public.merchant_area_managers (
  id bigint NOT NULL DEFAULT nextval('merchant_area_managers_id_seq'::regclass),
  manager_id text NOT NULL UNIQUE,
  name text NOT NULL,
  email text NOT NULL UNIQUE,
  mobile text NOT NULL UNIQUE,
  alternate_mobile text,
  region text NOT NULL,
  cities ARRAY,
  postal_codes ARRAY,
  status text DEFAULT 'ACTIVE'::text,
  user_id integer,
  created_at timestamp with time zone NOT NULL DEFAULT now(),
  updated_at timestamp with time zone NOT NULL DEFAULT now(),
  CONSTRAINT merchant_area_managers_pkey PRIMARY KEY (id)
);
CREATE TABLE public.merchant_audit_logs (
  id bigint NOT NULL DEFAULT nextval('merchant_audit_logs_id_seq'::regclass),
  entity_type text NOT NULL,
  entity_id bigint NOT NULL,
  action text NOT NULL,
  action_field text,
  old_value jsonb,
  new_value jsonb,
  performed_by text NOT NULL,
  performed_by_id integer,
  performed_by_name text,
  performed_by_email text,
  ip_address text,
  user_agent text,
  audit_metadata jsonb DEFAULT '{}'::jsonb,
  created_at timestamp with time zone NOT NULL DEFAULT now(),
  CONSTRAINT merchant_audit_logs_pkey PRIMARY KEY (id)
);
CREATE TABLE public.merchant_coupons (
  id bigint NOT NULL DEFAULT nextval('merchant_coupons_id_seq'::regclass),
  coupon_id text NOT NULL UNIQUE,
  store_id bigint,
  parent_id bigint,
  coupon_code text NOT NULL UNIQUE,
  coupon_description text,
  coupon_type text NOT NULL,
  discount_value numeric,
  discount_percentage numeric,
  max_discount_amount numeric,
  min_order_amount numeric,
  applicable_service_types ARRAY,
  max_uses_total integer,
  max_uses_per_user integer,
  current_uses integer DEFAULT 0,
  valid_from timestamp with time zone NOT NULL,
  valid_till timestamp with time zone NOT NULL,
  is_active boolean DEFAULT true,
  coupon_metadata jsonb DEFAULT '{}'::jsonb,
  created_at timestamp with time zone NOT NULL DEFAULT now(),
  updated_at timestamp with time zone NOT NULL DEFAULT now(),
  parent_merchant_id text,
  CONSTRAINT merchant_coupons_pkey PRIMARY KEY (id),
  CONSTRAINT merchant_coupons_parent_id_fkey FOREIGN KEY (parent_id) REFERENCES public.merchant_parents(id)
);
CREATE TABLE public.merchant_management_access (
  id bigint NOT NULL DEFAULT nextval('merchant_management_access_id_seq'::regclass),
  system_user_id bigint NOT NULL UNIQUE,
  can_view_all_merchants boolean DEFAULT false,
  can_view_assigned_merchants boolean DEFAULT true,
  can_view_financial boolean DEFAULT false,
  can_view_documents boolean DEFAULT false,
  can_update_onboarding boolean DEFAULT false,
  can_approve_documents boolean DEFAULT false,
  can_reject_documents boolean DEFAULT false,
  can_approve_store boolean DEFAULT false,
  can_reject_store boolean DEFAULT false,
  can_update_store_details boolean DEFAULT false,
  can_update_store_timing boolean DEFAULT false,
  can_update_store_availability boolean DEFAULT false,
  can_delist_store boolean DEFAULT false,
  can_relist_store boolean DEFAULT false,
  can_block_store boolean DEFAULT false,
  can_unblock_store boolean DEFAULT false,
  can_view_menu boolean DEFAULT true,
  can_update_menu boolean DEFAULT false,
  can_update_pricing boolean DEFAULT false,
  can_update_customizations boolean DEFAULT false,
  can_update_offers boolean DEFAULT false,
  can_update_bank_details boolean DEFAULT false,
  can_approve_payout boolean DEFAULT false,
  can_adjust_commission boolean DEFAULT false,
  can_manage_store_orders boolean DEFAULT false,
  payout_approval_limit numeric DEFAULT 0,
  created_at timestamp with time zone NOT NULL DEFAULT now(),
  updated_at timestamp with time zone NOT NULL DEFAULT now(),
  CONSTRAINT merchant_management_access_pkey PRIMARY KEY (id),
  CONSTRAINT merchant_management_access_system_user_id_fkey FOREIGN KEY (system_user_id) REFERENCES public.system_users(id)
);
CREATE TABLE public.merchant_menu_categories (
  id bigint NOT NULL DEFAULT nextval('merchant_menu_categories_id_seq'::regclass),
  store_id bigint NOT NULL,
  category_name text NOT NULL,
  category_description text,
  category_image_url text,
  display_order integer DEFAULT 0,
  is_active boolean DEFAULT true,
  category_metadata jsonb DEFAULT '{}'::jsonb,
  created_at timestamp with time zone NOT NULL DEFAULT now(),
  updated_at timestamp with time zone NOT NULL DEFAULT now(),
  CONSTRAINT merchant_menu_categories_pkey PRIMARY KEY (id)
);
CREATE TABLE public.merchant_menu_item_addons (
  id bigint NOT NULL DEFAULT nextval('merchant_menu_item_addons_id_seq'::regclass),
  addon_id text NOT NULL UNIQUE,
  customization_id bigint NOT NULL,
  addon_name text NOT NULL,
  addon_price numeric DEFAULT 0,
  addon_image_url text,
  in_stock boolean DEFAULT true,
  display_order integer DEFAULT 0,
  created_at timestamp with time zone NOT NULL DEFAULT now(),
  updated_at timestamp with time zone NOT NULL DEFAULT now(),
  CONSTRAINT merchant_menu_item_addons_pkey PRIMARY KEY (id),
  CONSTRAINT merchant_menu_item_addons_customization_id_fkey FOREIGN KEY (customization_id) REFERENCES public.merchant_menu_item_customizations(id)
);
CREATE TABLE public.merchant_menu_item_customizations (
  id bigint NOT NULL DEFAULT nextval('merchant_menu_item_customizations_id_seq'::regclass),
  customization_id text NOT NULL UNIQUE,
  menu_item_id bigint NOT NULL,
  customization_title text NOT NULL,
  customization_type text,
  is_required boolean DEFAULT false,
  min_selection integer DEFAULT 0,
  max_selection integer DEFAULT 1,
  display_order integer DEFAULT 0,
  created_at timestamp with time zone NOT NULL DEFAULT now(),
  updated_at timestamp with time zone NOT NULL DEFAULT now(),
  CONSTRAINT merchant_menu_item_customizations_pkey PRIMARY KEY (id),
  CONSTRAINT merchant_menu_item_customizations_menu_item_id_fkey FOREIGN KEY (menu_item_id) REFERENCES public.merchant_menu_items(id)
);
CREATE TABLE public.merchant_menu_item_variants (
  id bigint NOT NULL DEFAULT nextval('merchant_menu_item_variants_id_seq'::regclass),
  variant_id text NOT NULL UNIQUE,
  menu_item_id bigint NOT NULL,
  variant_name text NOT NULL,
  variant_type text,
  variant_price numeric NOT NULL,
  price_difference numeric DEFAULT 0,
  in_stock boolean DEFAULT true,
  available_quantity integer,
  sku text,
  barcode text,
  display_order integer DEFAULT 0,
  is_default boolean DEFAULT false,
  created_at timestamp with time zone NOT NULL DEFAULT now(),
  updated_at timestamp with time zone NOT NULL DEFAULT now(),
  CONSTRAINT merchant_menu_item_variants_pkey PRIMARY KEY (id),
  CONSTRAINT merchant_menu_item_variants_menu_item_id_fkey FOREIGN KEY (menu_item_id) REFERENCES public.merchant_menu_items(id)
);
CREATE TABLE public.merchant_menu_items (
  id bigint NOT NULL DEFAULT nextval('merchant_menu_items_id_seq'::regclass),
  store_id bigint NOT NULL,
  category_id bigint,
  item_id text NOT NULL UNIQUE,
  item_name text NOT NULL,
  item_description text,
  item_image_url text,
  food_type text,
  spice_level text,
  cuisine_type text,
  base_price numeric NOT NULL CHECK (base_price > 0::numeric),
  selling_price numeric NOT NULL CHECK (selling_price > 0::numeric),
  discount_percentage numeric DEFAULT 0,
  tax_percentage numeric DEFAULT 0,
  in_stock boolean DEFAULT true,
  available_quantity integer,
  low_stock_threshold integer,
  has_customizations boolean DEFAULT false,
  has_addons boolean DEFAULT false,
  has_variants boolean DEFAULT false,
  is_popular boolean DEFAULT false,
  is_recommended boolean DEFAULT false,
  preparation_time_minutes integer DEFAULT 15,
  serves integer DEFAULT 1,
  display_order integer DEFAULT 0,
  is_active boolean DEFAULT true,
  item_metadata jsonb DEFAULT '{}'::jsonb,
  nutritional_info jsonb DEFAULT '{}'::jsonb,
  allergens ARRAY,
  created_at timestamp with time zone NOT NULL DEFAULT now(),
  updated_at timestamp with time zone NOT NULL DEFAULT now(),
  CONSTRAINT merchant_menu_items_pkey PRIMARY KEY (id),
  CONSTRAINT merchant_menu_items_category_id_fkey FOREIGN KEY (category_id) REFERENCES public.merchant_menu_categories(id)
);
CREATE TABLE public.merchant_offer_applicability (
  id bigint NOT NULL DEFAULT nextval('merchant_offer_applicability_id_seq'::regclass),
  offer_id bigint NOT NULL,
  menu_item_id bigint,
  category_id bigint,
  applicability_type text NOT NULL,
  created_at timestamp with time zone NOT NULL DEFAULT now(),
  CONSTRAINT merchant_offer_applicability_pkey PRIMARY KEY (id),
  CONSTRAINT merchant_offer_applicability_offer_id_fkey FOREIGN KEY (offer_id) REFERENCES public.merchant_offers(id),
  CONSTRAINT merchant_offer_applicability_menu_item_id_fkey FOREIGN KEY (menu_item_id) REFERENCES public.merchant_menu_items(id),
  CONSTRAINT merchant_offer_applicability_category_id_fkey FOREIGN KEY (category_id) REFERENCES public.merchant_menu_categories(id)
);
CREATE TABLE public.merchant_offers (
  id bigint NOT NULL DEFAULT nextval('merchant_offers_id_seq'::regclass),
  offer_id text NOT NULL UNIQUE,
  store_id bigint NOT NULL,
  offer_title text NOT NULL,
  offer_description text,
  offer_image_url text,
  offer_terms text,
  offer_type text NOT NULL,
  offer_sub_type text,
  discount_value numeric,
  discount_percentage numeric,
  max_discount_amount numeric,
  min_order_amount numeric,
  max_order_amount numeric,
  min_items integer,
  applicable_on_days ARRAY,
  applicable_time_start time without time zone,
  applicable_time_end time without time zone,
  buy_quantity integer,
  get_quantity integer,
  max_uses_total integer,
  max_uses_per_user integer,
  current_uses integer DEFAULT 0,
  valid_from timestamp with time zone NOT NULL,
  valid_till timestamp with time zone NOT NULL,
  is_active boolean DEFAULT true,
  is_featured boolean DEFAULT false,
  display_priority integer DEFAULT 0,
  offer_metadata jsonb DEFAULT '{}'::jsonb,
  created_at timestamp with time zone NOT NULL DEFAULT now(),
  updated_at timestamp with time zone NOT NULL DEFAULT now(),
  created_by integer,
  CONSTRAINT merchant_offers_pkey PRIMARY KEY (id)
);
CREATE TABLE public.merchant_parents (
  id bigint NOT NULL DEFAULT nextval('merchant_parents_id_seq'::regclass),
  parent_merchant_id text NOT NULL UNIQUE,
  parent_name text NOT NULL,
  merchant_type USER-DEFINED NOT NULL DEFAULT 'LOCAL'::merchant_type,
  owner_name text NOT NULL,
  owner_email text,
  registered_phone text NOT NULL UNIQUE CHECK (registered_phone ~ '^\+?[0-9]{10,15}$'::text),
  registered_phone_normalized text,
  alternate_phone text,
  brand_name text,
  business_category text,
  is_active boolean DEFAULT true,
  created_at timestamp with time zone NOT NULL DEFAULT now(),
  updated_at timestamp with time zone NOT NULL DEFAULT now(),
  registration_status text NOT NULL DEFAULT 'VERIFIED'::text CHECK (registration_status = ANY (ARRAY['VERIFIED'::text, 'SUSPENDED'::text])),
  address_line1 text,
  city text,
  state text,
  pincode text,
  approval_status USER-DEFINED NOT NULL DEFAULT 'APPROVED'::parent_approval_status,
  area_manager_id bigint,
  created_by_name text,
  store_logo text,
  supabase_user_id uuid,
  CONSTRAINT merchant_parents_pkey PRIMARY KEY (id),
  CONSTRAINT fk_merchant_parents_area_manager FOREIGN KEY (area_manager_id) REFERENCES public.area_managers(id)
);
CREATE TABLE public.merchant_store_activity_log (
  id bigint NOT NULL DEFAULT nextval('merchant_store_activity_log_id_seq'::regclass),
  store_id bigint NOT NULL,
  activity_type USER-DEFINED NOT NULL,
  activity_reason text NOT NULL,
  activity_reason_code text,
  activity_notes text,
  relist_on timestamp with time zone,
  auto_relist boolean DEFAULT false,
  actioned_by text NOT NULL,
  actioned_by_id integer,
  actioned_by_name text,
  actioned_by_email text,
  reversed boolean DEFAULT false,
  reversed_at timestamp with time zone,
  reversed_by integer,
  reversal_notes text,
  created_at timestamp with time zone NOT NULL DEFAULT now(),
  CONSTRAINT merchant_store_activity_log_pkey PRIMARY KEY (id)
);
CREATE TABLE public.merchant_store_availability (
  id bigint NOT NULL DEFAULT nextval('merchant_store_availability_id_seq'::regclass),
  store_id bigint NOT NULL UNIQUE,
  is_available boolean DEFAULT true,
  is_accepting_orders boolean DEFAULT true,
  unavailable_reason text,
  auto_unavailable_at timestamp with time zone,
  auto_available_at timestamp with time zone,
  current_pending_orders integer DEFAULT 0,
  max_concurrent_orders integer DEFAULT 20,
  updated_by text,
  updated_by_id integer,
  created_at timestamp with time zone NOT NULL DEFAULT now(),
  updated_at timestamp with time zone NOT NULL DEFAULT now(),
  CONSTRAINT merchant_store_availability_pkey PRIMARY KEY (id)
);
CREATE TABLE public.merchant_store_bank_accounts (
  id bigint NOT NULL DEFAULT nextval('merchant_store_bank_accounts_id_seq'::regclass),
  store_id bigint NOT NULL,
  account_holder_name text NOT NULL,
  account_number text NOT NULL,
  account_number_encrypted text,
  ifsc_code text NOT NULL,
  bank_name text NOT NULL,
  branch_name text,
  account_type text,
  is_verified boolean DEFAULT false,
  verified_by integer,
  verified_at timestamp with time zone,
  verification_method text,
  upi_id text,
  upi_verified boolean DEFAULT false,
  is_primary boolean DEFAULT false,
  is_active boolean DEFAULT true,
  bank_metadata jsonb DEFAULT '{}'::jsonb,
  created_at timestamp with time zone NOT NULL DEFAULT now(),
  updated_at timestamp with time zone NOT NULL DEFAULT now(),
  CONSTRAINT merchant_store_bank_accounts_pkey PRIMARY KEY (id)
);
CREATE TABLE public.merchant_store_blocks (
  id bigint NOT NULL DEFAULT nextval('merchant_store_blocks_id_seq'::regclass),
  store_id bigint NOT NULL,
  block_type text NOT NULL,
  block_reason text NOT NULL,
  block_reason_code text,
  block_notes text,
  blocked_at timestamp with time zone NOT NULL DEFAULT now(),
  blocked_until timestamp with time zone,
  auto_unblock boolean DEFAULT false,
  blocked_by text NOT NULL,
  blocked_by_id integer,
  blocked_by_name text,
  is_unblocked boolean DEFAULT false,
  unblocked_at timestamp with time zone,
  unblocked_by integer,
  unblock_reason text,
  blocked_services ARRAY,
  created_at timestamp with time zone NOT NULL DEFAULT now(),
  updated_at timestamp with time zone NOT NULL DEFAULT now(),
  CONSTRAINT merchant_store_blocks_pkey PRIMARY KEY (id)
);
CREATE TABLE public.merchant_store_commission_rules (
  id bigint NOT NULL DEFAULT nextval('merchant_store_commission_rules_id_seq'::regclass),
  store_id bigint,
  parent_id bigint,
  service_type USER-DEFINED NOT NULL,
  commission_type text NOT NULL,
  commission_value numeric NOT NULL,
  min_order_value numeric,
  max_order_value numeric,
  applicable_cities ARRAY,
  effective_from timestamp with time zone NOT NULL,
  effective_to timestamp with time zone,
  is_active boolean DEFAULT true,
  created_at timestamp with time zone NOT NULL DEFAULT now(),
  created_by integer,
  parent_merchant_id text,
  CONSTRAINT merchant_store_commission_rules_pkey PRIMARY KEY (id),
  CONSTRAINT merchant_store_commission_rules_parent_id_fkey FOREIGN KEY (parent_id) REFERENCES public.merchant_parents(id)
);
CREATE TABLE public.merchant_store_compliance (
  id bigint NOT NULL DEFAULT nextval('merchant_store_compliance_id_seq'::regclass),
  store_id bigint NOT NULL,
  compliance_type text NOT NULL,
  compliance_status USER-DEFINED NOT NULL DEFAULT 'PENDING'::verification_status,
  compliance_number text,
  compliance_document_url text,
  issued_date date,
  expiry_date date,
  is_expired boolean DEFAULT false,
  renewal_required boolean DEFAULT false,
  renewal_due_date date,
  verified_by integer,
  verified_at timestamp with time zone,
  verification_notes text,
  compliance_metadata jsonb DEFAULT '{}'::jsonb,
  created_at timestamp with time zone NOT NULL DEFAULT now(),
  updated_at timestamp with time zone NOT NULL DEFAULT now(),
  CONSTRAINT merchant_store_compliance_pkey PRIMARY KEY (id)
);
CREATE TABLE public.merchant_store_daily_analytics (
  id bigint NOT NULL DEFAULT nextval('merchant_store_daily_analytics_id_seq'::regclass),
  store_id bigint NOT NULL,
  analytics_date date NOT NULL,
  total_orders integer DEFAULT 0,
  completed_orders integer DEFAULT 0,
  cancelled_orders integer DEFAULT 0,
  gross_revenue numeric DEFAULT 0,
  net_revenue numeric DEFAULT 0,
  total_commission numeric DEFAULT 0,
  total_tax numeric DEFAULT 0,
  total_discounts numeric DEFAULT 0,
  avg_preparation_time_minutes integer,
  avg_delivery_time_minutes integer,
  avg_rating numeric,
  food_orders integer DEFAULT 0,
  parcel_orders integer DEFAULT 0,
  ride_orders integer DEFAULT 0,
  analytics_metadata jsonb DEFAULT '{}'::jsonb,
  created_at timestamp with time zone NOT NULL DEFAULT now(),
  updated_at timestamp with time zone NOT NULL DEFAULT now(),
  CONSTRAINT merchant_store_daily_analytics_pkey PRIMARY KEY (id)
);
CREATE TABLE public.merchant_store_documents (
  id bigint NOT NULL DEFAULT nextval('merchant_store_documents_new_id_seq'::regclass),
  store_id bigint NOT NULL UNIQUE,
  pan_document_number text,
  pan_document_url text,
  pan_document_name text,
  pan_is_verified boolean DEFAULT false,
  pan_verified_by integer,
  pan_verified_at timestamp with time zone,
  pan_rejection_reason text,
  pan_issued_date date,
  pan_expiry_date date,
  pan_is_expired boolean DEFAULT false,
  pan_document_version integer DEFAULT 1,
  pan_document_metadata jsonb DEFAULT '{}'::jsonb,
  pan_uploaded_by integer,
  pan_created_at timestamp with time zone,
  pan_updated_at timestamp with time zone,
  gst_document_number text,
  gst_document_url text,
  gst_document_name text,
  gst_is_verified boolean DEFAULT false,
  gst_verified_by integer,
  gst_verified_at timestamp with time zone,
  gst_rejection_reason text,
  gst_issued_date date,
  gst_expiry_date date,
  gst_is_expired boolean DEFAULT false,
  gst_document_version integer DEFAULT 1,
  gst_document_metadata jsonb DEFAULT '{}'::jsonb,
  gst_uploaded_by integer,
  gst_created_at timestamp with time zone,
  gst_updated_at timestamp with time zone,
  aadhaar_document_number text,
  aadhaar_document_url text,
  aadhaar_document_name text,
  aadhaar_is_verified boolean DEFAULT false,
  aadhaar_verified_by integer,
  aadhaar_verified_at timestamp with time zone,
  aadhaar_rejection_reason text,
  aadhaar_issued_date date,
  aadhaar_expiry_date date,
  aadhaar_is_expired boolean DEFAULT false,
  aadhaar_document_version integer DEFAULT 1,
  aadhaar_document_metadata jsonb DEFAULT '{}'::jsonb,
  aadhaar_uploaded_by integer,
  aadhaar_created_at timestamp with time zone,
  aadhaar_updated_at timestamp with time zone,
  fssai_document_number text,
  fssai_document_url text,
  fssai_document_name text,
  fssai_is_verified boolean DEFAULT false,
  fssai_verified_by integer,
  fssai_verified_at timestamp with time zone,
  fssai_rejection_reason text,
  fssai_issued_date date,
  fssai_expiry_date date,
  fssai_is_expired boolean DEFAULT false,
  fssai_document_version integer DEFAULT 1,
  fssai_document_metadata jsonb DEFAULT '{}'::jsonb,
  fssai_uploaded_by integer,
  fssai_created_at timestamp with time zone,
  fssai_updated_at timestamp with time zone,
  trade_license_document_number text,
  trade_license_document_url text,
  trade_license_document_name text,
  trade_license_is_verified boolean DEFAULT false,
  trade_license_verified_by integer,
  trade_license_verified_at timestamp with time zone,
  trade_license_rejection_reason text,
  trade_license_issued_date date,
  trade_license_expiry_date date,
  trade_license_is_expired boolean DEFAULT false,
  trade_license_document_version integer DEFAULT 1,
  trade_license_document_metadata jsonb DEFAULT '{}'::jsonb,
  trade_license_uploaded_by integer,
  trade_license_created_at timestamp with time zone,
  trade_license_updated_at timestamp with time zone,
  drug_license_document_number text,
  drug_license_document_url text,
  drug_license_document_name text,
  drug_license_type text,
  drug_license_is_verified boolean DEFAULT false,
  drug_license_verified_by integer,
  drug_license_verified_at timestamp with time zone,
  drug_license_rejection_reason text,
  drug_license_issued_date date,
  drug_license_expiry_date date,
  drug_license_is_expired boolean DEFAULT false,
  drug_license_document_version integer DEFAULT 1,
  drug_license_document_metadata jsonb DEFAULT '{}'::jsonb,
  drug_license_uploaded_by integer,
  drug_license_created_at timestamp with time zone,
  drug_license_updated_at timestamp with time zone,
  shop_establishment_document_number text,
  shop_establishment_document_url text,
  shop_establishment_document_name text,
  shop_establishment_is_verified boolean DEFAULT false,
  shop_establishment_verified_by integer,
  shop_establishment_verified_at timestamp with time zone,
  shop_establishment_rejection_reason text,
  shop_establishment_issued_date date,
  shop_establishment_expiry_date date,
  shop_establishment_is_expired boolean DEFAULT false,
  shop_establishment_document_version integer DEFAULT 1,
  shop_establishment_document_metadata jsonb DEFAULT '{}'::jsonb,
  shop_establishment_uploaded_by integer,
  shop_establishment_created_at timestamp with time zone,
  shop_establishment_updated_at timestamp with time zone,
  udyam_document_number text,
  udyam_document_url text,
  udyam_document_name text,
  udyam_is_verified boolean DEFAULT false,
  udyam_verified_by integer,
  udyam_verified_at timestamp with time zone,
  udyam_rejection_reason text,
  udyam_issued_date date,
  udyam_expiry_date date,
  udyam_is_expired boolean DEFAULT false,
  udyam_document_version integer DEFAULT 1,
  udyam_document_metadata jsonb DEFAULT '{}'::jsonb,
  udyam_uploaded_by integer,
  udyam_created_at timestamp with time zone,
  udyam_updated_at timestamp with time zone,
  pharmacist_certificate_document_number text,
  pharmacist_certificate_document_url text,
  pharmacist_certificate_document_name text,
  pharmacist_certificate_is_verified boolean DEFAULT false,
  pharmacist_certificate_verified_by integer,
  pharmacist_certificate_verified_at timestamp with time zone,
  pharmacist_certificate_rejection_reason text,
  pharmacist_certificate_issued_date date,
  pharmacist_certificate_expiry_date date,
  pharmacist_certificate_is_expired boolean DEFAULT false,
  pharmacist_certificate_document_version integer DEFAULT 1,
  pharmacist_certificate_document_metadata jsonb DEFAULT '{}'::jsonb,
  pharmacist_certificate_uploaded_by integer,
  pharmacist_certificate_created_at timestamp with time zone,
  pharmacist_certificate_updated_at timestamp with time zone,
  pharmacy_council_registration_document_number text,
  pharmacy_council_registration_document_url text,
  pharmacy_council_registration_document_name text,
  pharmacy_council_registration_type text,
  pharmacy_council_registration_is_verified boolean DEFAULT false,
  pharmacy_council_registration_verified_by integer,
  pharmacy_council_registration_verified_at timestamp with time zone,
  pharmacy_council_registration_rejection_reason text,
  pharmacy_council_registration_issued_date date,
  pharmacy_council_registration_expiry_date date,
  pharmacy_council_registration_is_expired boolean DEFAULT false,
  pharmacy_council_registration_document_version integer DEFAULT 1,
  pharmacy_council_registration_document_metadata jsonb DEFAULT '{}'::jsonb,
  pharmacy_council_registration_uploaded_by integer,
  pharmacy_council_registration_created_at timestamp with time zone,
  pharmacy_council_registration_updated_at timestamp with time zone,
  bank_proof_document_number text,
  bank_proof_document_url text,
  bank_proof_document_name text,
  bank_proof_is_verified boolean DEFAULT false,
  bank_proof_verified_by integer,
  bank_proof_verified_at timestamp with time zone,
  bank_proof_rejection_reason text,
  bank_proof_issued_date date,
  bank_proof_expiry_date date,
  bank_proof_is_expired boolean DEFAULT false,
  bank_proof_document_version integer DEFAULT 1,
  bank_proof_document_metadata jsonb DEFAULT '{}'::jsonb,
  bank_proof_uploaded_by integer,
  bank_proof_created_at timestamp with time zone,
  bank_proof_updated_at timestamp with time zone,
  other_document_number text,
  other_document_url text,
  other_document_name text,
  other_document_type text,
  other_is_verified boolean DEFAULT false,
  other_verified_by integer,
  other_verified_at timestamp with time zone,
  other_rejection_reason text,
  other_issued_date date,
  other_expiry_date date,
  other_is_expired boolean DEFAULT false,
  other_document_version integer DEFAULT 1,
  other_document_metadata jsonb DEFAULT '{}'::jsonb,
  other_uploaded_by integer,
  other_created_at timestamp with time zone,
  other_updated_at timestamp with time zone,
  created_at timestamp with time zone NOT NULL DEFAULT now(),
  updated_at timestamp with time zone NOT NULL DEFAULT now(),
  CONSTRAINT merchant_store_documents_pkey PRIMARY KEY (id),
  CONSTRAINT merchant_store_documents_new_store_id_fkey FOREIGN KEY (store_id) REFERENCES public.merchant_stores(id)
);
CREATE TABLE public.merchant_store_holidays (
  id bigint NOT NULL DEFAULT nextval('merchant_store_holidays_id_seq'::regclass),
  store_id bigint NOT NULL,
  holiday_name text NOT NULL,
  holiday_type text,
  holiday_date date NOT NULL,
  is_full_day boolean DEFAULT true,
  closed_from time without time zone,
  closed_till time without time zone,
  closure_reason text,
  created_at timestamp with time zone NOT NULL DEFAULT now(),
  created_by integer,
  CONSTRAINT merchant_store_holidays_pkey PRIMARY KEY (id)
);
CREATE TABLE public.merchant_store_manager_assignments (
  id bigint NOT NULL DEFAULT nextval('merchant_store_manager_assignments_id_seq'::regclass),
  store_id bigint NOT NULL,
  manager_id bigint NOT NULL,
  assigned_at timestamp with time zone NOT NULL DEFAULT now(),
  assigned_by integer,
  is_active boolean DEFAULT true,
  unassigned_at timestamp with time zone,
  unassigned_by integer,
  unassignment_reason text,
  created_at timestamp with time zone NOT NULL DEFAULT now(),
  updated_at timestamp with time zone NOT NULL DEFAULT now(),
  CONSTRAINT merchant_store_manager_assignments_pkey PRIMARY KEY (id),
  CONSTRAINT merchant_store_manager_assignments_manager_id_fkey FOREIGN KEY (manager_id) REFERENCES public.merchant_area_managers(id)
);
CREATE TABLE public.merchant_store_ondc_mapping (
  id bigint NOT NULL DEFAULT nextval('merchant_store_ondc_mapping_id_seq'::regclass),
  store_id bigint NOT NULL UNIQUE,
  ondc_store_id text NOT NULL UNIQUE,
  ondc_provider_id text,
  ondc_location_id text,
  ondc_registered_name text,
  ondc_category text,
  ondc_subcategory text,
  ondc_status text DEFAULT 'PENDING'::text,
  ondc_registered_at timestamp with time zone,
  last_synced_at timestamp with time zone,
  sync_status text DEFAULT 'PENDING'::text,
  ondc_metadata jsonb DEFAULT '{}'::jsonb,
  created_at timestamp with time zone NOT NULL DEFAULT now(),
  updated_at timestamp with time zone NOT NULL DEFAULT now(),
  CONSTRAINT merchant_store_ondc_mapping_pkey PRIMARY KEY (id)
);
CREATE TABLE public.merchant_store_operating_hours (
  id bigint NOT NULL DEFAULT nextval('merchant_store_operating_hours_new_id_seq1'::regclass),
  store_id bigint NOT NULL UNIQUE,
  monday_open boolean NOT NULL DEFAULT false,
  monday_slot1_start time without time zone,
  monday_slot1_end time without time zone,
  monday_slot2_start time without time zone,
  monday_slot2_end time without time zone,
  monday_total_duration_minutes integer DEFAULT 0,
  tuesday_open boolean NOT NULL DEFAULT false,
  tuesday_slot1_start time without time zone,
  tuesday_slot1_end time without time zone,
  tuesday_slot2_start time without time zone,
  tuesday_slot2_end time without time zone,
  tuesday_total_duration_minutes integer DEFAULT 0,
  wednesday_open boolean NOT NULL DEFAULT false,
  wednesday_slot1_start time without time zone,
  wednesday_slot1_end time without time zone,
  wednesday_slot2_start time without time zone,
  wednesday_slot2_end time without time zone,
  wednesday_total_duration_minutes integer DEFAULT 0,
  thursday_open boolean NOT NULL DEFAULT false,
  thursday_slot1_start time without time zone,
  thursday_slot1_end time without time zone,
  thursday_slot2_start time without time zone,
  thursday_slot2_end time without time zone,
  thursday_total_duration_minutes integer DEFAULT 0,
  friday_open boolean NOT NULL DEFAULT false,
  friday_slot1_start time without time zone,
  friday_slot1_end time without time zone,
  friday_slot2_start time without time zone,
  friday_slot2_end time without time zone,
  friday_total_duration_minutes integer DEFAULT 0,
  saturday_open boolean NOT NULL DEFAULT false,
  saturday_slot1_start time without time zone,
  saturday_slot1_end time without time zone,
  saturday_slot2_start time without time zone,
  saturday_slot2_end time without time zone,
  saturday_total_duration_minutes integer DEFAULT 0,
  sunday_open boolean NOT NULL DEFAULT false,
  sunday_slot1_start time without time zone,
  sunday_slot1_end time without time zone,
  sunday_slot2_start time without time zone,
  sunday_slot2_end time without time zone,
  sunday_total_duration_minutes integer DEFAULT 0,
  is_24_hours boolean DEFAULT false,
  same_for_all_days boolean DEFAULT false,
  closed_days ARRAY,
  created_at timestamp with time zone NOT NULL DEFAULT now(),
  updated_at timestamp with time zone NOT NULL DEFAULT now(),
  updated_by_email text,
  updated_by_at timestamp with time zone DEFAULT now(),
  CONSTRAINT merchant_store_operating_hours_pkey PRIMARY KEY (id),
  CONSTRAINT merchant_store_operating_hours_new_store_id_fkey1 FOREIGN KEY (store_id) REFERENCES public.merchant_stores(id)
);
CREATE TABLE public.merchant_store_orders (
  id bigint NOT NULL DEFAULT nextval('merchant_store_orders_id_seq'::regclass),
  merchant_id bigint,
  store_id bigint NOT NULL,
  order_id bigint NOT NULL,
  order_type USER-DEFINED NOT NULL,
  service_type USER-DEFINED NOT NULL,
  order_value numeric DEFAULT 0,
  commission_amount numeric DEFAULT 0,
  tax_amount numeric DEFAULT 0,
  merchant_payout numeric DEFAULT 0,
  order_status USER-DEFINED,
  order_placed_at timestamp with time zone,
  order_completed_at timestamp with time zone,
  created_at timestamp with time zone NOT NULL DEFAULT now(),
  CONSTRAINT merchant_store_orders_pkey PRIMARY KEY (id),
  CONSTRAINT merchant_store_orders_merchant_id_fkey FOREIGN KEY (merchant_id) REFERENCES public.merchant_parents(id),
  CONSTRAINT merchant_store_orders_order_id_fkey FOREIGN KEY (order_id) REFERENCES public.orders(id)
);
CREATE TABLE public.merchant_store_payout_history (
  id bigint NOT NULL DEFAULT nextval('merchant_store_payout_history_id_seq'::regclass),
  payout_id bigint NOT NULL,
  from_status USER-DEFINED,
  to_status USER-DEFINED NOT NULL,
  changed_by text NOT NULL,
  changed_by_id integer,
  change_reason text,
  change_metadata jsonb DEFAULT '{}'::jsonb,
  created_at timestamp with time zone NOT NULL DEFAULT now(),
  CONSTRAINT merchant_store_payout_history_pkey PRIMARY KEY (id),
  CONSTRAINT merchant_store_payout_history_payout_id_fkey FOREIGN KEY (payout_id) REFERENCES public.merchant_store_payouts(id)
);
CREATE TABLE public.merchant_store_payouts (
  id bigint NOT NULL DEFAULT nextval('merchant_store_payouts_id_seq'::regclass),
  payout_id text NOT NULL UNIQUE,
  store_id bigint NOT NULL,
  parent_id bigint,
  bank_account_id bigint,
  payout_amount numeric NOT NULL CHECK (payout_amount > 0::numeric),
  processing_fee numeric DEFAULT 0,
  tds_deducted numeric DEFAULT 0,
  adjustment_amount numeric DEFAULT 0,
  net_payout_amount numeric NOT NULL CHECK (net_payout_amount >= 0::numeric),
  period_start_date date NOT NULL,
  period_end_date date NOT NULL,
  total_orders_count integer DEFAULT 0,
  completed_orders_count integer DEFAULT 0,
  bank_account_holder text,
  bank_account_number text,
  bank_ifsc_code text,
  bank_name text,
  upi_id text,
  transaction_id text,
  utr_number text,
  pg_transaction_id text,
  status USER-DEFINED NOT NULL DEFAULT 'PENDING'::payout_status,
  failure_reason text,
  requested_at timestamp with time zone NOT NULL DEFAULT now(),
  processed_at timestamp with time zone,
  completed_at timestamp with time zone,
  failed_at timestamp with time zone,
  requested_by integer,
  processed_by integer,
  payout_metadata jsonb DEFAULT '{}'::jsonb,
  created_at timestamp with time zone NOT NULL DEFAULT now(),
  updated_at timestamp with time zone NOT NULL DEFAULT now(),
  parent_merchant_id text,
  CONSTRAINT merchant_store_payouts_pkey PRIMARY KEY (id),
  CONSTRAINT merchant_store_payouts_parent_id_fkey FOREIGN KEY (parent_id) REFERENCES public.merchant_parents(id),
  CONSTRAINT merchant_store_payouts_bank_account_id_fkey FOREIGN KEY (bank_account_id) REFERENCES public.merchant_store_bank_accounts(id)
);
CREATE TABLE public.merchant_store_preparation_times (
  id bigint NOT NULL DEFAULT nextval('merchant_store_preparation_times_id_seq'::regclass),
  store_id bigint NOT NULL,
  config_type text NOT NULL,
  service_type USER-DEFINED,
  category_id bigint,
  menu_item_id bigint,
  preparation_time_minutes integer NOT NULL,
  applicable_time_start time without time zone,
  applicable_time_end time without time zone,
  applicable_days ARRAY,
  priority integer DEFAULT 0,
  created_at timestamp with time zone NOT NULL DEFAULT now(),
  updated_at timestamp with time zone NOT NULL DEFAULT now(),
  CONSTRAINT merchant_store_preparation_times_pkey PRIMARY KEY (id),
  CONSTRAINT merchant_store_preparation_times_category_id_fkey FOREIGN KEY (category_id) REFERENCES public.merchant_menu_categories(id),
  CONSTRAINT merchant_store_preparation_times_menu_item_id_fkey FOREIGN KEY (menu_item_id) REFERENCES public.merchant_menu_items(id)
);
CREATE TABLE public.merchant_store_provider_mapping (
  id bigint NOT NULL DEFAULT nextval('merchant_store_provider_mapping_id_seq'::regclass),
  store_id bigint NOT NULL,
  provider_type USER-DEFINED NOT NULL,
  provider_store_id text NOT NULL,
  provider_restaurant_id text,
  provider_merchant_id text,
  provider_store_name text,
  provider_status text,
  is_synced boolean DEFAULT false,
  last_synced_at timestamp with time zone,
  sync_status text DEFAULT 'PENDING'::text,
  provider_commission_percentage numeric,
  provider_metadata jsonb DEFAULT '{}'::jsonb,
  created_at timestamp with time zone NOT NULL DEFAULT now(),
  updated_at timestamp with time zone NOT NULL DEFAULT now(),
  CONSTRAINT merchant_store_provider_mapping_pkey PRIMARY KEY (id)
);
CREATE TABLE public.merchant_store_ratings (
  id bigint NOT NULL DEFAULT nextval('merchant_store_ratings_id_seq'::regclass),
  store_id bigint NOT NULL,
  order_id bigint,
  customer_id bigint,
  rating smallint NOT NULL CHECK (rating >= 1 AND rating <= 5),
  food_rating smallint CHECK (food_rating >= 1 AND food_rating <= 5),
  service_rating smallint CHECK (service_rating >= 1 AND service_rating <= 5),
  packaging_rating smallint CHECK (packaging_rating >= 1 AND packaging_rating <= 5),
  review_text text,
  review_title text,
  review_images ARRAY,
  helpful_count integer DEFAULT 0,
  not_helpful_count integer DEFAULT 0,
  merchant_response text,
  merchant_responded_at timestamp with time zone,
  is_verified boolean DEFAULT false,
  is_flagged boolean DEFAULT false,
  flag_reason text,
  created_at timestamp with time zone NOT NULL DEFAULT now(),
  updated_at timestamp with time zone NOT NULL DEFAULT now(),
  CONSTRAINT merchant_store_ratings_pkey PRIMARY KEY (id),
  CONSTRAINT merchant_store_ratings_order_id_fkey FOREIGN KEY (order_id) REFERENCES public.orders(id)
);
CREATE TABLE public.merchant_store_registration_progress (
  id bigint NOT NULL DEFAULT nextval('merchant_store_registration_progress_id_seq'::regclass),
  parent_id bigint NOT NULL,
  store_id bigint,
  current_step integer NOT NULL DEFAULT 1,
  total_steps integer DEFAULT 6,
  completed_steps integer DEFAULT 0,
  step_1_completed boolean DEFAULT false,
  step_2_completed boolean DEFAULT false,
  step_3_completed boolean DEFAULT false,
  step_4_completed boolean DEFAULT false,
  step_5_completed boolean DEFAULT false,
  step_6_completed boolean DEFAULT false,
  form_data jsonb DEFAULT '{}'::jsonb,
  registration_status text DEFAULT 'IN_PROGRESS'::text,
  completed_at timestamp with time zone,
  abandoned_at timestamp with time zone,
  abandonment_reason text,
  created_at timestamp with time zone NOT NULL DEFAULT now(),
  updated_at timestamp with time zone NOT NULL DEFAULT now(),
  CONSTRAINT merchant_store_registration_progress_pkey PRIMARY KEY (id),
  CONSTRAINT merchant_store_registration_progress_parent_id_fkey FOREIGN KEY (parent_id) REFERENCES public.merchant_parents(id)
);
CREATE TABLE public.merchant_store_services (
  id bigint NOT NULL DEFAULT nextval('merchant_store_services_id_seq'::regclass),
  store_id bigint NOT NULL,
  service_type USER-DEFINED NOT NULL,
  is_enabled boolean DEFAULT true,
  is_available boolean DEFAULT true,
  service_radius_km numeric,
  min_order_amount numeric,
  avg_service_time_minutes integer,
  service_config jsonb DEFAULT '{}'::jsonb,
  enabled_at timestamp with time zone,
  disabled_at timestamp with time zone,
  created_at timestamp with time zone NOT NULL DEFAULT now(),
  updated_at timestamp with time zone NOT NULL DEFAULT now(),
  CONSTRAINT merchant_store_services_pkey PRIMARY KEY (id)
);
CREATE TABLE public.merchant_store_settings (
  id bigint NOT NULL DEFAULT nextval('merchant_store_settings_id_seq'::regclass),
  store_id bigint NOT NULL UNIQUE,
  order_notification_enabled boolean DEFAULT true,
  order_notification_sound boolean DEFAULT true,
  auto_accept_orders boolean DEFAULT false,
  auto_accept_time_seconds integer DEFAULT 30,
  self_delivery boolean DEFAULT false,
  platform_delivery boolean DEFAULT true,
  delivery_charge_type text DEFAULT 'PLATFORM'::text,
  delivery_charge_amount numeric,
  max_concurrent_orders integer DEFAULT 20,
  max_preparation_time_minutes integer DEFAULT 60,
  cash_handling_enabled boolean DEFAULT true,
  online_payment_enabled boolean DEFAULT true,
  settings_metadata jsonb DEFAULT '{}'::jsonb,
  created_at timestamp with time zone NOT NULL DEFAULT now(),
  updated_at timestamp with time zone NOT NULL DEFAULT now(),
  CONSTRAINT merchant_store_settings_pkey PRIMARY KEY (id)
);
CREATE TABLE public.merchant_store_settlements (
  id bigint NOT NULL DEFAULT nextval('merchant_store_settlements_id_seq'::regclass),
  settlement_id text NOT NULL UNIQUE,
  store_id bigint NOT NULL,
  settlement_date date NOT NULL,
  period_start_date date NOT NULL,
  period_end_date date NOT NULL,
  total_orders integer DEFAULT 0,
  completed_orders integer DEFAULT 0,
  cancelled_orders integer DEFAULT 0,
  gross_order_value numeric DEFAULT 0,
  total_discounts numeric DEFAULT 0,
  total_tax numeric DEFAULT 0,
  total_commission numeric DEFAULT 0,
  total_refunds numeric DEFAULT 0,
  total_adjustments numeric DEFAULT 0,
  net_settlement_amount numeric DEFAULT 0,
  payout_id bigint,
  settlement_status text DEFAULT 'PENDING'::text,
  settlement_breakdown jsonb DEFAULT '{}'::jsonb,
  created_at timestamp with time zone NOT NULL DEFAULT now(),
  updated_at timestamp with time zone NOT NULL DEFAULT now(),
  CONSTRAINT merchant_store_settlements_pkey PRIMARY KEY (id),
  CONSTRAINT merchant_store_settlements_payout_id_fkey FOREIGN KEY (payout_id) REFERENCES public.merchant_store_payouts(id)
);
CREATE TABLE public.merchant_store_status_history (
  id bigint NOT NULL DEFAULT nextval('merchant_store_status_history_id_seq'::regclass),
  store_id bigint NOT NULL,
  from_status USER-DEFINED,
  to_status USER-DEFINED NOT NULL,
  change_reason text,
  change_notes text,
  changed_by text NOT NULL,
  changed_by_id integer,
  changed_by_name text,
  status_metadata jsonb DEFAULT '{}'::jsonb,
  created_at timestamp with time zone NOT NULL DEFAULT now(),
  from_approval_status USER-DEFINED,
  to_approval_status USER-DEFINED,
  from_operational_status USER-DEFINED,
  to_operational_status USER-DEFINED,
  CONSTRAINT merchant_store_status_history_pkey PRIMARY KEY (id)
);
CREATE TABLE public.merchant_store_tax_details (
  id bigint NOT NULL DEFAULT nextval('merchant_store_tax_details_id_seq'::regclass),
  store_id bigint NOT NULL UNIQUE,
  gst_number text,
  gst_registered boolean DEFAULT false,
  gst_certificate_url text,
  gstin_verification_status USER-DEFINED DEFAULT 'PENDING'::verification_status,
  pan_number text,
  pan_holder_name text,
  pan_card_url text,
  pan_verification_status USER-DEFINED DEFAULT 'PENDING'::verification_status,
  tan_number text,
  cin_number text,
  is_tax_exempt boolean DEFAULT false,
  tax_exemption_reason text,
  default_tax_percentage numeric DEFAULT 5.0,
  fssai_number text,
  fssai_certificate_url text,
  fssai_expiry_date date,
  fssai_verification_status USER-DEFINED DEFAULT 'PENDING'::verification_status,
  trade_license_number text,
  trade_license_url text,
  trade_license_expiry_date date,
  tax_metadata jsonb DEFAULT '{}'::jsonb,
  created_at timestamp with time zone NOT NULL DEFAULT now(),
  updated_at timestamp with time zone NOT NULL DEFAULT now(),
  CONSTRAINT merchant_store_tax_details_pkey PRIMARY KEY (id)
);
CREATE TABLE public.merchant_store_verification (
  id bigint NOT NULL DEFAULT nextval('merchant_store_verification_id_seq'::regclass),
  store_id bigint NOT NULL,
  verification_type text NOT NULL,
  verification_status USER-DEFINED NOT NULL DEFAULT 'PENDING'::verification_status,
  verified_by integer,
  verified_at timestamp with time zone,
  verification_notes text,
  rejected_reason text,
  rejected_at timestamp with time zone,
  expires_at timestamp with time zone,
  renewal_required boolean DEFAULT false,
  verification_metadata jsonb DEFAULT '{}'::jsonb,
  created_at timestamp with time zone NOT NULL DEFAULT now(),
  updated_at timestamp with time zone NOT NULL DEFAULT now(),
  CONSTRAINT merchant_store_verification_pkey PRIMARY KEY (id)
);
CREATE TABLE public.merchant_stores (
  id bigint NOT NULL DEFAULT nextval('merchant_stores_id_seq'::regclass),
  store_id text NOT NULL UNIQUE,
  parent_id bigint NOT NULL,
  store_name text NOT NULL,
  store_display_name text,
  store_description text,
  store_email text,
  store_phones ARRAY,
  full_address text NOT NULL,
  landmark text,
  city text NOT NULL,
  state text NOT NULL,
  postal_code text NOT NULL,
  country text DEFAULT 'IN'::text,
  latitude numeric CHECK (latitude IS NULL OR latitude >= '-90'::integer::numeric AND latitude <= 90::numeric),
  longitude numeric CHECK (longitude IS NULL OR longitude >= '-180'::integer::numeric AND longitude <= 180::numeric),
  logo_url text,
  banner_url text,
  gallery_images ARRAY,
  cuisine_types ARRAY,
  food_categories ARRAY,
  avg_preparation_time_minutes integer DEFAULT 30 CHECK (avg_preparation_time_minutes > 0),
  min_order_amount numeric DEFAULT 0 CHECK (min_order_amount >= 0::numeric),
  delivery_radius_km numeric,
  is_pure_veg boolean DEFAULT false,
  accepts_online_payment boolean DEFAULT true,
  accepts_cash boolean DEFAULT true,
  status USER-DEFINED NOT NULL DEFAULT 'INACTIVE'::store_status,
  approval_status USER-DEFINED NOT NULL DEFAULT 'DRAFT'::store_approval_status,
  approval_reason text,
  approved_by integer,
  approved_at timestamp with time zone,
  rejected_reason text,
  current_onboarding_step integer DEFAULT 1,
  onboarding_completed boolean DEFAULT false,
  onboarding_completed_at timestamp with time zone,
  is_active boolean DEFAULT false,
  is_accepting_orders boolean DEFAULT false,
  is_available boolean DEFAULT false,
  last_activity_at timestamp with time zone,
  deleted_at timestamp with time zone,
  deleted_by integer,
  delist_reason text,
  delisted_at timestamp with time zone,
  created_at timestamp with time zone NOT NULL DEFAULT now(),
  updated_at timestamp with time zone NOT NULL DEFAULT now(),
  created_by integer,
  updated_by integer,
  store_type USER-DEFINED,
  operational_status USER-DEFINED DEFAULT 'CLOSED'::store_operational_status,
  parent_merchant_id text,
  area_manager_id bigint,
  CONSTRAINT merchant_stores_pkey PRIMARY KEY (id),
  CONSTRAINT merchant_stores_parent_id_fkey FOREIGN KEY (parent_id) REFERENCES public.merchant_parents(id),
  CONSTRAINT merchant_stores_area_manager_id_fkey FOREIGN KEY (area_manager_id) REFERENCES public.area_managers(id),
  CONSTRAINT fk_merchant_stores_area_manager FOREIGN KEY (area_manager_id) REFERENCES public.area_managers(id)
);
CREATE TABLE public.merchant_user_store_access (
  id bigint NOT NULL DEFAULT nextval('merchant_user_store_access_id_seq'::regclass),
  user_id bigint NOT NULL,
  store_id bigint NOT NULL,
  access_level text NOT NULL DEFAULT 'READ_ONLY'::text,
  can_manage_menu boolean DEFAULT false,
  can_manage_orders boolean DEFAULT false,
  can_manage_payouts boolean DEFAULT false,
  can_view_reports boolean DEFAULT false,
  is_active boolean DEFAULT true,
  granted_at timestamp with time zone NOT NULL DEFAULT now(),
  granted_by integer,
  revoked_at timestamp with time zone,
  revoked_by integer,
  created_at timestamp with time zone NOT NULL DEFAULT now(),
  updated_at timestamp with time zone NOT NULL DEFAULT now(),
  CONSTRAINT merchant_user_store_access_pkey PRIMARY KEY (id),
  CONSTRAINT merchant_user_store_access_user_id_fkey FOREIGN KEY (user_id) REFERENCES public.merchant_users(id)
);
CREATE TABLE public.merchant_users (
  id bigint NOT NULL DEFAULT nextval('merchant_users_id_seq'::regclass),
  user_id text NOT NULL UNIQUE,
  parent_id bigint,
  name text NOT NULL,
  email text NOT NULL UNIQUE,
  mobile text NOT NULL UNIQUE,
  password_hash text,
  last_login_at timestamp with time zone,
  login_count integer DEFAULT 0,
  role text NOT NULL DEFAULT 'STORE_MANAGER'::text,
  is_active boolean DEFAULT true,
  is_verified boolean DEFAULT false,
  user_metadata jsonb DEFAULT '{}'::jsonb,
  created_at timestamp with time zone NOT NULL DEFAULT now(),
  updated_at timestamp with time zone NOT NULL DEFAULT now(),
  parent_merchant_id text,
  CONSTRAINT merchant_users_pkey PRIMARY KEY (id),
  CONSTRAINT merchant_users_parent_id_fkey FOREIGN KEY (parent_id) REFERENCES public.merchant_parents(id)
);
CREATE TABLE public.notification_logs (
  id bigint NOT NULL DEFAULT nextval('notification_logs_id_seq'::regclass),
  rider_id integer NOT NULL,
  template_id text,
  notification_type text NOT NULL,
  channel text NOT NULL,
  title text,
  body text NOT NULL,
  status text NOT NULL DEFAULT 'pending'::text,
  provider text,
  provider_message_id text,
  provider_response jsonb,
  error_message text,
  sent_at timestamp with time zone,
  delivered_at timestamp with time zone,
  opened_at timestamp with time zone,
  clicked_at timestamp with time zone,
  created_at timestamp with time zone NOT NULL DEFAULT now(),
  CONSTRAINT notification_logs_pkey PRIMARY KEY (id),
  CONSTRAINT notification_logs_rider_id_fkey FOREIGN KEY (rider_id) REFERENCES public.riders(id)
);
CREATE TABLE public.notification_preferences (
  id bigint NOT NULL DEFAULT nextval('notification_preferences_id_seq'::regclass),
  rider_id integer NOT NULL,
  notification_type text NOT NULL,
  channel text NOT NULL,
  enabled boolean NOT NULL DEFAULT true,
  quiet_hours_start time without time zone,
  quiet_hours_end time without time zone,
  created_at timestamp with time zone NOT NULL DEFAULT now(),
  updated_at timestamp with time zone NOT NULL DEFAULT now(),
  CONSTRAINT notification_preferences_pkey PRIMARY KEY (id),
  CONSTRAINT notification_preferences_rider_id_fkey FOREIGN KEY (rider_id) REFERENCES public.riders(id)
);
CREATE TABLE public.offer_management_access (
  id bigint NOT NULL DEFAULT nextval('offer_management_access_id_seq'::regclass),
  system_user_id bigint NOT NULL UNIQUE,
  customer_offer_access boolean DEFAULT false,
  merchant_offer_access boolean DEFAULT false,
  rider_offer_access boolean DEFAULT false,
  can_create_offer boolean DEFAULT false,
  can_update_offer boolean DEFAULT false,
  can_activate_offer boolean DEFAULT false,
  can_deactivate_offer boolean DEFAULT false,
  can_delete_offer boolean DEFAULT false,
  requires_approval boolean DEFAULT true,
  can_approve_offer boolean DEFAULT false,
  created_at timestamp with time zone NOT NULL DEFAULT now(),
  updated_at timestamp with time zone NOT NULL DEFAULT now(),
  CONSTRAINT offer_management_access_pkey PRIMARY KEY (id),
  CONSTRAINT offer_management_access_system_user_id_fkey FOREIGN KEY (system_user_id) REFERENCES public.system_users(id)
);
CREATE TABLE public.offer_participation (
  id bigint NOT NULL DEFAULT nextval('offer_participation_id_seq'::regclass),
  rider_id integer NOT NULL,
  offer_id integer NOT NULL,
  completed boolean NOT NULL DEFAULT false,
  progress jsonb DEFAULT '{}'::jsonb,
  reward_claimed boolean NOT NULL DEFAULT false,
  reward_claimed_at timestamp with time zone,
  metadata jsonb DEFAULT '{}'::jsonb,
  created_at timestamp with time zone NOT NULL DEFAULT now(),
  updated_at timestamp with time zone NOT NULL DEFAULT now(),
  CONSTRAINT offer_participation_pkey PRIMARY KEY (id),
  CONSTRAINT offer_participation_rider_id_fkey FOREIGN KEY (rider_id) REFERENCES public.riders(id),
  CONSTRAINT offer_participation_offer_id_fkey FOREIGN KEY (offer_id) REFERENCES public.offers(id)
);
CREATE TABLE public.offers (
  id bigint NOT NULL DEFAULT nextval('offers_id_seq'::regclass),
  title text NOT NULL,
  description text,
  scope USER-DEFINED NOT NULL DEFAULT 'global'::offer_scope,
  condition jsonb NOT NULL,
  reward_type USER-DEFINED NOT NULL DEFAULT 'cash'::reward_type,
  reward_amount numeric,
  reward_metadata jsonb DEFAULT '{}'::jsonb,
  start_date timestamp with time zone,
  end_date timestamp with time zone,
  active boolean NOT NULL DEFAULT true,
  metadata jsonb DEFAULT '{}'::jsonb,
  created_at timestamp with time zone NOT NULL DEFAULT now(),
  updated_at timestamp with time zone NOT NULL DEFAULT now(),
  CONSTRAINT offers_pkey PRIMARY KEY (id)
);
CREATE TABLE public.onboarding_payments (
  id bigint NOT NULL DEFAULT nextval('onboarding_payments_id_seq'::regclass),
  rider_id integer NOT NULL,
  amount numeric NOT NULL,
  provider text NOT NULL,
  ref_id text NOT NULL UNIQUE,
  payment_id text,
  status text NOT NULL DEFAULT 'pending'::text,
  metadata jsonb DEFAULT '{}'::jsonb,
  created_at timestamp with time zone NOT NULL DEFAULT now(),
  updated_at timestamp with time zone NOT NULL DEFAULT now(),
  CONSTRAINT onboarding_payments_pkey PRIMARY KEY (id),
  CONSTRAINT onboarding_payments_rider_id_fkey FOREIGN KEY (rider_id) REFERENCES public.riders(id)
);
CREATE TABLE public.onboarding_rule_policies (
  id bigint NOT NULL DEFAULT nextval('onboarding_rule_policies_id_seq'::regclass),
  rule_code text NOT NULL UNIQUE,
  rule_name text NOT NULL,
  scope USER-DEFINED NOT NULL DEFAULT 'global'::onboarding_rule_scope,
  scope_ref_id bigint,
  rule_type text NOT NULL,
  rule_config jsonb NOT NULL DEFAULT '{}'::jsonb,
  effective_from timestamp with time zone,
  effective_to timestamp with time zone,
  is_active boolean NOT NULL DEFAULT true,
  priority integer NOT NULL DEFAULT 0,
  created_at timestamp with time zone NOT NULL DEFAULT now(),
  updated_at timestamp with time zone NOT NULL DEFAULT now(),
  CONSTRAINT onboarding_rule_policies_pkey PRIMARY KEY (id)
);
CREATE TABLE public.onboarding_status_transitions (
  id bigint NOT NULL DEFAULT nextval('onboarding_status_transitions_id_seq'::regclass),
  rider_id integer NOT NULL,
  from_stage text,
  to_stage text,
  from_kyc text,
  to_kyc text,
  from_status text,
  to_status text,
  trigger_type text NOT NULL,
  trigger_ref_id bigint,
  performed_by_system_user_id bigint,
  created_at timestamp with time zone NOT NULL DEFAULT now(),
  CONSTRAINT onboarding_status_transitions_pkey PRIMARY KEY (id),
  CONSTRAINT onboarding_status_transitions_rider_id_fkey FOREIGN KEY (rider_id) REFERENCES public.riders(id),
  CONSTRAINT onboarding_status_transitions_performed_by_system_user_id_fkey FOREIGN KEY (performed_by_system_user_id) REFERENCES public.system_users(id)
);
CREATE TABLE public.order_access_controls (
  id bigint NOT NULL DEFAULT nextval('order_access_controls_id_seq'::regclass),
  system_user_id bigint NOT NULL UNIQUE,
  can_view_all_orders boolean DEFAULT false,
  can_view_assigned_orders boolean DEFAULT true,
  can_view_order_financial boolean DEFAULT false,
  can_view_customer_details boolean DEFAULT false,
  can_view_merchant_details boolean DEFAULT false,
  can_view_rider_details boolean DEFAULT false,
  can_create_order boolean DEFAULT false,
  can_update_order boolean DEFAULT false,
  can_cancel_order boolean DEFAULT false,
  can_assign_rider boolean DEFAULT false,
  can_reassign_rider boolean DEFAULT false,
  can_override_status boolean DEFAULT false,
  can_add_remark boolean DEFAULT false,
  can_process_refund boolean DEFAULT false,
  can_approve_refund boolean DEFAULT false,
  can_adjust_fare boolean DEFAULT false,
  refund_approval_limit numeric DEFAULT 0,
  fare_adjustment_limit numeric DEFAULT 0,
  food_access boolean DEFAULT true,
  parcel_access boolean DEFAULT true,
  ride_access boolean DEFAULT true,
  created_at timestamp with time zone NOT NULL DEFAULT now(),
  updated_at timestamp with time zone NOT NULL DEFAULT now(),
  CONSTRAINT order_access_controls_pkey PRIMARY KEY (id),
  CONSTRAINT order_access_controls_system_user_id_fkey FOREIGN KEY (system_user_id) REFERENCES public.system_users(id)
);
CREATE TABLE public.order_actions (
  id bigint NOT NULL DEFAULT nextval('order_actions_id_seq'::regclass),
  order_id bigint NOT NULL,
  rider_id integer NOT NULL,
  action USER-DEFINED NOT NULL,
  reason text,
  timestamp timestamp with time zone NOT NULL DEFAULT now(),
  synced_to_provider boolean DEFAULT false,
  provider_response jsonb,
  CONSTRAINT order_actions_pkey PRIMARY KEY (id),
  CONSTRAINT order_actions_order_id_fkey FOREIGN KEY (order_id) REFERENCES public.orders(id),
  CONSTRAINT order_actions_rider_id_fkey FOREIGN KEY (rider_id) REFERENCES public.riders(id)
);
CREATE TABLE public.order_assignments (
  id bigint NOT NULL DEFAULT nextval('order_assignments_id_seq'::regclass),
  order_id bigint NOT NULL,
  rider_id integer NOT NULL,
  assignment_method text NOT NULL,
  distance_km numeric,
  estimated_arrival_minutes integer,
  assignment_score numeric,
  status text NOT NULL DEFAULT 'pending'::text,
  responded_at timestamp with time zone,
  response_time_seconds integer,
  rejection_reason text,
  created_at timestamp with time zone NOT NULL DEFAULT now(),
  CONSTRAINT order_assignments_pkey PRIMARY KEY (id),
  CONSTRAINT order_assignments_order_id_fkey FOREIGN KEY (order_id) REFERENCES public.orders(id),
  CONSTRAINT order_assignments_rider_id_fkey FOREIGN KEY (rider_id) REFERENCES public.riders(id)
);
CREATE TABLE public.order_audit_log (
  id bigint NOT NULL DEFAULT nextval('order_audit_log_id_seq'::regclass),
  order_id bigint NOT NULL,
  action_type text NOT NULL,
  action_field text,
  old_value jsonb,
  new_value jsonb,
  actor_type text NOT NULL,
  actor_id bigint,
  actor_name text,
  actor_ip text,
  actor_user_agent text,
  action_reason text,
  action_metadata jsonb DEFAULT '{}'::jsonb,
  created_at timestamp with time zone NOT NULL DEFAULT now(),
  CONSTRAINT order_audit_log_pkey PRIMARY KEY (id),
  CONSTRAINT order_audit_log_order_id_fkey FOREIGN KEY (order_id) REFERENCES public.orders(id)
);
CREATE TABLE public.order_cancellation_reasons (
  id bigint NOT NULL DEFAULT nextval('order_cancellation_reasons_id_seq'::regclass),
  order_id bigint NOT NULL,
  cancelled_by text NOT NULL,
  cancelled_by_id integer,
  reason_code text NOT NULL,
  reason_text text,
  refund_status text DEFAULT 'pending'::text,
  refund_amount numeric,
  penalty_applied boolean DEFAULT false,
  penalty_amount numeric,
  metadata jsonb DEFAULT '{}'::jsonb,
  created_at timestamp with time zone NOT NULL DEFAULT now(),
  CONSTRAINT order_cancellation_reasons_pkey PRIMARY KEY (id),
  CONSTRAINT order_cancellation_reasons_order_id_fkey FOREIGN KEY (order_id) REFERENCES public.orders(id)
);
CREATE TABLE public.order_conflicts (
  id bigint NOT NULL DEFAULT nextval('order_conflicts_id_seq'::regclass),
  order_id bigint NOT NULL,
  provider_type USER-DEFINED NOT NULL,
  conflict_type text NOT NULL,
  our_value jsonb NOT NULL,
  provider_value jsonb NOT NULL,
  resolution_strategy USER-DEFINED DEFAULT 'manual_review'::conflict_resolution_strategy,
  resolved boolean DEFAULT false,
  resolved_by integer,
  resolved_at timestamp with time zone,
  resolution_notes text,
  created_at timestamp with time zone NOT NULL DEFAULT now(),
  CONSTRAINT order_conflicts_pkey PRIMARY KEY (id),
  CONSTRAINT order_conflicts_order_id_fkey FOREIGN KEY (order_id) REFERENCES public.orders(id)
);
CREATE TABLE public.order_delivery_images (
  id bigint NOT NULL DEFAULT nextval('order_delivery_images_id_seq'::regclass),
  order_id bigint NOT NULL,
  rider_assignment_id bigint,
  image_type text NOT NULL CHECK (image_type = ANY (ARRAY['pickup'::text, 'delivery'::text, 'rto'::text])),
  url text NOT NULL,
  taken_at timestamp with time zone NOT NULL DEFAULT now(),
  created_at timestamp with time zone NOT NULL DEFAULT now(),
  CONSTRAINT order_delivery_images_pkey PRIMARY KEY (id),
  CONSTRAINT order_delivery_images_order_id_fkey FOREIGN KEY (order_id) REFERENCES public.orders_core(id),
  CONSTRAINT order_delivery_images_rider_assignment_id_fkey FOREIGN KEY (rider_assignment_id) REFERENCES public.order_rider_assignments(id)
);
CREATE TABLE public.order_disputes (
  id bigint NOT NULL DEFAULT nextval('order_disputes_id_seq'::regclass),
  order_id bigint NOT NULL,
  order_ticket_id bigint,
  dispute_type text NOT NULL,
  dispute_reason text NOT NULL,
  dispute_description text,
  raised_by text NOT NULL,
  raised_by_id bigint,
  disputed_against text,
  disputed_against_id bigint,
  evidence_urls ARRAY,
  evidence_description text,
  dispute_status text DEFAULT 'open'::text,
  resolution text,
  resolution_amount numeric,
  resolved_at timestamp with time zone,
  resolved_by integer,
  resolved_by_name text,
  legal_case_id text,
  legal_notes text,
  dispute_metadata jsonb DEFAULT '{}'::jsonb,
  created_at timestamp with time zone NOT NULL DEFAULT now(),
  updated_at timestamp with time zone NOT NULL DEFAULT now(),
  CONSTRAINT order_disputes_pkey PRIMARY KEY (id),
  CONSTRAINT order_disputes_order_id_fkey FOREIGN KEY (order_id) REFERENCES public.orders(id),
  CONSTRAINT order_disputes_order_ticket_id_fkey FOREIGN KEY (order_ticket_id) REFERENCES public.order_tickets(id)
);
CREATE TABLE public.order_events (
  id bigint NOT NULL DEFAULT nextval('order_events_id_seq'::regclass),
  order_id bigint NOT NULL,
  event text NOT NULL,
  actor_type text,
  actor_id integer,
  metadata jsonb DEFAULT '{}'::jsonb,
  created_at timestamp with time zone NOT NULL DEFAULT now(),
  provider_event_id text,
  synced_to_provider boolean DEFAULT false,
  provider_sync_error text,
  CONSTRAINT order_events_pkey PRIMARY KEY (id),
  CONSTRAINT order_events_order_id_fkey FOREIGN KEY (order_id) REFERENCES public.orders(id)
);
CREATE TABLE public.order_food_details (
  id bigint NOT NULL DEFAULT nextval('order_food_details_id_seq'::regclass),
  order_id bigint NOT NULL UNIQUE,
  restaurant_id bigint,
  restaurant_name text,
  restaurant_phone text,
  restaurant_address text,
  preparation_time_minutes integer,
  estimated_preparation_time timestamp with time zone,
  actual_preparation_time timestamp with time zone,
  food_items_count integer DEFAULT 0,
  food_items_total_value numeric DEFAULT 0,
  requires_utensils boolean DEFAULT false,
  requires_packaging boolean DEFAULT true,
  food_metadata jsonb DEFAULT '{}'::jsonb,
  created_at timestamp with time zone NOT NULL DEFAULT now(),
  updated_at timestamp with time zone NOT NULL DEFAULT now(),
  CONSTRAINT order_food_details_pkey PRIMARY KEY (id),
  CONSTRAINT order_food_details_order_id_fkey FOREIGN KEY (order_id) REFERENCES public.orders(id)
);
CREATE TABLE public.order_food_items (
  id bigint NOT NULL DEFAULT nextval('order_food_items_id_seq'::regclass),
  order_id bigint NOT NULL,
  item_name text NOT NULL,
  quantity integer NOT NULL DEFAULT 1 CHECK (quantity > 0),
  unit_price numeric NOT NULL CHECK (unit_price >= 0::numeric),
  total_price numeric NOT NULL CHECK (total_price >= 0::numeric),
  special_instructions text,
  created_at timestamp with time zone NOT NULL DEFAULT now(),
  CONSTRAINT order_food_items_pkey PRIMARY KEY (id),
  CONSTRAINT order_food_items_order_id_fkey FOREIGN KEY (order_id) REFERENCES public.orders(id)
);
CREATE TABLE public.order_instructions (
  id bigint NOT NULL DEFAULT nextval('order_instructions_id_seq'::regclass),
  order_id bigint NOT NULL,
  instruction_for text NOT NULL,
  instruction_text text NOT NULL,
  instruction_priority text DEFAULT 'normal'::text,
  created_at timestamp with time zone NOT NULL DEFAULT now(),
  created_by text,
  created_by_id bigint,
  CONSTRAINT order_instructions_pkey PRIMARY KEY (id),
  CONSTRAINT order_instructions_order_id_fkey FOREIGN KEY (order_id) REFERENCES public.orders(id)
);
CREATE TABLE public.order_item_addons (
  id bigint NOT NULL DEFAULT nextval('order_item_addons_id_seq'::regclass),
  order_item_id bigint NOT NULL,
  addon_id bigint,
  addon_name text NOT NULL,
  addon_type text,
  addon_price numeric DEFAULT 0,
  quantity integer DEFAULT 1,
  created_at timestamp with time zone NOT NULL DEFAULT now(),
  CONSTRAINT order_item_addons_pkey PRIMARY KEY (id),
  CONSTRAINT order_item_addons_order_item_id_fkey FOREIGN KEY (order_item_id) REFERENCES public.order_items(id)
);
CREATE TABLE public.order_items (
  id bigint NOT NULL DEFAULT nextval('order_items_id_seq'::regclass),
  order_id bigint NOT NULL,
  item_type text NOT NULL,
  item_name text NOT NULL,
  quantity integer NOT NULL DEFAULT 1 CHECK (quantity > 0),
  unit_price numeric CHECK (unit_price >= 0::numeric),
  total_price numeric CHECK (total_price >= 0::numeric),
  description text,
  metadata jsonb DEFAULT '{}'::jsonb,
  created_at timestamp with time zone NOT NULL DEFAULT now(),
  item_id bigint,
  merchant_menu_id bigint,
  item_title text,
  item_description text,
  item_image_url text,
  item_category text,
  item_subcategory text,
  tax_percentage numeric DEFAULT 0,
  tax_amount numeric DEFAULT 0,
  merchant_offer jsonb DEFAULT '{}'::jsonb,
  platform_offer jsonb DEFAULT '{}'::jsonb,
  final_item_price numeric,
  discount_amount numeric DEFAULT 0,
  is_veg boolean,
  spice_level text,
  customizations text,
  item_weight_kg numeric,
  item_value numeric,
  item_metadata jsonb DEFAULT '{}'::jsonb,
  merchant_menu_item_id bigint,
  CONSTRAINT order_items_pkey PRIMARY KEY (id),
  CONSTRAINT order_items_order_id_fkey FOREIGN KEY (order_id) REFERENCES public.orders(id),
  CONSTRAINT order_items_merchant_menu_item_id_fkey FOREIGN KEY (merchant_menu_item_id) REFERENCES public.merchant_menu_items(id)
);
CREATE TABLE public.order_notifications (
  id bigint NOT NULL DEFAULT nextval('order_notifications_id_seq'::regclass),
  order_id bigint NOT NULL,
  notification_type text NOT NULL,
  notification_channel USER-DEFINED NOT NULL,
  message text NOT NULL,
  message_template_id text,
  sent_to text NOT NULL,
  recipient_type text,
  recipient_id bigint,
  sent_at timestamp with time zone NOT NULL DEFAULT now(),
  delivered_at timestamp with time zone,
  read_at timestamp with time zone,
  failed_at timestamp with time zone,
  provider_message_id text,
  provider_response jsonb DEFAULT '{}'::jsonb,
  notification_metadata jsonb DEFAULT '{}'::jsonb,
  order_core_id bigint,
  CONSTRAINT order_notifications_pkey PRIMARY KEY (id),
  CONSTRAINT order_notifications_order_id_fkey FOREIGN KEY (order_id) REFERENCES public.orders(id),
  CONSTRAINT order_notifications_order_core_id_fkey FOREIGN KEY (order_core_id) REFERENCES public.orders_core(id)
);
CREATE TABLE public.order_otps (
  id bigint NOT NULL DEFAULT nextval('order_otps_id_seq'::regclass),
  order_id bigint NOT NULL,
  otp_type USER-DEFINED NOT NULL,
  code text NOT NULL,
  verified_at timestamp with time zone,
  bypass_reason text,
  created_at timestamp with time zone NOT NULL DEFAULT now(),
  updated_at timestamp with time zone NOT NULL DEFAULT now(),
  CONSTRAINT order_otps_pkey PRIMARY KEY (id),
  CONSTRAINT order_otps_order_id_fkey FOREIGN KEY (order_id) REFERENCES public.orders_core(id)
);
CREATE TABLE public.order_parcel_details (
  id bigint NOT NULL DEFAULT nextval('order_parcel_details_id_seq'::regclass),
  order_id bigint NOT NULL UNIQUE,
  package_weight_kg numeric,
  package_length_cm numeric,
  package_width_cm numeric,
  package_height_cm numeric,
  package_volume_liters numeric,
  package_value numeric,
  package_description text,
  package_contents ARRAY,
  is_fragile boolean DEFAULT false,
  is_hazardous boolean DEFAULT false,
  requires_handling text,
  is_cod boolean DEFAULT false,
  cod_amount numeric DEFAULT 0,
  cod_collected boolean DEFAULT false,
  cod_collected_at timestamp with time zone,
  requires_signature boolean DEFAULT false,
  requires_otp_verification boolean DEFAULT false,
  requires_photo_proof boolean DEFAULT false,
  delivery_proof_url text,
  insurance_required boolean DEFAULT false,
  insurance_amount numeric,
  insurance_provider text,
  parcel_metadata jsonb DEFAULT '{}'::jsonb,
  created_at timestamp with time zone NOT NULL DEFAULT now(),
  updated_at timestamp with time zone NOT NULL DEFAULT now(),
  CONSTRAINT order_parcel_details_pkey PRIMARY KEY (id),
  CONSTRAINT order_parcel_details_order_id_fkey FOREIGN KEY (order_id) REFERENCES public.orders(id)
);
CREATE TABLE public.order_payments (
  id bigint NOT NULL DEFAULT nextval('order_payments_id_seq'::regclass),
  order_id bigint NOT NULL,
  payment_attempt_no integer NOT NULL DEFAULT 1 CHECK (payment_attempt_no > 0),
  payment_source text,
  payment_mode USER-DEFINED NOT NULL,
  transaction_id text UNIQUE,
  mp_transaction_id text,
  pg_transaction_id text,
  pg_name text,
  pg_order_id text,
  pg_payment_id text,
  pg_signature text,
  payment_status USER-DEFINED NOT NULL DEFAULT 'pending'::payment_status_type,
  payment_amount numeric NOT NULL CHECK (payment_amount > 0::numeric),
  payment_fee numeric DEFAULT 0,
  net_amount numeric,
  coupon_code text,
  coupon_type text,
  coupon_value numeric,
  coupon_max_discount numeric,
  coupon_discount_applied numeric DEFAULT 0,
  is_refunded boolean DEFAULT false,
  refunded_amount numeric DEFAULT 0,
  refund_transaction_id text,
  pg_response jsonb DEFAULT '{}'::jsonb,
  payment_metadata jsonb DEFAULT '{}'::jsonb,
  created_at timestamp with time zone NOT NULL DEFAULT now(),
  updated_at timestamp with time zone NOT NULL DEFAULT now(),
  CONSTRAINT order_payments_pkey PRIMARY KEY (id),
  CONSTRAINT order_payments_order_id_fkey FOREIGN KEY (order_id) REFERENCES public.orders(id)
);
CREATE TABLE public.order_provider_mapping (
  id bigint NOT NULL DEFAULT nextval('order_provider_mapping_id_seq'::regclass),
  order_id bigint NOT NULL,
  provider_id bigint NOT NULL,
  provider_order_id text NOT NULL,
  provider_reference text,
  provider_status text,
  provider_status_updated_at timestamp with time zone,
  synced_at timestamp with time zone,
  sync_status text,
  sync_error text,
  provider_metadata jsonb DEFAULT '{}'::jsonb,
  provider_fare numeric,
  provider_commission numeric,
  created_at timestamp with time zone NOT NULL DEFAULT now(),
  updated_at timestamp with time zone NOT NULL DEFAULT now(),
  CONSTRAINT order_provider_mapping_pkey PRIMARY KEY (id),
  CONSTRAINT order_provider_mapping_order_id_fkey FOREIGN KEY (order_id) REFERENCES public.orders_core(id),
  CONSTRAINT order_provider_mapping_provider_id_fkey FOREIGN KEY (provider_id) REFERENCES public.order_providers(id)
);
CREATE TABLE public.order_providers (
  id bigint NOT NULL DEFAULT nextval('order_providers_id_seq'::regclass),
  code text NOT NULL UNIQUE,
  name text NOT NULL,
  is_active boolean NOT NULL DEFAULT true,
  created_at timestamp with time zone NOT NULL DEFAULT now(),
  updated_at timestamp with time zone NOT NULL DEFAULT now(),
  CONSTRAINT order_providers_pkey PRIMARY KEY (id)
);
CREATE TABLE public.order_ratings (
  id bigint NOT NULL DEFAULT nextval('order_ratings_id_seq'::regclass),
  order_id bigint NOT NULL,
  rider_id integer NOT NULL,
  rated_by text NOT NULL,
  rated_by_id integer,
  rating smallint NOT NULL CHECK (rating >= 1 AND rating <= 5),
  comment text,
  rating_categories jsonb DEFAULT '{}'::jsonb,
  created_at timestamp with time zone NOT NULL DEFAULT now(),
  CONSTRAINT order_ratings_pkey PRIMARY KEY (id),
  CONSTRAINT order_ratings_order_id_fkey FOREIGN KEY (order_id) REFERENCES public.orders(id),
  CONSTRAINT order_ratings_rider_id_fkey FOREIGN KEY (rider_id) REFERENCES public.riders(id)
);
CREATE TABLE public.order_refunds (
  id bigint NOT NULL DEFAULT nextval('order_refunds_id_seq'::regclass),
  order_id bigint NOT NULL,
  order_payment_id bigint,
  refund_type USER-DEFINED NOT NULL,
  refund_reason text NOT NULL,
  refund_description text,
  redemption_id text,
  refund_id text UNIQUE,
  pg_transaction_id text,
  pg_refund_id text,
  product_type text,
  refund_amount numeric NOT NULL CHECK (refund_amount > 0::numeric),
  refund_fee numeric DEFAULT 0,
  net_refund_amount numeric,
  issued_coupon_code text,
  issued_coupon_value numeric,
  issued_coupon_expiry timestamp with time zone,
  mx_debit_amount numeric DEFAULT 0,
  mx_debit_reason text,
  refund_status text DEFAULT 'pending'::text,
  refund_initiated_by text,
  refund_initiated_by_id bigint,
  refund_processed_by text,
  refund_processed_by_id bigint,
  pg_refund_response jsonb DEFAULT '{}'::jsonb,
  refund_metadata jsonb DEFAULT '{}'::jsonb,
  created_at timestamp with time zone NOT NULL DEFAULT now(),
  processed_at timestamp with time zone,
  completed_at timestamp with time zone,
  CONSTRAINT order_refunds_pkey PRIMARY KEY (id),
  CONSTRAINT order_refunds_order_id_fkey FOREIGN KEY (order_id) REFERENCES public.orders(id),
  CONSTRAINT order_refunds_order_payment_id_fkey FOREIGN KEY (order_payment_id) REFERENCES public.order_payments(id)
);
CREATE TABLE public.order_remarks (
  id bigint NOT NULL DEFAULT nextval('order_remarks_id_seq'::regclass),
  order_id bigint NOT NULL,
  actor_type text NOT NULL,
  actor_id bigint,
  actor_name text,
  action_taken text,
  remark text NOT NULL,
  remark_category text,
  remark_priority text DEFAULT 'normal'::text,
  visible_to ARRAY,
  is_internal boolean DEFAULT false,
  remark_metadata jsonb DEFAULT '{}'::jsonb,
  created_at timestamp with time zone NOT NULL DEFAULT now(),
  CONSTRAINT order_remarks_pkey PRIMARY KEY (id),
  CONSTRAINT order_remarks_order_id_fkey FOREIGN KEY (order_id) REFERENCES public.orders(id)
);
CREATE TABLE public.order_ride_details (
  id bigint NOT NULL DEFAULT nextval('order_ride_details_id_seq'::regclass),
  order_id bigint NOT NULL UNIQUE,
  passenger_name text,
  passenger_phone text,
  passenger_email text,
  passenger_count integer DEFAULT 1 CHECK (passenger_count > 0),
  ride_type text,
  vehicle_type_required text,
  base_fare numeric DEFAULT 0,
  distance_fare numeric DEFAULT 0,
  time_fare numeric DEFAULT 0,
  surge_multiplier numeric DEFAULT 1.0 CHECK (surge_multiplier >= 1.0),
  surge_amount numeric DEFAULT 0,
  toll_charges numeric DEFAULT 0,
  parking_charges numeric DEFAULT 0,
  waiting_charges numeric DEFAULT 0,
  night_charges numeric DEFAULT 0,
  gst_amount numeric DEFAULT 0,
  discount_amount numeric DEFAULT 0,
  total_fare numeric DEFAULT 0 CHECK (total_fare >= 0::numeric),
  scheduled_ride boolean DEFAULT false,
  scheduled_pickup_time timestamp with time zone,
  return_trip boolean DEFAULT false,
  return_pickup_address text,
  return_pickup_lat double precision,
  return_pickup_lon double precision,
  return_pickup_time timestamp with time zone,
  route_polyline text,
  route_waypoints jsonb DEFAULT '[]'::jsonb,
  estimated_route_distance_km numeric,
  actual_route_distance_km numeric,
  ride_metadata jsonb DEFAULT '{}'::jsonb,
  created_at timestamp with time zone NOT NULL DEFAULT now(),
  updated_at timestamp with time zone NOT NULL DEFAULT now(),
  CONSTRAINT order_ride_details_pkey PRIMARY KEY (id),
  CONSTRAINT order_ride_details_order_id_fkey FOREIGN KEY (order_id) REFERENCES public.orders(id)
);
CREATE TABLE public.order_rider_actions (
  id bigint NOT NULL DEFAULT nextval('order_rider_actions_id_seq'::regclass),
  order_id bigint NOT NULL,
  rider_assignment_id bigint,
  rider_id integer NOT NULL,
  action USER-DEFINED NOT NULL,
  reason text,
  reason_code text,
  response_time_seconds integer,
  distance_from_pickup_km numeric,
  action_metadata jsonb DEFAULT '{}'::jsonb,
  timestamp timestamp with time zone NOT NULL DEFAULT now(),
  CONSTRAINT order_rider_actions_pkey PRIMARY KEY (id),
  CONSTRAINT order_rider_actions_order_id_fkey FOREIGN KEY (order_id) REFERENCES public.orders(id),
  CONSTRAINT order_rider_actions_rider_assignment_id_fkey FOREIGN KEY (rider_assignment_id) REFERENCES public.order_rider_assignments(id),
  CONSTRAINT order_rider_actions_rider_id_fkey FOREIGN KEY (rider_id) REFERENCES public.riders(id)
);
CREATE TABLE public.order_rider_assignments (
  id bigint NOT NULL DEFAULT nextval('order_rider_assignments_id_seq'::regclass),
  order_id bigint NOT NULL,
  rider_id integer NOT NULL,
  rider_name text,
  rider_mobile text,
  rider_vehicle_type text,
  rider_vehicle_number text,
  delivery_provider text,
  provider_rider_id text,
  assignment_status USER-DEFINED NOT NULL DEFAULT 'pending'::rider_assignment_status,
  assignment_method text,
  assignment_score numeric,
  distance_to_pickup_km numeric CHECK (distance_to_pickup_km IS NULL OR distance_to_pickup_km >= 0::numeric),
  estimated_arrival_minutes integer,
  assigned_at timestamp with time zone,
  accepted_at timestamp with time zone,
  rejected_at timestamp with time zone,
  reached_merchant_at timestamp with time zone,
  picked_up_at timestamp with time zone,
  delivered_at timestamp with time zone,
  cancelled_at timestamp with time zone,
  cancellation_reason text,
  cancellation_reason_code text,
  cancelled_by text,
  cancelled_by_id bigint,
  distance_to_merchant_km numeric,
  distance_to_customer_km numeric,
  total_distance_km numeric,
  rider_earning numeric CHECK (rider_earning IS NULL OR rider_earning >= 0::numeric),
  commission_amount numeric,
  tip_amount numeric DEFAULT 0,
  assignment_metadata jsonb DEFAULT '{}'::jsonb,
  created_at timestamp with time zone NOT NULL DEFAULT now(),
  updated_at timestamp with time zone NOT NULL DEFAULT now(),
  provider_assignment_id text,
  provider_assignment_status text,
  synced_to_provider boolean DEFAULT false,
  provider_sync_error text,
  provider_sync_retry_count integer DEFAULT 0,
  provider_response jsonb DEFAULT '{}'::jsonb,
  provider_metadata jsonb DEFAULT '{}'::jsonb,
  CONSTRAINT order_rider_assignments_pkey PRIMARY KEY (id),
  CONSTRAINT order_rider_assignments_rider_id_fkey FOREIGN KEY (rider_id) REFERENCES public.riders(id),
  CONSTRAINT order_rider_assignments_order_id_fkey FOREIGN KEY (order_id) REFERENCES public.orders(id)
);
CREATE TABLE public.order_rider_distances (
  id bigint NOT NULL DEFAULT nextval('order_rider_distances_id_seq'::regclass),
  rider_assignment_id bigint NOT NULL,
  merchant_to_rider_km numeric,
  merchant_to_customer_km numeric,
  rider_to_merchant_km numeric,
  rider_to_customer_km numeric,
  total_distance_km numeric,
  route_polyline text,
  route_duration_seconds integer,
  route_metadata jsonb DEFAULT '{}'::jsonb,
  recorded_at timestamp with time zone NOT NULL DEFAULT now(),
  CONSTRAINT order_rider_distances_pkey PRIMARY KEY (id),
  CONSTRAINT order_rider_distances_rider_assignment_id_fkey FOREIGN KEY (rider_assignment_id) REFERENCES public.order_rider_assignments(id)
);
CREATE TABLE public.order_route_snapshots (
  id bigint NOT NULL DEFAULT nextval('order_route_snapshots_id_seq'::regclass),
  order_id bigint NOT NULL,
  snapshot_type text NOT NULL,
  distance_km numeric,
  duration_seconds integer,
  polyline text,
  mapbox_response jsonb,
  recorded_at timestamp with time zone NOT NULL DEFAULT now(),
  created_at timestamp with time zone NOT NULL DEFAULT now(),
  CONSTRAINT order_route_snapshots_pkey PRIMARY KEY (id),
  CONSTRAINT order_route_snapshots_order_id_fkey FOREIGN KEY (order_id) REFERENCES public.orders_core(id)
);
CREATE TABLE public.order_status_history (
  id bigint NOT NULL DEFAULT nextval('order_status_history_id_seq'::regclass),
  order_id bigint NOT NULL,
  from_status USER-DEFINED,
  to_status USER-DEFINED NOT NULL,
  changed_by text NOT NULL,
  changed_by_id integer,
  reason text,
  location_lat double precision,
  location_lon double precision,
  metadata jsonb DEFAULT '{}'::jsonb,
  created_at timestamp with time zone NOT NULL DEFAULT now(),
  synced_to_provider boolean DEFAULT false,
  provider_status text,
  CONSTRAINT order_status_history_pkey PRIMARY KEY (id),
  CONSTRAINT order_status_history_order_id_fkey FOREIGN KEY (order_id) REFERENCES public.orders(id)
);
CREATE TABLE public.order_sync_logs (
  id bigint NOT NULL DEFAULT nextval('order_sync_logs_id_seq'::regclass),
  order_id bigint NOT NULL,
  provider_type USER-DEFINED NOT NULL,
  sync_direction text NOT NULL,
  sync_type text NOT NULL,
  old_status USER-DEFINED,
  new_status USER-DEFINED,
  old_data jsonb,
  new_data jsonb,
  success boolean DEFAULT false,
  error_message text,
  retry_count integer DEFAULT 0,
  created_at timestamp with time zone NOT NULL DEFAULT now(),
  CONSTRAINT order_sync_logs_pkey PRIMARY KEY (id),
  CONSTRAINT order_sync_logs_order_id_fkey FOREIGN KEY (order_id) REFERENCES public.orders(id)
);
CREATE TABLE public.order_tickets (
  id bigint NOT NULL DEFAULT nextval('order_tickets_id_seq'::regclass),
  order_id bigint NOT NULL,
  ticket_source USER-DEFINED NOT NULL,
  raised_by_id bigint,
  raised_by_name text,
  raised_by_type text,
  issue_category text NOT NULL,
  issue_subcategory text,
  description text NOT NULL,
  attachments ARRAY,
  priority USER-DEFINED NOT NULL DEFAULT 'medium'::ticket_priority_type,
  status USER-DEFINED NOT NULL DEFAULT 'open'::ticket_status,
  assigned_to_agent_id integer,
  assigned_to_agent_name text,
  assigned_at timestamp with time zone,
  resolution text,
  resolved_at timestamp with time zone,
  resolved_by integer,
  resolved_by_name text,
  follow_up_required boolean DEFAULT false,
  follow_up_date timestamp with time zone,
  ticket_metadata jsonb DEFAULT '{}'::jsonb,
  created_at timestamp with time zone NOT NULL DEFAULT now(),
  updated_at timestamp with time zone NOT NULL DEFAULT now(),
  CONSTRAINT order_tickets_pkey PRIMARY KEY (id),
  CONSTRAINT order_tickets_order_id_fkey FOREIGN KEY (order_id) REFERENCES public.orders(id)
);
CREATE TABLE public.order_timeline (
  id bigint NOT NULL DEFAULT nextval('order_timeline_id_seq'::regclass),
  order_id bigint NOT NULL,
  status USER-DEFINED NOT NULL,
  previous_status USER-DEFINED,
  actor_type text NOT NULL,
  actor_id bigint,
  actor_name text,
  location_lat double precision,
  location_lon double precision,
  location_address text,
  status_message text,
  status_metadata jsonb DEFAULT '{}'::jsonb,
  occurred_at timestamp with time zone NOT NULL DEFAULT now(),
  synced_to_provider boolean DEFAULT false,
  provider_status text,
  provider_event_id text,
  provider_sync_error text,
  CONSTRAINT order_timeline_pkey PRIMARY KEY (id),
  CONSTRAINT order_timeline_order_id_fkey FOREIGN KEY (order_id) REFERENCES public.orders(id)
);
CREATE TABLE public.orders (
  id bigint NOT NULL DEFAULT nextval('orders_id_seq'::regclass),
  order_type USER-DEFINED NOT NULL,
  external_ref text,
  rider_id integer,
  merchant_id bigint,
  customer_id bigint,
  pickup_address text NOT NULL,
  drop_address text NOT NULL,
  pickup_lat double precision NOT NULL,
  pickup_lon double precision NOT NULL,
  drop_lat double precision NOT NULL,
  drop_lon double precision NOT NULL,
  distance_km numeric,
  eta_seconds integer,
  fare_amount numeric,
  commission_amount numeric,
  rider_earning numeric,
  status USER-DEFINED NOT NULL DEFAULT 'assigned'::order_status_type,
  metadata jsonb DEFAULT '{}'::jsonb,
  created_at timestamp with time zone NOT NULL DEFAULT now(),
  updated_at timestamp with time zone NOT NULL DEFAULT now(),
  cancellation_reason_id bigint,
  restaurant_name text,
  restaurant_phone text,
  preparation_time_minutes integer,
  food_items_count integer,
  food_items_total_value numeric,
  requires_utensils boolean DEFAULT false,
  delivery_instructions text,
  package_weight_kg numeric,
  package_length_cm numeric,
  package_width_cm numeric,
  package_height_cm numeric,
  package_value numeric,
  is_fragile boolean DEFAULT false,
  is_cod boolean DEFAULT false,
  cod_amount numeric,
  requires_signature boolean DEFAULT false,
  requires_otp_verification boolean DEFAULT false,
  insurance_required boolean DEFAULT false,
  insurance_amount numeric,
  package_description text,
  passenger_name text,
  passenger_phone text,
  passenger_count integer DEFAULT 1,
  ride_type text,
  vehicle_type_required text,
  base_fare numeric,
  distance_fare numeric,
  time_fare numeric,
  surge_multiplier numeric DEFAULT 1.0,
  toll_charges numeric DEFAULT 0,
  parking_charges numeric DEFAULT 0,
  waiting_charges numeric DEFAULT 0,
  scheduled_ride boolean DEFAULT false,
  scheduled_pickup_time timestamp with time zone,
  return_trip boolean DEFAULT false,
  return_pickup_address text,
  return_pickup_lat double precision,
  return_pickup_lon double precision,
  return_pickup_time timestamp with time zone,
  priority text DEFAULT 'normal'::text,
  special_requirements ARRAY,
  contact_person_name text,
  contact_person_phone text,
  estimated_pickup_time timestamp with time zone,
  estimated_delivery_time timestamp with time zone,
  actual_pickup_time timestamp with time zone,
  actual_delivery_time timestamp with time zone,
  delivery_proof_url text,
  delivery_proof_type text,
  customer_rating smallint,
  customer_feedback text,
  food_order_status USER-DEFINED,
  provider_order_id text,
  provider_reference text,
  synced_with_provider boolean DEFAULT false,
  last_sync_at timestamp with time zone,
  sync_status text,
  sync_error text,
  provider_metadata jsonb DEFAULT '{}'::jsonb,
  provider_fare_amount numeric,
  provider_commission numeric,
  created_via text DEFAULT 'app'::text,
  created_by_user_id integer,
  assigned_via text DEFAULT 'auto'::text,
  provider_status text,
  provider_status_updated_at timestamp with time zone,
  swiggy_order_id text,
  swiggy_restaurant_id text,
  swiggy_customer_id text,
  swiggy_delivery_partner_id text,
  zomato_order_id text,
  zomato_restaurant_id text,
  zomato_customer_id text,
  zomato_delivery_partner_id text,
  rapido_booking_id text,
  rapido_rider_id text,
  rapido_customer_id text,
  rapido_trip_id text,
  order_uuid uuid DEFAULT gen_random_uuid() UNIQUE,
  order_category USER-DEFINED,
  veg_non_veg USER-DEFINED,
  order_source USER-DEFINED DEFAULT 'internal'::order_source_type,
  buyer_app_name text,
  external_order_id text,
  merchant_parent_id bigint,
  merchant_name text,
  merchant_address text,
  merchant_phone text,
  merchant_email text,
  customer_name text,
  customer_mobile text,
  customer_email text,
  customer_address_id bigint,
  delivery_address_auto text,
  delivery_address_manual text,
  alternate_mobiles ARRAY,
  landmark text,
  pincode text,
  device_type text,
  device_os text,
  device_app_version text,
  device_ip text,
  user_agent text,
  is_self_order boolean DEFAULT true,
  order_for_name text,
  order_for_mobile text,
  order_for_relation text,
  contact_less_delivery boolean DEFAULT false,
  special_delivery_notes text,
  total_item_value numeric DEFAULT 0,
  total_tax numeric DEFAULT 0,
  total_discount numeric DEFAULT 0,
  total_delivery_fee numeric DEFAULT 0,
  total_ctm numeric DEFAULT 0,
  total_payable numeric DEFAULT 0,
  total_paid numeric DEFAULT 0,
  total_refunded numeric DEFAULT 0,
  has_tip boolean DEFAULT false,
  tip_amount numeric DEFAULT 0,
  is_bulk_order boolean DEFAULT false,
  bulk_reason text,
  bulk_order_group_id text,
  delivery_type USER-DEFINED DEFAULT 'standard'::delivery_type,
  delivery_initiator USER-DEFINED DEFAULT 'customer'::delivery_initiator_type,
  locality_type USER-DEFINED,
  delivered_by text,
  default_system_kpt_minutes integer,
  merchant_updated_kpt_minutes integer,
  first_eta timestamp with time zone,
  promised_eta timestamp with time zone,
  current_status USER-DEFINED,
  payment_status USER-DEFINED DEFAULT 'pending'::payment_status_type,
  payment_method USER-DEFINED,
  cancelled_at timestamp with time zone,
  cancelled_by text,
  cancelled_by_id bigint,
  cancellation_reason text,
  refund_status text,
  refund_amount numeric DEFAULT 0,
  last_agent_action text,
  last_agent_id integer,
  last_agent_action_at timestamp with time zone,
  order_metadata jsonb DEFAULT '{}'::jsonb,
  provider_order_number text,
  sync_retry_count integer DEFAULT 0,
  provider_rider_payout numeric,
  provider_webhook_data jsonb DEFAULT '{}'::jsonb,
  provider_created_at timestamp with time zone,
  provider_updated_at timestamp with time zone,
  provider_customer_id text,
  provider_merchant_id text,
  provider_restaurant_id text,
  ondc_order_id text,
  shiprocket_shipment_id text,
  webhook_event_id bigint,
  assignment_provider text,
  merchant_store_id bigint,
  merchant_store_name text,
  merchant_cuisine_types ARRAY,
  merchant_avg_prep_time integer,
  merchant_commission_rate numeric,
  merchant_gst_number text,
  source USER-DEFINED NOT NULL DEFAULT 'internal'::order_source_type,
  parent_merchant_id text,
  tpl_provider_id bigint,
  tpl_order_request_id bigint,
  tpl_inbound_order_id bigint,
  is_tpl_order boolean DEFAULT false,
  tpl_direction text CHECK (tpl_direction = ANY (ARRAY['outbound'::text, 'inbound'::text, NULL::text])),
  CONSTRAINT orders_pkey PRIMARY KEY (id),
  CONSTRAINT orders_rider_id_fkey FOREIGN KEY (rider_id) REFERENCES public.riders(id),
  CONSTRAINT orders_cancellation_reason_id_fkey FOREIGN KEY (cancellation_reason_id) REFERENCES public.order_cancellation_reasons(id),
  CONSTRAINT orders_webhook_event_id_fkey FOREIGN KEY (webhook_event_id) REFERENCES public.webhook_events(id),
  CONSTRAINT orders_customer_id_fkey FOREIGN KEY (customer_id) REFERENCES public.customers(id),
  CONSTRAINT orders_merchant_parent_id_fkey FOREIGN KEY (merchant_parent_id) REFERENCES public.merchant_parents(id),
  CONSTRAINT orders_tpl_provider_id_fkey FOREIGN KEY (tpl_provider_id) REFERENCES public.tpl_providers(id),
  CONSTRAINT orders_tpl_order_request_id_fkey FOREIGN KEY (tpl_order_request_id) REFERENCES public.tpl_order_requests(id),
  CONSTRAINT orders_tpl_inbound_order_id_fkey FOREIGN KEY (tpl_inbound_order_id) REFERENCES public.tpl_inbound_orders(id)
);
CREATE TABLE public.orders_core (
  id bigint NOT NULL DEFAULT nextval('orders_core_id_seq'::regclass),
  order_uuid uuid NOT NULL DEFAULT gen_random_uuid() UNIQUE,
  order_type USER-DEFINED NOT NULL,
  order_source USER-DEFINED NOT NULL DEFAULT 'internal'::order_source_type,
  external_ref text,
  rider_id integer,
  customer_id bigint,
  merchant_store_id bigint,
  merchant_parent_id bigint,
  pickup_address_raw text NOT NULL,
  pickup_address_normalized text,
  pickup_address_geocoded text,
  pickup_lat numeric NOT NULL,
  pickup_lon numeric NOT NULL,
  drop_address_raw text NOT NULL,
  drop_address_normalized text,
  drop_address_geocoded text,
  drop_lat numeric NOT NULL,
  drop_lon numeric NOT NULL,
  distance_km numeric,
  eta_seconds integer,
  pickup_address_deviation_meters numeric,
  drop_address_deviation_meters numeric,
  distance_mismatch_flagged boolean NOT NULL DEFAULT false,
  fare_amount numeric,
  commission_amount numeric,
  rider_earning numeric,
  status USER-DEFINED NOT NULL DEFAULT 'assigned'::order_status_type,
  current_status text,
  payment_status USER-DEFINED DEFAULT 'pending'::payment_status_type,
  payment_method USER-DEFINED,
  risk_flagged boolean NOT NULL DEFAULT false,
  risk_reason text,
  is_bulk_order boolean NOT NULL DEFAULT false,
  bulk_order_group_id text,
  cancellation_reason_id bigint,
  cancelled_at timestamp with time zone,
  cancelled_by text,
  cancelled_by_id bigint,
  created_at timestamp with time zone NOT NULL DEFAULT now(),
  updated_at timestamp with time zone NOT NULL DEFAULT now(),
  estimated_pickup_time timestamp with time zone,
  estimated_delivery_time timestamp with time zone,
  actual_pickup_time timestamp with time zone,
  actual_delivery_time timestamp with time zone,
  CONSTRAINT orders_core_pkey PRIMARY KEY (id),
  CONSTRAINT orders_core_merchant_store_id_fkey FOREIGN KEY (merchant_store_id) REFERENCES public.merchant_stores(id),
  CONSTRAINT orders_core_cancellation_reason_id_fkey FOREIGN KEY (cancellation_reason_id) REFERENCES public.order_cancellation_reasons(id),
  CONSTRAINT orders_core_rider_id_fkey FOREIGN KEY (rider_id) REFERENCES public.riders(id),
  CONSTRAINT orders_core_customer_id_fkey FOREIGN KEY (customer_id) REFERENCES public.customers(id)
);
CREATE TABLE public.orders_food (
  id bigint NOT NULL DEFAULT nextval('orders_food_id_seq'::regclass),
  order_id bigint NOT NULL UNIQUE,
  merchant_store_id bigint,
  merchant_parent_id bigint,
  restaurant_name text,
  restaurant_phone text,
  preparation_time_minutes integer,
  food_items_count integer,
  food_items_total_value numeric,
  requires_utensils boolean DEFAULT false,
  is_fragile boolean NOT NULL DEFAULT false,
  is_high_value boolean NOT NULL DEFAULT false,
  veg_non_veg USER-DEFINED,
  delivery_instructions text,
  created_at timestamp with time zone NOT NULL DEFAULT now(),
  updated_at timestamp with time zone NOT NULL DEFAULT now(),
  CONSTRAINT orders_food_pkey PRIMARY KEY (id),
  CONSTRAINT orders_food_order_id_fkey FOREIGN KEY (order_id) REFERENCES public.orders_core(id),
  CONSTRAINT orders_food_merchant_store_id_fkey FOREIGN KEY (merchant_store_id) REFERENCES public.merchant_stores(id)
);
CREATE TABLE public.orders_parcel (
  id bigint NOT NULL DEFAULT nextval('orders_parcel_id_seq'::regclass),
  order_id bigint NOT NULL UNIQUE,
  weight_kg numeric,
  length_cm numeric,
  width_cm numeric,
  height_cm numeric,
  parcel_type text,
  declared_value numeric,
  insurance_required boolean NOT NULL DEFAULT false,
  insurance_amount numeric,
  is_cod boolean DEFAULT false,
  cod_amount numeric,
  requires_signature boolean DEFAULT false,
  requires_otp_verification boolean DEFAULT false,
  instructions text,
  scheduled_pickup_time timestamp with time zone,
  scheduled_delivery_time timestamp with time zone,
  created_at timestamp with time zone NOT NULL DEFAULT now(),
  updated_at timestamp with time zone NOT NULL DEFAULT now(),
  CONSTRAINT orders_parcel_pkey PRIMARY KEY (id),
  CONSTRAINT orders_parcel_order_id_fkey FOREIGN KEY (order_id) REFERENCES public.orders_core(id)
);
CREATE TABLE public.orders_ride (
  id bigint NOT NULL DEFAULT nextval('orders_ride_id_seq'::regclass),
  order_id bigint NOT NULL UNIQUE,
  passenger_name text,
  passenger_phone text,
  passenger_count integer DEFAULT 1,
  ride_type text,
  vehicle_type_required text,
  waiting_charges numeric DEFAULT 0,
  toll_charges numeric DEFAULT 0,
  parking_charges numeric DEFAULT 0,
  scheduled_ride boolean DEFAULT false,
  scheduled_pickup_time timestamp with time zone,
  return_trip boolean DEFAULT false,
  return_pickup_address text,
  return_pickup_lat numeric,
  return_pickup_lon numeric,
  return_pickup_time timestamp with time zone,
  created_at timestamp with time zone NOT NULL DEFAULT now(),
  updated_at timestamp with time zone NOT NULL DEFAULT now(),
  CONSTRAINT orders_ride_pkey PRIMARY KEY (id),
  CONSTRAINT orders_ride_order_id_fkey FOREIGN KEY (order_id) REFERENCES public.orders_core(id)
);
CREATE TABLE public.otp_verification_logs (
  id bigint NOT NULL DEFAULT nextval('otp_verification_logs_id_seq'::regclass),
  phone_e164 text NOT NULL,
  otp_hash text NOT NULL,
  status text NOT NULL,
  provider text NOT NULL,
  attempts_count integer NOT NULL DEFAULT 0,
  max_attempts integer NOT NULL DEFAULT 5,
  ip_address text,
  user_agent text,
  device_id text,
  expires_at timestamp with time zone NOT NULL,
  verified_at timestamp with time zone,
  created_at timestamp with time zone NOT NULL DEFAULT now(),
  CONSTRAINT otp_verification_logs_pkey PRIMARY KEY (id)
);
CREATE TABLE public.parcel_tracking_events (
  id bigint NOT NULL DEFAULT nextval('parcel_tracking_events_id_seq'::regclass),
  order_id bigint NOT NULL,
  event_type text NOT NULL,
  location text,
  lat double precision,
  lon double precision,
  status_description text,
  handled_by text,
  proof_url text,
  created_at timestamp with time zone NOT NULL DEFAULT now(),
  CONSTRAINT parcel_tracking_events_pkey PRIMARY KEY (id),
  CONSTRAINT parcel_tracking_events_order_id_fkey FOREIGN KEY (order_id) REFERENCES public.orders(id)
);
CREATE TABLE public.payment_access_controls (
  id bigint NOT NULL DEFAULT nextval('payment_access_controls_id_seq'::regclass),
  system_user_id bigint NOT NULL UNIQUE,
  can_view_all_payments boolean DEFAULT false,
  can_view_payment_details boolean DEFAULT false,
  can_view_gateway_response boolean DEFAULT false,
  can_process_refund boolean DEFAULT false,
  can_approve_refund boolean DEFAULT false,
  can_cancel_payment boolean DEFAULT false,
  can_retry_payment boolean DEFAULT false,
  refund_approval_limit numeric DEFAULT 0,
  daily_refund_limit numeric DEFAULT 0,
  created_at timestamp with time zone NOT NULL DEFAULT now(),
  updated_at timestamp with time zone NOT NULL DEFAULT now(),
  CONSTRAINT payment_access_controls_pkey PRIMARY KEY (id),
  CONSTRAINT payment_access_controls_system_user_id_fkey FOREIGN KEY (system_user_id) REFERENCES public.system_users(id)
);
CREATE TABLE public.payment_webhooks (
  id bigint NOT NULL DEFAULT nextval('payment_webhooks_id_seq'::regclass),
  provider text NOT NULL,
  webhook_id text,
  event_type text NOT NULL,
  payload jsonb NOT NULL,
  signature text,
  signature_verified boolean DEFAULT false,
  processing_status text NOT NULL DEFAULT 'pending'::text,
  retry_count integer DEFAULT 0,
  max_retries integer DEFAULT 3,
  error_message text,
  processed_at timestamp with time zone,
  created_at timestamp with time zone NOT NULL DEFAULT now(),
  CONSTRAINT payment_webhooks_pkey PRIMARY KEY (id)
);
CREATE TABLE public.payout_access_controls (
  id bigint NOT NULL DEFAULT nextval('payout_access_controls_id_seq'::regclass),
  system_user_id bigint NOT NULL UNIQUE,
  can_view_all_payouts boolean DEFAULT false,
  can_view_payout_details boolean DEFAULT false,
  can_view_bank_details boolean DEFAULT false,
  can_process_merchant_payout boolean DEFAULT false,
  can_process_rider_payout boolean DEFAULT false,
  can_approve_payout boolean DEFAULT false,
  can_reject_payout boolean DEFAULT false,
  can_hold_payout boolean DEFAULT false,
  merchant_payout_approval_limit numeric DEFAULT 0,
  rider_payout_approval_limit numeric DEFAULT 0,
  daily_payout_limit numeric DEFAULT 0,
  created_at timestamp with time zone NOT NULL DEFAULT now(),
  updated_at timestamp with time zone NOT NULL DEFAULT now(),
  CONSTRAINT payout_access_controls_pkey PRIMARY KEY (id),
  CONSTRAINT payout_access_controls_system_user_id_fkey FOREIGN KEY (system_user_id) REFERENCES public.system_users(id)
);
CREATE TABLE public.permission_change_logs (
  id bigint NOT NULL DEFAULT nextval('permission_change_logs_id_seq'::regclass),
  target_user_id bigint NOT NULL,
  target_user_name text,
  change_type text NOT NULL,
  role_id bigint,
  role_name text,
  permission_id bigint,
  permission_name text,
  changed_by bigint NOT NULL,
  changed_by_name text,
  change_reason text,
  access_before jsonb,
  access_after jsonb,
  created_at timestamp with time zone NOT NULL DEFAULT now(),
  CONSTRAINT permission_change_logs_pkey PRIMARY KEY (id),
  CONSTRAINT permission_change_logs_target_user_id_fkey FOREIGN KEY (target_user_id) REFERENCES public.system_users(id),
  CONSTRAINT permission_change_logs_role_id_fkey FOREIGN KEY (role_id) REFERENCES public.system_roles(id),
  CONSTRAINT permission_change_logs_permission_id_fkey FOREIGN KEY (permission_id) REFERENCES public.system_permissions(id),
  CONSTRAINT permission_change_logs_changed_by_fkey FOREIGN KEY (changed_by) REFERENCES public.system_users(id)
);
CREATE TABLE public.permissions (
  id bigint NOT NULL DEFAULT nextval('permissions_id_seq'::regclass),
  permission_code text NOT NULL UNIQUE,
  permission_name text NOT NULL,
  permission_description text,
  permission_category text NOT NULL,
  resource_type text NOT NULL,
  action_type text NOT NULL,
  service_type ARRAY,
  ticket_section ARRAY,
  is_active boolean DEFAULT true,
  created_at timestamp with time zone NOT NULL DEFAULT now(),
  updated_at timestamp with time zone NOT NULL DEFAULT now(),
  CONSTRAINT permissions_pkey PRIMARY KEY (id)
);
CREATE TABLE public.provider_commission_rules (
  id bigint NOT NULL DEFAULT nextval('provider_commission_rules_id_seq'::regclass),
  provider_type USER-DEFINED NOT NULL,
  order_type USER-DEFINED NOT NULL,
  commission_type text NOT NULL,
  commission_value numeric NOT NULL,
  min_order_value numeric,
  max_order_value numeric,
  city text,
  effective_from timestamp with time zone NOT NULL,
  effective_to timestamp with time zone,
  created_by integer,
  created_at timestamp with time zone NOT NULL DEFAULT now(),
  CONSTRAINT provider_commission_rules_pkey PRIMARY KEY (id)
);
CREATE TABLE public.provider_configs (
  id bigint NOT NULL DEFAULT nextval('provider_configs_id_seq'::regclass),
  provider_type USER-DEFINED NOT NULL UNIQUE,
  provider_name text NOT NULL,
  api_base_url text,
  api_key text,
  api_secret text,
  webhook_secret text,
  webhook_url text,
  auth_token text,
  refresh_token text,
  token_expires_at timestamp with time zone,
  status USER-DEFINED NOT NULL DEFAULT 'active'::integration_status,
  rate_limit_per_minute integer DEFAULT 60,
  rate_limit_per_hour integer DEFAULT 1000,
  metadata jsonb DEFAULT '{}'::jsonb,
  created_at timestamp with time zone NOT NULL DEFAULT now(),
  updated_at timestamp with time zone NOT NULL DEFAULT now(),
  CONSTRAINT provider_configs_pkey PRIMARY KEY (id)
);
CREATE TABLE public.provider_order_analytics (
  id bigint NOT NULL DEFAULT nextval('provider_order_analytics_id_seq'::regclass),
  order_id bigint NOT NULL,
  provider_type USER-DEFINED NOT NULL,
  time_to_assign_seconds integer,
  time_to_accept_seconds integer,
  time_to_pickup_seconds integer,
  time_to_delivery_seconds integer,
  total_duration_seconds integer,
  estimated_distance_km numeric,
  actual_distance_km numeric,
  distance_variance numeric,
  provider_commission_rate numeric,
  rider_earning_rate numeric,
  platform_margin numeric,
  customer_rating numeric,
  rider_rating numeric,
  cancellation_reason text,
  provider_estimated_time_minutes integer,
  actual_time_minutes integer,
  time_variance_minutes integer,
  analytics_metadata jsonb DEFAULT '{}'::jsonb,
  calculated_at timestamp with time zone NOT NULL DEFAULT now(),
  CONSTRAINT provider_order_analytics_pkey PRIMARY KEY (id),
  CONSTRAINT provider_order_analytics_order_id_fkey FOREIGN KEY (order_id) REFERENCES public.orders(id)
);
CREATE TABLE public.provider_order_conflicts (
  id bigint NOT NULL DEFAULT nextval('provider_order_conflicts_id_seq'::regclass),
  order_id bigint NOT NULL,
  provider_type USER-DEFINED NOT NULL,
  conflict_type text NOT NULL,
  conflict_field text,
  internal_value jsonb NOT NULL,
  provider_value jsonb NOT NULL,
  resolution_strategy text DEFAULT 'manual_review'::text,
  resolved boolean DEFAULT false,
  resolved_by integer,
  resolved_at timestamp with time zone,
  resolution_notes text,
  resolution_action text,
  conflict_metadata jsonb DEFAULT '{}'::jsonb,
  created_at timestamp with time zone NOT NULL DEFAULT now(),
  updated_at timestamp with time zone NOT NULL DEFAULT now(),
  CONSTRAINT provider_order_conflicts_pkey PRIMARY KEY (id),
  CONSTRAINT provider_order_conflicts_order_id_fkey FOREIGN KEY (order_id) REFERENCES public.orders(id)
);
CREATE TABLE public.provider_order_item_mapping (
  id bigint NOT NULL DEFAULT nextval('provider_order_item_mapping_id_seq'::regclass),
  order_id bigint NOT NULL,
  order_item_id bigint,
  provider_type USER-DEFINED NOT NULL,
  provider_item_id text NOT NULL,
  provider_menu_id text,
  provider_item_name text,
  provider_item_price numeric,
  provider_item_quantity integer,
  provider_item_total numeric,
  provider_metadata jsonb DEFAULT '{}'::jsonb,
  created_at timestamp with time zone NOT NULL DEFAULT now(),
  updated_at timestamp with time zone NOT NULL DEFAULT now(),
  CONSTRAINT provider_order_item_mapping_pkey PRIMARY KEY (id),
  CONSTRAINT provider_order_item_mapping_order_id_fkey FOREIGN KEY (order_id) REFERENCES public.orders(id),
  CONSTRAINT provider_order_item_mapping_order_item_id_fkey FOREIGN KEY (order_item_id) REFERENCES public.order_items(id)
);
CREATE TABLE public.provider_order_mapping (
  id bigint NOT NULL DEFAULT nextval('provider_order_mapping_id_seq'::regclass),
  order_id bigint NOT NULL,
  provider_type USER-DEFINED NOT NULL,
  provider_order_id text NOT NULL,
  provider_reference text,
  provider_status text,
  provider_fare_amount numeric,
  provider_commission numeric,
  synced_at timestamp with time zone,
  last_sync_at timestamp with time zone,
  sync_status text DEFAULT 'pending'::text,
  sync_error text,
  metadata jsonb DEFAULT '{}'::jsonb,
  created_at timestamp with time zone NOT NULL DEFAULT now(),
  updated_at timestamp with time zone NOT NULL DEFAULT now(),
  CONSTRAINT provider_order_mapping_pkey PRIMARY KEY (id),
  CONSTRAINT provider_order_mapping_order_id_fkey FOREIGN KEY (order_id) REFERENCES public.orders(id)
);
CREATE TABLE public.provider_order_payment_mapping (
  id bigint NOT NULL DEFAULT nextval('provider_order_payment_mapping_id_seq'::regclass),
  order_id bigint NOT NULL,
  order_payment_id bigint,
  provider_type USER-DEFINED NOT NULL,
  provider_payment_id text NOT NULL,
  provider_transaction_id text,
  provider_payment_status text,
  provider_payment_amount numeric,
  provider_payment_method text,
  provider_payment_gateway text,
  synced_at timestamp with time zone,
  sync_status text DEFAULT 'pending'::text,
  sync_error text,
  provider_metadata jsonb DEFAULT '{}'::jsonb,
  created_at timestamp with time zone NOT NULL DEFAULT now(),
  updated_at timestamp with time zone NOT NULL DEFAULT now(),
  CONSTRAINT provider_order_payment_mapping_pkey PRIMARY KEY (id),
  CONSTRAINT provider_order_payment_mapping_order_id_fkey FOREIGN KEY (order_id) REFERENCES public.orders(id),
  CONSTRAINT provider_order_payment_mapping_order_payment_id_fkey FOREIGN KEY (order_payment_id) REFERENCES public.order_payments(id)
);
CREATE TABLE public.provider_order_refund_mapping (
  id bigint NOT NULL DEFAULT nextval('provider_order_refund_mapping_id_seq'::regclass),
  order_id bigint NOT NULL,
  order_refund_id bigint,
  provider_type USER-DEFINED NOT NULL,
  provider_refund_id text NOT NULL,
  provider_refund_transaction_id text,
  provider_refund_status text,
  provider_refund_amount numeric,
  provider_refund_reason text,
  synced_at timestamp with time zone,
  sync_status text DEFAULT 'pending'::text,
  sync_error text,
  provider_metadata jsonb DEFAULT '{}'::jsonb,
  created_at timestamp with time zone NOT NULL DEFAULT now(),
  updated_at timestamp with time zone NOT NULL DEFAULT now(),
  CONSTRAINT provider_order_refund_mapping_pkey PRIMARY KEY (id),
  CONSTRAINT provider_order_refund_mapping_order_id_fkey FOREIGN KEY (order_id) REFERENCES public.orders(id),
  CONSTRAINT provider_order_refund_mapping_order_refund_id_fkey FOREIGN KEY (order_refund_id) REFERENCES public.order_refunds(id)
);
CREATE TABLE public.provider_order_status_sync (
  id bigint NOT NULL DEFAULT nextval('provider_order_status_sync_id_seq'::regclass),
  order_id bigint NOT NULL,
  provider_type USER-DEFINED NOT NULL,
  sync_direction text NOT NULL,
  sync_type text NOT NULL,
  internal_status USER-DEFINED,
  provider_status text,
  previous_internal_status USER-DEFINED,
  previous_provider_status text,
  rider_assignment_id bigint,
  provider_rider_id text,
  success boolean DEFAULT false,
  error_message text,
  error_code text,
  retry_count integer DEFAULT 0,
  request_payload jsonb DEFAULT '{}'::jsonb,
  response_payload jsonb DEFAULT '{}'::jsonb,
  response_status_code integer,
  sync_metadata jsonb DEFAULT '{}'::jsonb,
  created_at timestamp with time zone NOT NULL DEFAULT now(),
  CONSTRAINT provider_order_status_sync_pkey PRIMARY KEY (id),
  CONSTRAINT provider_order_status_sync_order_id_fkey FOREIGN KEY (order_id) REFERENCES public.orders(id),
  CONSTRAINT provider_order_status_sync_rider_assignment_id_fkey FOREIGN KEY (rider_assignment_id) REFERENCES public.order_rider_assignments(id)
);
CREATE TABLE public.provider_rate_limits (
  id bigint NOT NULL DEFAULT nextval('provider_rate_limits_id_seq'::regclass),
  provider_type USER-DEFINED NOT NULL,
  endpoint text NOT NULL,
  request_count integer NOT NULL DEFAULT 1,
  window_start timestamp with time zone NOT NULL,
  window_end timestamp with time zone NOT NULL,
  limit_exceeded boolean DEFAULT false,
  created_at timestamp with time zone NOT NULL DEFAULT now(),
  updated_at timestamp with time zone NOT NULL DEFAULT now(),
  CONSTRAINT provider_rate_limits_pkey PRIMARY KEY (id)
);
CREATE TABLE public.provider_rider_mapping (
  id bigint NOT NULL DEFAULT nextval('provider_rider_mapping_id_seq'::regclass),
  rider_id integer NOT NULL,
  provider_type USER-DEFINED NOT NULL,
  provider_rider_id text NOT NULL,
  provider_rider_name text,
  provider_rider_phone text,
  provider_rider_email text,
  provider_vehicle_type text,
  provider_vehicle_number text,
  provider_vehicle_model text,
  provider_rider_status text,
  is_verified boolean DEFAULT false,
  verification_date timestamp with time zone,
  provider_metadata jsonb DEFAULT '{}'::jsonb,
  synced_at timestamp with time zone,
  last_sync_at timestamp with time zone,
  sync_status text DEFAULT 'pending'::text,
  created_at timestamp with time zone NOT NULL DEFAULT now(),
  updated_at timestamp with time zone NOT NULL DEFAULT now(),
  CONSTRAINT provider_rider_mapping_pkey PRIMARY KEY (id),
  CONSTRAINT provider_rider_mapping_rider_id_fkey FOREIGN KEY (rider_id) REFERENCES public.riders(id)
);
CREATE TABLE public.ratings (
  id bigint NOT NULL DEFAULT nextval('ratings_id_seq'::regclass),
  rider_id integer NOT NULL,
  order_id bigint,
  from_type USER-DEFINED NOT NULL,
  from_id integer,
  rating smallint NOT NULL CHECK (rating >= 1 AND rating <= 5),
  comment text,
  metadata jsonb DEFAULT '{}'::jsonb,
  created_at timestamp with time zone NOT NULL DEFAULT now(),
  CONSTRAINT ratings_pkey PRIMARY KEY (id),
  CONSTRAINT ratings_rider_id_fkey FOREIGN KEY (rider_id) REFERENCES public.riders(id),
  CONSTRAINT ratings_order_id_fkey FOREIGN KEY (order_id) REFERENCES public.orders(id)
);
CREATE TABLE public.referral_fulfillments (
  id bigint NOT NULL DEFAULT nextval('referral_fulfillments_id_seq'::regclass),
  referral_id bigint NOT NULL UNIQUE,
  offer_id bigint NOT NULL,
  referrer_rider_id integer NOT NULL,
  referred_rider_id integer NOT NULL,
  status USER-DEFINED NOT NULL DEFAULT 'pending'::referral_fulfillment_status,
  min_orders_required integer NOT NULL DEFAULT 0,
  orders_completed_by_referred integer NOT NULL DEFAULT 0,
  orders_completed_food integer NOT NULL DEFAULT 0,
  orders_completed_parcel integer NOT NULL DEFAULT 0,
  orders_completed_person_ride integer NOT NULL DEFAULT 0,
  amount_credited numeric NOT NULL DEFAULT 0,
  amount_credited_food numeric NOT NULL DEFAULT 0,
  amount_credited_parcel numeric NOT NULL DEFAULT 0,
  amount_credited_person_ride numeric NOT NULL DEFAULT 0,
  wallet_ledger_id bigint,
  credited_at timestamp with time zone,
  fulfilled_at timestamp with time zone,
  city_id bigint,
  city_name text,
  terms_snapshot jsonb DEFAULT '{}'::jsonb,
  created_at timestamp with time zone NOT NULL DEFAULT now(),
  updated_at timestamp with time zone NOT NULL DEFAULT now(),
  CONSTRAINT referral_fulfillments_pkey PRIMARY KEY (id),
  CONSTRAINT referral_fulfillments_referral_id_fkey FOREIGN KEY (referral_id) REFERENCES public.referrals(id),
  CONSTRAINT referral_fulfillments_offer_id_fkey FOREIGN KEY (offer_id) REFERENCES public.referral_offers(id),
  CONSTRAINT referral_fulfillments_referrer_rider_id_fkey FOREIGN KEY (referrer_rider_id) REFERENCES public.riders(id),
  CONSTRAINT referral_fulfillments_referred_rider_id_fkey FOREIGN KEY (referred_rider_id) REFERENCES public.riders(id),
  CONSTRAINT referral_fulfillments_city_id_fkey FOREIGN KEY (city_id) REFERENCES public.cities(id)
);
CREATE TABLE public.referral_offer_city_rules (
  id bigint NOT NULL DEFAULT nextval('referral_offer_city_rules_id_seq'::regclass),
  offer_id bigint NOT NULL,
  city_id bigint NOT NULL,
  amount numeric,
  min_orders_per_referred integer,
  max_referrals_per_referrer integer,
  terms_and_conditions text,
  terms_snapshot jsonb DEFAULT '{}'::jsonb,
  created_at timestamp with time zone NOT NULL DEFAULT now(),
  updated_at timestamp with time zone NOT NULL DEFAULT now(),
  CONSTRAINT referral_offer_city_rules_pkey PRIMARY KEY (id),
  CONSTRAINT referral_offer_city_rules_offer_id_fkey FOREIGN KEY (offer_id) REFERENCES public.referral_offers(id),
  CONSTRAINT referral_offer_city_rules_city_id_fkey FOREIGN KEY (city_id) REFERENCES public.cities(id)
);
CREATE TABLE public.referral_offers (
  id bigint NOT NULL DEFAULT nextval('referral_offers_id_seq'::regclass),
  offer_code text NOT NULL UNIQUE,
  name text NOT NULL,
  description text,
  offer_type USER-DEFINED NOT NULL DEFAULT 'fixed_per_referral'::referral_offer_type,
  amount numeric,
  amount_config jsonb NOT NULL DEFAULT '{}'::jsonb,
  service_types ARRAY DEFAULT '{}'::text[],
  min_orders_per_referred integer NOT NULL DEFAULT 0,
  min_referred_count integer NOT NULL DEFAULT 1,
  max_referrals_per_referrer integer,
  terms_and_conditions text,
  terms_snapshot jsonb DEFAULT '{}'::jsonb,
  valid_from timestamp with time zone,
  valid_to timestamp with time zone,
  city_ids ARRAY,
  is_active boolean NOT NULL DEFAULT true,
  created_by bigint,
  created_at timestamp with time zone NOT NULL DEFAULT now(),
  updated_at timestamp with time zone NOT NULL DEFAULT now(),
  CONSTRAINT referral_offers_pkey PRIMARY KEY (id),
  CONSTRAINT referral_offers_created_by_fkey FOREIGN KEY (created_by) REFERENCES public.system_users(id)
);
CREATE TABLE public.referrals (
  id bigint NOT NULL DEFAULT nextval('referrals_id_seq'::regclass),
  referrer_id integer NOT NULL,
  referred_id integer NOT NULL UNIQUE,
  referrer_reward numeric,
  referred_reward numeric,
  referrer_reward_paid boolean NOT NULL DEFAULT false,
  referred_reward_paid boolean NOT NULL DEFAULT false,
  metadata jsonb DEFAULT '{}'::jsonb,
  created_at timestamp with time zone NOT NULL DEFAULT now(),
  offer_id bigint,
  referral_code_used text,
  referred_city_id bigint,
  referred_city_name text,
  CONSTRAINT referrals_pkey PRIMARY KEY (id),
  CONSTRAINT referrals_referrer_id_fkey FOREIGN KEY (referrer_id) REFERENCES public.riders(id),
  CONSTRAINT referrals_referred_id_fkey FOREIGN KEY (referred_id) REFERENCES public.riders(id),
  CONSTRAINT referrals_offer_id_fkey FOREIGN KEY (offer_id) REFERENCES public.referral_offers(id),
  CONSTRAINT referrals_referred_city_id_fkey FOREIGN KEY (referred_city_id) REFERENCES public.cities(id)
);
CREATE TABLE public.refund_access_controls (
  id bigint NOT NULL DEFAULT nextval('refund_access_controls_id_seq'::regclass),
  system_user_id bigint NOT NULL UNIQUE,
  can_process_full_refund boolean DEFAULT false,
  can_process_partial_refund boolean DEFAULT false,
  can_process_item_refund boolean DEFAULT false,
  can_approve_customer_refund boolean DEFAULT false,
  can_approve_merchant_refund boolean DEFAULT false,
  can_approve_rider_refund boolean DEFAULT false,
  full_refund_approval_limit numeric DEFAULT 0,
  partial_refund_approval_limit numeric DEFAULT 0,
  daily_refund_approval_limit numeric DEFAULT 0,
  can_auto_approve_under_limit boolean DEFAULT false,
  auto_approval_limit numeric DEFAULT 0,
  created_at timestamp with time zone NOT NULL DEFAULT now(),
  updated_at timestamp with time zone NOT NULL DEFAULT now(),
  CONSTRAINT refund_access_controls_pkey PRIMARY KEY (id),
  CONSTRAINT refund_access_controls_system_user_id_fkey FOREIGN KEY (system_user_id) REFERENCES public.system_users(id)
);
CREATE TABLE public.ride_fare_breakdown (
  id bigint NOT NULL DEFAULT nextval('ride_fare_breakdown_id_seq'::regclass),
  order_id bigint NOT NULL,
  base_fare numeric NOT NULL CHECK (base_fare >= 0::numeric),
  distance_fare numeric DEFAULT 0 CHECK (distance_fare >= 0::numeric),
  time_fare numeric DEFAULT 0 CHECK (time_fare >= 0::numeric),
  surge_multiplier numeric DEFAULT 1.0 CHECK (surge_multiplier >= 1.0),
  surge_amount numeric DEFAULT 0,
  toll_charges numeric DEFAULT 0,
  parking_charges numeric DEFAULT 0,
  waiting_charges numeric DEFAULT 0,
  night_charges numeric DEFAULT 0,
  gst_amount numeric DEFAULT 0,
  discount_amount numeric DEFAULT 0,
  total_fare numeric NOT NULL CHECK (total_fare > 0::numeric),
  rider_earning numeric NOT NULL CHECK (rider_earning >= 0::numeric),
  commission_amount numeric NOT NULL,
  created_at timestamp with time zone NOT NULL DEFAULT now(),
  CONSTRAINT ride_fare_breakdown_pkey PRIMARY KEY (id),
  CONSTRAINT ride_fare_breakdown_order_id_fkey FOREIGN KEY (order_id) REFERENCES public.orders(id)
);
CREATE TABLE public.ride_routes (
  id bigint NOT NULL DEFAULT nextval('ride_routes_id_seq'::regclass),
  order_id bigint NOT NULL,
  waypoint_order integer NOT NULL,
  address text NOT NULL,
  lat double precision NOT NULL,
  lon double precision NOT NULL,
  arrived_at timestamp with time zone,
  departed_at timestamp with time zone,
  waiting_time_seconds integer DEFAULT 0,
  created_at timestamp with time zone NOT NULL DEFAULT now(),
  CONSTRAINT ride_routes_pkey PRIMARY KEY (id),
  CONSTRAINT ride_routes_order_id_fkey FOREIGN KEY (order_id) REFERENCES public.orders(id)
);
CREATE TABLE public.rider_activity_daily (
  rider_id integer NOT NULL,
  activity_date date NOT NULL,
  service_type text NOT NULL CHECK (service_type = ANY (ARRAY['food'::text, 'parcel'::text, 'person_ride'::text])),
  total_login_seconds integer NOT NULL DEFAULT 0,
  first_login_at timestamp with time zone,
  last_logout_at timestamp with time zone,
  orders_completed integer NOT NULL DEFAULT 0,
  orders_cancelled integer NOT NULL DEFAULT 0,
  earnings_orders numeric NOT NULL DEFAULT 0,
  earnings_offers numeric NOT NULL DEFAULT 0,
  earnings_incentives numeric NOT NULL DEFAULT 0,
  created_at timestamp with time zone NOT NULL DEFAULT now(),
  updated_at timestamp with time zone NOT NULL DEFAULT now(),
  CONSTRAINT rider_activity_daily_pkey PRIMARY KEY (rider_id, activity_date, service_type),
  CONSTRAINT rider_activity_daily_rider_id_fkey FOREIGN KEY (rider_id) REFERENCES public.riders(id)
);
CREATE TABLE public.rider_activity_sessions (
  id bigint NOT NULL DEFAULT nextval('rider_activity_sessions_id_seq'::regclass),
  rider_id integer NOT NULL,
  service_type text NOT NULL CHECK (service_type = ANY (ARRAY['food'::text, 'parcel'::text, 'person_ride'::text])),
  started_at timestamp with time zone NOT NULL,
  ended_at timestamp with time zone,
  created_at timestamp with time zone NOT NULL DEFAULT now(),
  CONSTRAINT rider_activity_sessions_pkey PRIMARY KEY (id),
  CONSTRAINT rider_activity_sessions_rider_id_fkey FOREIGN KEY (rider_id) REFERENCES public.riders(id)
);
CREATE TABLE public.rider_addresses (
  id bigint NOT NULL DEFAULT nextval('rider_addresses_id_seq'::regclass),
  rider_id integer NOT NULL,
  address_type USER-DEFINED NOT NULL DEFAULT 'registered'::rider_address_type,
  full_address text NOT NULL,
  city_id bigint,
  state text,
  pincode text,
  latitude numeric,
  longitude numeric,
  is_primary boolean NOT NULL DEFAULT false,
  created_at timestamp with time zone NOT NULL DEFAULT now(),
  updated_at timestamp with time zone NOT NULL DEFAULT now(),
  CONSTRAINT rider_addresses_pkey PRIMARY KEY (id),
  CONSTRAINT rider_addresses_rider_id_fkey FOREIGN KEY (rider_id) REFERENCES public.riders(id),
  CONSTRAINT rider_addresses_city_id_fkey FOREIGN KEY (city_id) REFERENCES public.cities(id)
);
CREATE TABLE public.rider_daily_analytics (
  id bigint NOT NULL DEFAULT nextval('rider_daily_analytics_id_seq'::regclass),
  rider_id integer NOT NULL,
  date date NOT NULL,
  total_orders integer NOT NULL DEFAULT 0,
  completed integer NOT NULL DEFAULT 0,
  cancelled integer NOT NULL DEFAULT 0,
  acceptance_rate numeric,
  earnings_total numeric NOT NULL DEFAULT 0,
  penalties_total numeric NOT NULL DEFAULT 0,
  duty_hours numeric,
  avg_rating numeric,
  metadata jsonb DEFAULT '{}'::jsonb,
  created_at timestamp with time zone NOT NULL DEFAULT now(),
  CONSTRAINT rider_daily_analytics_pkey PRIMARY KEY (id),
  CONSTRAINT rider_daily_analytics_rider_id_fkey FOREIGN KEY (rider_id) REFERENCES public.riders(id)
);
CREATE TABLE public.rider_devices (
  id bigint NOT NULL DEFAULT nextval('rider_devices_id_seq'::regclass),
  rider_id integer NOT NULL,
  device_id text NOT NULL,
  ip_address text,
  sim_id text,
  model text,
  os_version text,
  fcm_token text,
  allowed boolean NOT NULL DEFAULT true,
  last_seen timestamp with time zone NOT NULL DEFAULT now(),
  created_at timestamp with time zone NOT NULL DEFAULT now(),
  CONSTRAINT rider_devices_pkey PRIMARY KEY (id),
  CONSTRAINT rider_devices_rider_id_fkey FOREIGN KEY (rider_id) REFERENCES public.riders(id)
);
CREATE TABLE public.rider_document_files (
  id bigint NOT NULL DEFAULT nextval('rider_document_files_id_seq'::regclass),
  document_id bigint NOT NULL,
  file_url text NOT NULL,
  r2_key text,
  side USER-DEFINED NOT NULL DEFAULT 'single'::document_file_side,
  mime_type text,
  sort_order integer DEFAULT 0,
  created_at timestamp with time zone NOT NULL DEFAULT now(),
  CONSTRAINT rider_document_files_pkey PRIMARY KEY (id),
  CONSTRAINT rider_document_files_document_id_fkey FOREIGN KEY (document_id) REFERENCES public.rider_documents(id)
);
CREATE TABLE public.rider_documents (
  id bigint NOT NULL DEFAULT nextval('rider_documents_id_seq'::regclass),
  rider_id integer NOT NULL,
  doc_type USER-DEFINED NOT NULL,
  file_url text NOT NULL,
  extracted_name text,
  extracted_dob date,
  verified boolean NOT NULL DEFAULT false,
  verifier_user_id integer,
  rejected_reason text,
  metadata jsonb DEFAULT '{}'::jsonb,
  created_at timestamp with time zone NOT NULL DEFAULT now(),
  r2_key text,
  doc_number text,
  verification_method USER-DEFINED NOT NULL DEFAULT 'MANUAL_UPLOAD'::verification_method,
  vehicle_id bigint,
  verification_status USER-DEFINED DEFAULT 'pending'::document_verification_status,
  expiry_date date,
  verified_at timestamp with time zone,
  verified_by bigint,
  updated_at timestamp with time zone NOT NULL DEFAULT now(),
  created_by integer,
  updated_by integer,
  fraud_flags jsonb DEFAULT '{}'::jsonb,
  duplicate_document_id bigint,
  requires_manual_review boolean NOT NULL DEFAULT false,
  CONSTRAINT rider_documents_pkey PRIMARY KEY (id),
  CONSTRAINT rider_documents_rider_id_fkey FOREIGN KEY (rider_id) REFERENCES public.riders(id),
  CONSTRAINT rider_documents_verified_by_fkey FOREIGN KEY (verified_by) REFERENCES public.system_users(id),
  CONSTRAINT rider_documents_duplicate_document_id_fkey FOREIGN KEY (duplicate_document_id) REFERENCES public.rider_documents(id),
  CONSTRAINT rider_documents_vehicle_id_rider_vehicles_id_fk FOREIGN KEY (vehicle_id) REFERENCES public.rider_vehicles(id)
);
CREATE TABLE public.rider_management_access (
  id bigint NOT NULL DEFAULT nextval('rider_management_access_id_seq'::regclass),
  system_user_id bigint NOT NULL UNIQUE,
  can_view_all_riders boolean DEFAULT false,
  can_view_assigned_riders boolean DEFAULT true,
  can_view_rider_financial boolean DEFAULT false,
  can_view_rider_documents boolean DEFAULT false,
  can_update_onboarding boolean DEFAULT false,
  can_approve_documents boolean DEFAULT false,
  can_reject_documents boolean DEFAULT false,
  can_approve_rider boolean DEFAULT false,
  can_reject_rider boolean DEFAULT false,
  can_activate_rider boolean DEFAULT false,
  can_deactivate_rider boolean DEFAULT false,
  can_block_rider boolean DEFAULT false,
  can_unblock_rider boolean DEFAULT false,
  can_add_penalty boolean DEFAULT false,
  can_revert_penalty boolean DEFAULT false,
  can_adjust_wallet boolean DEFAULT false,
  can_approve_withdrawal boolean DEFAULT false,
  can_close_wallet boolean DEFAULT false,
  can_update_payment_info boolean DEFAULT false,
  can_assign_to_area boolean DEFAULT false,
  can_remove_from_area boolean DEFAULT false,
  penalty_approval_limit numeric DEFAULT 0,
  wallet_adjustment_limit numeric DEFAULT 0,
  withdrawal_approval_limit numeric DEFAULT 0,
  created_at timestamp with time zone NOT NULL DEFAULT now(),
  updated_at timestamp with time zone NOT NULL DEFAULT now(),
  CONSTRAINT rider_management_access_pkey PRIMARY KEY (id),
  CONSTRAINT rider_management_access_system_user_id_fkey FOREIGN KEY (system_user_id) REFERENCES public.system_users(id)
);
CREATE TABLE public.rider_negative_wallet_blocks (
  id bigint NOT NULL DEFAULT nextval('rider_negative_wallet_blocks_id_seq'::regclass),
  rider_id integer NOT NULL,
  service_type text NOT NULL CHECK (service_type = ANY (ARRAY['food'::text, 'parcel'::text, 'person_ride'::text])),
  reason text NOT NULL DEFAULT 'negative_wallet'::text,
  created_at timestamp with time zone NOT NULL DEFAULT now(),
  CONSTRAINT rider_negative_wallet_blocks_pkey PRIMARY KEY (id),
  CONSTRAINT rider_negative_wallet_blocks_rider_id_fkey FOREIGN KEY (rider_id) REFERENCES public.riders(id)
);
CREATE TABLE public.rider_payment_methods (
  id bigint NOT NULL DEFAULT nextval('rider_payment_methods_id_seq'::regclass),
  rider_id integer NOT NULL,
  method_type USER-DEFINED NOT NULL,
  account_holder_name text NOT NULL,
  bank_name text,
  ifsc text,
  branch text,
  account_number_encrypted text,
  upi_id text,
  verification_status USER-DEFINED NOT NULL DEFAULT 'pending'::payment_method_verification_status,
  verification_proof_type USER-DEFINED,
  proof_document_id bigint,
  verified_at timestamp with time zone,
  verified_by bigint,
  created_at timestamp with time zone NOT NULL DEFAULT now(),
  updated_at timestamp with time zone NOT NULL DEFAULT now(),
  deleted_at timestamp with time zone,
  CONSTRAINT rider_payment_methods_pkey PRIMARY KEY (id),
  CONSTRAINT rider_payment_methods_rider_id_fkey FOREIGN KEY (rider_id) REFERENCES public.riders(id),
  CONSTRAINT rider_payment_methods_proof_document_id_fkey FOREIGN KEY (proof_document_id) REFERENCES public.rider_documents(id),
  CONSTRAINT rider_payment_methods_verified_by_fkey FOREIGN KEY (verified_by) REFERENCES public.system_users(id)
);
CREATE TABLE public.rider_penalties (
  id bigint NOT NULL DEFAULT nextval('rider_penalties_id_seq'::regclass),
  rider_id integer NOT NULL,
  service_type USER-DEFINED NOT NULL,
  penalty_type USER-DEFINED NOT NULL,
  amount numeric NOT NULL,
  reason text NOT NULL,
  status USER-DEFINED NOT NULL DEFAULT 'active'::penalty_status,
  order_id bigint,
  imposed_by integer,
  imposed_at timestamp with time zone NOT NULL DEFAULT now(),
  resolved_at timestamp with time zone,
  resolution_notes text,
  metadata jsonb DEFAULT '{}'::jsonb,
  source text DEFAULT 'agent'::text,
  reversed_by integer,
  CONSTRAINT rider_penalties_pkey PRIMARY KEY (id),
  CONSTRAINT rider_penalties_rider_id_fkey FOREIGN KEY (rider_id) REFERENCES public.riders(id),
  CONSTRAINT rider_penalties_order_id_fkey FOREIGN KEY (order_id) REFERENCES public.orders(id),
  CONSTRAINT rider_penalties_imposed_by_fkey FOREIGN KEY (imposed_by) REFERENCES public.system_users(id),
  CONSTRAINT rider_penalties_reversed_by_fkey FOREIGN KEY (reversed_by) REFERENCES public.system_users(id)
);
CREATE TABLE public.rider_service_activation (
  id bigint NOT NULL DEFAULT nextval('rider_service_activation_id_seq'::regclass),
  rider_id integer NOT NULL,
  service_type_id bigint NOT NULL,
  status USER-DEFINED NOT NULL DEFAULT 'inactive'::service_activation_status,
  activated_at timestamp with time zone,
  deactivated_at timestamp with time zone,
  vehicle_id bigint,
  limitation_flags jsonb DEFAULT '{}'::jsonb,
  activated_by_rule_id bigint,
  created_at timestamp with time zone NOT NULL DEFAULT now(),
  updated_at timestamp with time zone NOT NULL DEFAULT now(),
  CONSTRAINT rider_service_activation_pkey PRIMARY KEY (id),
  CONSTRAINT rider_service_activation_rider_id_fkey FOREIGN KEY (rider_id) REFERENCES public.riders(id),
  CONSTRAINT rider_service_activation_service_type_id_fkey FOREIGN KEY (service_type_id) REFERENCES public.service_types(id),
  CONSTRAINT rider_service_activation_vehicle_id_fkey FOREIGN KEY (vehicle_id) REFERENCES public.rider_vehicles(id),
  CONSTRAINT rider_service_activation_activated_by_rule_id_fkey FOREIGN KEY (activated_by_rule_id) REFERENCES public.onboarding_rule_policies(id)
);
CREATE TABLE public.rider_vehicles (
  id bigint NOT NULL DEFAULT nextval('rider_vehicles_id_seq'::regclass),
  rider_id integer NOT NULL,
  vehicle_type USER-DEFINED NOT NULL,
  registration_number text NOT NULL,
  make text,
  model text,
  year integer,
  color text,
  insurance_expiry date,
  rc_document_url text,
  insurance_document_url text,
  verified boolean DEFAULT false,
  verified_at timestamp with time zone,
  verified_by integer,
  is_active boolean DEFAULT true,
  created_at timestamp with time zone NOT NULL DEFAULT now(),
  updated_at timestamp with time zone NOT NULL DEFAULT now(),
  vehicle_number text,
  fuel_type USER-DEFINED,
  vehicle_category USER-DEFINED,
  ac_type USER-DEFINED,
  service_types jsonb DEFAULT '[]'::jsonb,
  is_commercial boolean NOT NULL DEFAULT false,
  registration_state text,
  permit_expiry date,
  vehicle_active_status text NOT NULL DEFAULT 'active'::text,
  seating_capacity integer,
  deleted_at timestamp with time zone,
  deleted_by integer,
  created_by integer,
  updated_by integer,
  ownership_type text,
  limitation_flags jsonb DEFAULT '{}'::jsonb,
  CONSTRAINT rider_vehicles_pkey PRIMARY KEY (id),
  CONSTRAINT rider_vehicles_rider_id_fkey FOREIGN KEY (rider_id) REFERENCES public.riders(id)
);
CREATE TABLE public.rider_wallet (
  id bigint NOT NULL DEFAULT nextval('rider_wallet_id_seq'::regclass),
  rider_id integer NOT NULL UNIQUE,
  total_balance numeric NOT NULL DEFAULT 0,
  earnings_food numeric NOT NULL DEFAULT 0,
  earnings_parcel numeric NOT NULL DEFAULT 0,
  earnings_person_ride numeric NOT NULL DEFAULT 0,
  penalties_food numeric NOT NULL DEFAULT 0,
  penalties_parcel numeric NOT NULL DEFAULT 0,
  penalties_person_ride numeric NOT NULL DEFAULT 0,
  total_withdrawn numeric NOT NULL DEFAULT 0,
  last_updated_at timestamp with time zone NOT NULL DEFAULT now(),
  created_at timestamp with time zone NOT NULL DEFAULT now(),
  is_frozen boolean NOT NULL DEFAULT false,
  frozen_at timestamp with time zone,
  frozen_by_system_user_id integer,
  unblock_alloc_food numeric NOT NULL DEFAULT 0,
  unblock_alloc_parcel numeric NOT NULL DEFAULT 0,
  unblock_alloc_person_ride numeric NOT NULL DEFAULT 0,
  negative_used_food numeric NOT NULL DEFAULT 0,
  negative_used_parcel numeric NOT NULL DEFAULT 0,
  negative_used_person_ride numeric NOT NULL DEFAULT 0,
  CONSTRAINT rider_wallet_pkey PRIMARY KEY (id),
  CONSTRAINT rider_wallet_rider_id_fkey FOREIGN KEY (rider_id) REFERENCES public.riders(id),
  CONSTRAINT rider_wallet_frozen_by_system_user_id_fkey FOREIGN KEY (frozen_by_system_user_id) REFERENCES public.system_users(id)
);
CREATE TABLE public.rider_wallet_freeze_history (
  id bigint NOT NULL DEFAULT nextval('rider_wallet_freeze_history_id_seq'::regclass),
  rider_id integer NOT NULL,
  action text NOT NULL CHECK (action = ANY (ARRAY['freeze'::text, 'unfreeze'::text])),
  performed_by_system_user_id integer NOT NULL,
  reason text,
  created_at timestamp with time zone NOT NULL DEFAULT now(),
  CONSTRAINT rider_wallet_freeze_history_pkey PRIMARY KEY (id),
  CONSTRAINT rider_wallet_freeze_history_rider_id_fkey FOREIGN KEY (rider_id) REFERENCES public.riders(id),
  CONSTRAINT rider_wallet_freeze_history_performed_by_system_user_id_fkey FOREIGN KEY (performed_by_system_user_id) REFERENCES public.system_users(id)
);
CREATE TABLE public.riders (
  id integer GENERATED ALWAYS AS IDENTITY NOT NULL,
  mobile text NOT NULL UNIQUE,
  country_code text NOT NULL DEFAULT '+91'::text,
  name text,
  aadhaar_number text,
  pan_number text,
  dob date,
  selfie_url text,
  onboarding_stage USER-DEFINED NOT NULL DEFAULT 'MOBILE_VERIFIED'::onboarding_stage,
  kyc_status USER-DEFINED NOT NULL DEFAULT 'PENDING'::kyc_status,
  status USER-DEFINED NOT NULL DEFAULT 'INACTIVE'::rider_status,
  city text,
  state text,
  pincode text,
  address text,
  lat double precision CHECK (lat IS NULL OR lat >= '-90'::integer::double precision AND lat <= 90::double precision),
  lon double precision CHECK (lon IS NULL OR lon >= '-180'::integer::double precision AND lon <= 180::double precision),
  referral_code text UNIQUE,
  referred_by integer,
  default_language text NOT NULL DEFAULT 'en'::text,
  created_at timestamp with time zone NOT NULL DEFAULT now(),
  updated_at timestamp with time zone NOT NULL DEFAULT now(),
  vehicle_choice text,
  preferred_service_types jsonb DEFAULT '[]'::jsonb,
  deleted_at timestamp with time zone,
  deleted_by integer,
  created_by integer,
  updated_by integer,
  area_manager_id integer,
  locality_code text,
  availability_status USER-DEFINED NOT NULL DEFAULT 'OFFLINE'::rider_availability_status,
  CONSTRAINT riders_pkey PRIMARY KEY (id),
  CONSTRAINT riders_referred_by_fkey FOREIGN KEY (referred_by) REFERENCES public.riders(id),
  CONSTRAINT riders_area_manager_id_fkey FOREIGN KEY (area_manager_id) REFERENCES public.area_managers(id),
  CONSTRAINT fk_rider_area_manager FOREIGN KEY (area_manager_id) REFERENCES public.area_managers(id)
);
CREATE TABLE public.role_permissions (
  id bigint NOT NULL DEFAULT nextval('role_permissions_id_seq'::regclass),
  role_id bigint NOT NULL,
  permission_id bigint NOT NULL,
  service_scope ARRAY,
  geo_scope ARRAY,
  conditions jsonb DEFAULT '{}'::jsonb,
  is_active boolean DEFAULT true,
  granted_by bigint,
  granted_at timestamp with time zone NOT NULL DEFAULT now(),
  created_at timestamp with time zone NOT NULL DEFAULT now(),
  CONSTRAINT role_permissions_pkey PRIMARY KEY (id),
  CONSTRAINT role_permissions_role_id_fkey FOREIGN KEY (role_id) REFERENCES public.system_roles(id),
  CONSTRAINT role_permissions_permission_id_fkey FOREIGN KEY (permission_id) REFERENCES public.system_permissions(id),
  CONSTRAINT role_permissions_granted_by_fkey FOREIGN KEY (granted_by) REFERENCES public.system_users(id)
);
CREATE TABLE public.roles (
  id bigint NOT NULL DEFAULT nextval('roles_id_seq'::regclass),
  role_code text NOT NULL UNIQUE,
  role_name text NOT NULL,
  role_description text,
  parent_role_id bigint,
  role_level integer DEFAULT 1,
  role_type text NOT NULL CHECK (role_type = ANY (ARRAY['system'::text, 'custom'::text])),
  is_active boolean DEFAULT true,
  created_at timestamp with time zone NOT NULL DEFAULT now(),
  updated_at timestamp with time zone NOT NULL DEFAULT now(),
  CONSTRAINT roles_pkey PRIMARY KEY (id),
  CONSTRAINT roles_parent_role_id_fkey FOREIGN KEY (parent_role_id) REFERENCES public.roles(id)
);
CREATE TABLE public.security_events (
  id bigint NOT NULL DEFAULT nextval('security_events_id_seq'::regclass),
  event_type text NOT NULL,
  event_severity text NOT NULL DEFAULT 'MEDIUM'::text,
  event_description text NOT NULL,
  system_user_id bigint,
  system_user_name text,
  ip_address text,
  device_info text,
  user_agent text,
  target_resource text,
  attempted_action text,
  detected_by text,
  action_taken text,
  action_taken_by bigint,
  action_taken_at timestamp with time zone,
  is_resolved boolean DEFAULT false,
  resolved_at timestamp with time zone,
  resolution_notes text,
  event_metadata jsonb DEFAULT '{}'::jsonb,
  created_at timestamp with time zone NOT NULL DEFAULT now(),
  CONSTRAINT security_events_pkey PRIMARY KEY (id),
  CONSTRAINT security_events_system_user_id_fkey FOREIGN KEY (system_user_id) REFERENCES public.system_users(id),
  CONSTRAINT security_events_action_taken_by_fkey FOREIGN KEY (action_taken_by) REFERENCES public.system_users(id)
);
CREATE TABLE public.service_points (
  id bigint NOT NULL DEFAULT nextval('service_points_id_seq'::regclass),
  name text NOT NULL,
  city text NOT NULL,
  latitude numeric NOT NULL CHECK (latitude >= 6::numeric AND latitude <= 37::numeric),
  longitude numeric NOT NULL CHECK (longitude >= 68::numeric AND longitude <= 98::numeric),
  address text,
  is_active boolean NOT NULL DEFAULT true,
  created_by bigint,
  created_at timestamp with time zone NOT NULL DEFAULT now(),
  updated_at timestamp with time zone NOT NULL DEFAULT now(),
  is_popular boolean NOT NULL DEFAULT false,
  display_order integer NOT NULL DEFAULT 0,
  CONSTRAINT service_points_pkey PRIMARY KEY (id),
  CONSTRAINT service_points_created_by_fkey FOREIGN KEY (created_by) REFERENCES public.system_users(id)
);
CREATE TABLE public.service_scope_assignments (
  id bigint NOT NULL DEFAULT nextval('service_scope_assignments_id_seq'::regclass),
  system_user_id bigint NOT NULL,
  service_type USER-DEFINED NOT NULL,
  access_level USER-DEFINED NOT NULL DEFAULT 'READ'::access_level,
  is_active boolean DEFAULT true,
  assigned_by bigint,
  assigned_at timestamp with time zone NOT NULL DEFAULT now(),
  created_at timestamp with time zone NOT NULL DEFAULT now(),
  CONSTRAINT service_scope_assignments_pkey PRIMARY KEY (id),
  CONSTRAINT service_scope_assignments_system_user_id_fkey FOREIGN KEY (system_user_id) REFERENCES public.system_users(id),
  CONSTRAINT service_scope_assignments_assigned_by_fkey FOREIGN KEY (assigned_by) REFERENCES public.system_users(id)
);
CREATE TABLE public.service_types (
  id bigint NOT NULL DEFAULT nextval('service_types_id_seq'::regclass),
  code text NOT NULL UNIQUE,
  name text NOT NULL,
  is_active boolean NOT NULL DEFAULT true,
  sort_order integer DEFAULT 0,
  created_at timestamp with time zone NOT NULL DEFAULT now(),
  updated_at timestamp with time zone NOT NULL DEFAULT now(),
  CONSTRAINT service_types_pkey PRIMARY KEY (id)
);
CREATE TABLE public.settlement_batches (
  id bigint NOT NULL DEFAULT nextval('settlement_batches_id_seq'::regclass),
  batch_number text NOT NULL UNIQUE,
  date_range_start date NOT NULL,
  date_range_end date NOT NULL,
  total_amount numeric NOT NULL,
  total_riders integer NOT NULL DEFAULT 0,
  processing_fee_total numeric DEFAULT 0,
  tds_total numeric DEFAULT 0,
  status text NOT NULL DEFAULT 'pending'::text,
  settlement_file_url text,
  initiated_by integer,
  processed_at timestamp with time zone,
  completed_at timestamp with time zone,
  failure_reason text,
  metadata jsonb DEFAULT '{}'::jsonb,
  created_at timestamp with time zone NOT NULL DEFAULT now(),
  updated_at timestamp with time zone NOT NULL DEFAULT now(),
  CONSTRAINT settlement_batches_pkey PRIMARY KEY (id)
);
CREATE TABLE public.store_type_document_requirements (
  id bigint NOT NULL DEFAULT nextval('store_type_document_requirements_id_seq'::regclass),
  store_type USER-DEFINED NOT NULL,
  document_type USER-DEFINED NOT NULL,
  is_mandatory boolean NOT NULL DEFAULT false,
  is_conditional boolean NOT NULL DEFAULT false,
  conditional_group text,
  min_required integer DEFAULT 1,
  requires_verification boolean NOT NULL DEFAULT true,
  requires_expiry_check boolean NOT NULL DEFAULT false,
  display_name text,
  display_order integer DEFAULT 0,
  description text,
  requirement_metadata jsonb DEFAULT '{}'::jsonb,
  created_at timestamp with time zone NOT NULL DEFAULT now(),
  updated_at timestamp with time zone NOT NULL DEFAULT now(),
  CONSTRAINT store_type_document_requirements_pkey PRIMARY KEY (id)
);
CREATE TABLE public.supervisor_mappings (
  id bigint NOT NULL DEFAULT nextval('supervisor_mappings_id_seq'::regclass),
  supervisor_user_id bigint NOT NULL,
  agent_user_id bigint NOT NULL,
  service_type ARRAY,
  ticket_section ARRAY,
  assigned_by_user_id bigint,
  assigned_at timestamp with time zone NOT NULL DEFAULT now(),
  expires_at timestamp with time zone,
  is_active boolean DEFAULT true,
  CONSTRAINT supervisor_mappings_pkey PRIMARY KEY (id),
  CONSTRAINT supervisor_mappings_supervisor_user_id_fkey FOREIGN KEY (supervisor_user_id) REFERENCES public.system_users(id),
  CONSTRAINT supervisor_mappings_agent_user_id_fkey FOREIGN KEY (agent_user_id) REFERENCES public.system_users(id),
  CONSTRAINT supervisor_mappings_assigned_by_user_id_fkey FOREIGN KEY (assigned_by_user_id) REFERENCES public.system_users(id)
);
CREATE TABLE public.system_audit_logs (
  id bigint NOT NULL DEFAULT nextval('system_audit_logs_id_seq'::regclass),
  system_user_id bigint,
  system_user_name text,
  role_at_time text,
  module_name USER-DEFINED NOT NULL,
  action_type text NOT NULL,
  action_description text,
  entity_type text NOT NULL,
  entity_id text NOT NULL,
  old_data jsonb,
  new_data jsonb,
  changed_fields ARRAY,
  ip_address text,
  device_info text,
  user_agent text,
  session_id bigint,
  location_city text,
  location_country text,
  request_id text,
  api_endpoint text,
  http_method text,
  audit_metadata jsonb DEFAULT '{}'::jsonb,
  created_at timestamp with time zone NOT NULL DEFAULT now(),
  CONSTRAINT system_audit_logs_pkey PRIMARY KEY (id),
  CONSTRAINT system_audit_logs_system_user_id_fkey FOREIGN KEY (system_user_id) REFERENCES public.system_users(id),
  CONSTRAINT system_audit_logs_session_id_fkey FOREIGN KEY (session_id) REFERENCES public.system_user_sessions(id)
);
CREATE TABLE public.system_config (
  id bigint NOT NULL DEFAULT nextval('system_config_id_seq'::regclass),
  config_key text NOT NULL UNIQUE,
  config_value jsonb NOT NULL,
  value_type text NOT NULL,
  description text,
  category text,
  updated_by integer,
  updated_at timestamp with time zone NOT NULL DEFAULT now(),
  created_at timestamp with time zone NOT NULL DEFAULT now(),
  CONSTRAINT system_config_pkey PRIMARY KEY (id)
);
CREATE TABLE public.system_permissions (
  id bigint NOT NULL DEFAULT nextval('system_permissions_id_seq'::regclass),
  permission_id text NOT NULL UNIQUE,
  permission_name text NOT NULL UNIQUE,
  permission_display_name text NOT NULL,
  permission_description text,
  module_name USER-DEFINED NOT NULL,
  action USER-DEFINED NOT NULL,
  resource_type text,
  risk_level text DEFAULT 'LOW'::text,
  requires_approval boolean DEFAULT false,
  requires_mfa boolean DEFAULT false,
  is_active boolean DEFAULT true,
  created_at timestamp with time zone NOT NULL DEFAULT now(),
  updated_at timestamp with time zone NOT NULL DEFAULT now(),
  CONSTRAINT system_permissions_pkey PRIMARY KEY (id)
);
CREATE TABLE public.system_roles (
  id bigint NOT NULL DEFAULT nextval('system_roles_id_seq'::regclass),
  role_id text NOT NULL UNIQUE,
  role_name text NOT NULL UNIQUE,
  role_display_name text NOT NULL,
  role_description text,
  role_type USER-DEFINED NOT NULL,
  role_level integer NOT NULL CHECK (role_level > 0),
  parent_role_id bigint,
  is_system_role boolean DEFAULT false,
  is_custom_role boolean DEFAULT false,
  is_active boolean DEFAULT true,
  created_by bigint,
  updated_by bigint,
  created_at timestamp with time zone NOT NULL DEFAULT now(),
  updated_at timestamp with time zone NOT NULL DEFAULT now(),
  CONSTRAINT system_roles_pkey PRIMARY KEY (id),
  CONSTRAINT system_roles_parent_role_id_fkey FOREIGN KEY (parent_role_id) REFERENCES public.system_roles(id),
  CONSTRAINT system_roles_created_by_fkey FOREIGN KEY (created_by) REFERENCES public.system_users(id),
  CONSTRAINT system_roles_updated_by_fkey FOREIGN KEY (updated_by) REFERENCES public.system_users(id)
);
CREATE TABLE public.system_user_api_keys (
  id bigint NOT NULL DEFAULT nextval('system_user_api_keys_id_seq'::regclass),
  system_user_id bigint NOT NULL,
  api_key text NOT NULL UNIQUE,
  api_key_hash text NOT NULL,
  api_key_name text NOT NULL,
  api_key_description text,
  allowed_modules ARRAY,
  allowed_actions ARRAY,
  rate_limit_per_minute integer DEFAULT 60,
  rate_limit_per_hour integer DEFAULT 1000,
  is_active boolean DEFAULT true,
  expires_at timestamp with time zone,
  last_used_at timestamp with time zone,
  usage_count integer DEFAULT 0,
  created_at timestamp with time zone NOT NULL DEFAULT now(),
  created_by bigint,
  CONSTRAINT system_user_api_keys_pkey PRIMARY KEY (id),
  CONSTRAINT system_user_api_keys_system_user_id_fkey FOREIGN KEY (system_user_id) REFERENCES public.system_users(id),
  CONSTRAINT system_user_api_keys_created_by_fkey FOREIGN KEY (created_by) REFERENCES public.system_users(id)
);
CREATE TABLE public.system_user_auth (
  id bigint NOT NULL DEFAULT nextval('system_user_auth_id_seq'::regclass),
  system_user_id bigint NOT NULL UNIQUE,
  password_hash text NOT NULL,
  password_salt text,
  password_last_changed_at timestamp with time zone DEFAULT now(),
  password_expires_at timestamp with time zone,
  two_factor_secret text,
  two_factor_backup_codes ARRAY,
  last_otp text,
  last_otp_sent_at timestamp with time zone,
  otp_attempts integer DEFAULT 0,
  security_questions jsonb DEFAULT '[]'::jsonb,
  recovery_email text,
  recovery_mobile text,
  created_at timestamp with time zone NOT NULL DEFAULT now(),
  updated_at timestamp with time zone NOT NULL DEFAULT now(),
  CONSTRAINT system_user_auth_pkey PRIMARY KEY (id),
  CONSTRAINT system_user_auth_system_user_id_fkey FOREIGN KEY (system_user_id) REFERENCES public.system_users(id)
);
CREATE TABLE public.system_user_ip_whitelist (
  id bigint NOT NULL DEFAULT nextval('system_user_ip_whitelist_id_seq'::regclass),
  system_user_id bigint NOT NULL,
  ip_address text NOT NULL,
  ip_range text,
  ip_label text,
  ip_description text,
  is_active boolean DEFAULT true,
  added_by bigint,
  added_at timestamp with time zone NOT NULL DEFAULT now(),
  created_at timestamp with time zone NOT NULL DEFAULT now(),
  CONSTRAINT system_user_ip_whitelist_pkey PRIMARY KEY (id),
  CONSTRAINT system_user_ip_whitelist_system_user_id_fkey FOREIGN KEY (system_user_id) REFERENCES public.system_users(id),
  CONSTRAINT system_user_ip_whitelist_added_by_fkey FOREIGN KEY (added_by) REFERENCES public.system_users(id)
);
CREATE TABLE public.system_user_login_history (
  id bigint NOT NULL DEFAULT nextval('system_user_login_history_id_seq'::regclass),
  system_user_id bigint NOT NULL,
  login_method text NOT NULL,
  login_success boolean NOT NULL,
  device_id text,
  device_type text,
  ip_address text,
  user_agent text,
  location_city text,
  location_country text,
  failure_reason text,
  failure_code text,
  session_id bigint,
  created_at timestamp with time zone NOT NULL DEFAULT now(),
  CONSTRAINT system_user_login_history_pkey PRIMARY KEY (id),
  CONSTRAINT system_user_login_history_system_user_id_fkey FOREIGN KEY (system_user_id) REFERENCES public.system_users(id),
  CONSTRAINT system_user_login_history_session_id_fkey FOREIGN KEY (session_id) REFERENCES public.system_user_sessions(id)
);
CREATE TABLE public.system_user_sessions (
  id bigint NOT NULL DEFAULT nextval('system_user_sessions_id_seq'::regclass),
  system_user_id bigint NOT NULL,
  session_token text NOT NULL UNIQUE,
  refresh_token text,
  device_id text,
  device_type text,
  ip_address text NOT NULL,
  user_agent text,
  location_city text,
  location_country text,
  is_active boolean DEFAULT true,
  created_at timestamp with time zone NOT NULL DEFAULT now(),
  expires_at timestamp with time zone NOT NULL,
  last_activity_at timestamp with time zone NOT NULL DEFAULT now(),
  logged_out_at timestamp with time zone,
  CONSTRAINT system_user_sessions_pkey PRIMARY KEY (id),
  CONSTRAINT system_user_sessions_system_user_id_fkey FOREIGN KEY (system_user_id) REFERENCES public.system_users(id)
);
CREATE TABLE public.system_users (
  id bigint NOT NULL DEFAULT nextval('system_users_id_seq'::regclass),
  system_user_id text NOT NULL UNIQUE,
  full_name text NOT NULL,
  first_name text,
  last_name text,
  email text NOT NULL UNIQUE CHECK (email ~* '^[A-Za-z0-9._%+-]+@[A-Za-z0-9.-]+\.[A-Z|a-z]{2,}$'::text),
  mobile text NOT NULL CHECK (mobile ~ '^\+?[0-9]{10,15}$'::text),
  alternate_mobile text,
  primary_role USER-DEFINED NOT NULL,
  role_display_name text,
  department text,
  team text,
  reports_to_id bigint,
  manager_name text,
  status USER-DEFINED NOT NULL DEFAULT 'PENDING_ACTIVATION'::system_user_status,
  status_reason text,
  is_email_verified boolean DEFAULT false,
  is_mobile_verified boolean DEFAULT false,
  two_factor_enabled boolean DEFAULT false,
  last_login_at timestamp with time zone,
  last_activity_at timestamp with time zone,
  login_count integer DEFAULT 0,
  failed_login_attempts integer DEFAULT 0,
  account_locked_until timestamp with time zone,
  created_by bigint,
  created_by_name text,
  approved_by bigint,
  approved_at timestamp with time zone,
  deleted_at timestamp with time zone,
  deleted_by bigint,
  created_at timestamp with time zone NOT NULL DEFAULT now(),
  updated_at timestamp with time zone NOT NULL DEFAULT now(),
  subrole text,
  subrole_other text,
  suspension_expires_at timestamp with time zone,
  CONSTRAINT system_users_pkey PRIMARY KEY (id),
  CONSTRAINT system_users_reports_to_id_fkey FOREIGN KEY (reports_to_id) REFERENCES public.system_users(id),
  CONSTRAINT system_users_created_by_fkey FOREIGN KEY (created_by) REFERENCES public.system_users(id),
  CONSTRAINT system_users_approved_by_fkey FOREIGN KEY (approved_by) REFERENCES public.system_users(id)
);
CREATE TABLE public.ticket_access_controls (
  id bigint NOT NULL DEFAULT nextval('ticket_access_controls_id_seq'::regclass),
  system_user_id bigint NOT NULL UNIQUE,
  customer_ticket_access boolean DEFAULT true,
  rider_ticket_access boolean DEFAULT false,
  merchant_ticket_access boolean DEFAULT false,
  can_view_tickets boolean DEFAULT true,
  can_create_ticket boolean DEFAULT false,
  can_update_ticket boolean DEFAULT true,
  can_assign_ticket boolean DEFAULT false,
  can_close_ticket boolean DEFAULT false,
  can_escalate_ticket boolean DEFAULT false,
  can_view_internal_notes boolean DEFAULT false,
  can_handle_critical boolean DEFAULT false,
  can_handle_urgent boolean DEFAULT false,
  can_handle_high boolean DEFAULT true,
  created_at timestamp with time zone NOT NULL DEFAULT now(),
  updated_at timestamp with time zone NOT NULL DEFAULT now(),
  order_type text,
  CONSTRAINT ticket_access_controls_pkey PRIMARY KEY (id),
  CONSTRAINT ticket_access_controls_system_user_id_fkey FOREIGN KEY (system_user_id) REFERENCES public.system_users(id)
);
CREATE TABLE public.ticket_actions_audit (
  id bigint NOT NULL DEFAULT nextval('ticket_actions_audit_id_seq'::regclass),
  ticket_id bigint NOT NULL,
  action_type text NOT NULL,
  actor_user_id bigint,
  actor_type USER-DEFINED,
  actor_id bigint,
  old_value jsonb,
  new_value jsonb,
  metadata jsonb DEFAULT '{}'::jsonb,
  created_at timestamp with time zone NOT NULL DEFAULT now(),
  CONSTRAINT ticket_actions_audit_pkey PRIMARY KEY (id),
  CONSTRAINT ticket_actions_audit_ticket_id_fkey FOREIGN KEY (ticket_id) REFERENCES public.tickets(id),
  CONSTRAINT ticket_actions_audit_actor_user_id_fkey FOREIGN KEY (actor_user_id) REFERENCES public.system_users(id)
);
CREATE TABLE public.ticket_activity_audit (
  id bigint NOT NULL DEFAULT nextval('ticket_activity_audit_id_seq'::regclass),
  ticket_id bigint NOT NULL,
  activity_type text NOT NULL,
  activity_category text NOT NULL CHECK (activity_category = ANY (ARRAY['assignment'::text, 'status_change'::text, 'priority_change'::text, 'response'::text, 'resolution'::text, 'reopen'::text, 'unassignment'::text, 'group_change'::text, 'service_change'::text, 'tag_change'::text, 'custom_field_change'::text, 'sla_change'::text, 'title_change'::text, 'message'::text, 'note'::text, 'attachment'::text, 'rating'::text, 'escalation'::text, 'merge'::text, 'split'::text, 'other'::text])),
  activity_description text NOT NULL,
  actor_user_id bigint,
  actor_type USER-DEFINED,
  actor_id bigint,
  actor_name text,
  actor_role text,
  assigned_to_user_id bigint,
  assigned_to_name text,
  assigned_by_type text CHECK (assigned_by_type = ANY (ARRAY['agent'::text, 'supervisor'::text, 'system'::text, 'auto'::text])),
  previous_assignee_user_id bigint,
  previous_assignee_name text,
  old_status text,
  new_status text,
  status_change_reason text,
  old_priority text,
  new_priority text,
  priority_change_reason text,
  old_group_id bigint,
  new_group_id bigint,
  old_service_type ARRAY,
  new_service_type ARRAY,
  old_ticket_section ARRAY,
  new_ticket_section ARRAY,
  reopened_by_user_id bigint,
  reopened_reason text,
  reopened_from_status text,
  reopened_to_status text,
  response_message_id bigint,
  response_type text CHECK (response_type = ANY (ARRAY['public'::text, 'internal_note'::text, 'system'::text])),
  is_first_response boolean DEFAULT false,
  resolved_by_user_id bigint,
  resolution_type text CHECK (resolution_type = ANY (ARRAY['resolved'::text, 'closed'::text, 'rejected'::text, 'cancelled'::text])),
  resolution_notes text,
  unassigned_by_user_id bigint,
  unassignment_reason text,
  old_value jsonb,
  new_value jsonb,
  changed_fields ARRAY,
  metadata jsonb DEFAULT '{}'::jsonb,
  ip_address inet,
  user_agent text,
  created_at timestamp with time zone NOT NULL DEFAULT now(),
  CONSTRAINT ticket_activity_audit_pkey PRIMARY KEY (id),
  CONSTRAINT ticket_activity_audit_ticket_id_fkey FOREIGN KEY (ticket_id) REFERENCES public.tickets(id),
  CONSTRAINT ticket_activity_audit_actor_user_id_fkey FOREIGN KEY (actor_user_id) REFERENCES public.system_users(id),
  CONSTRAINT ticket_activity_audit_assigned_to_user_id_fkey FOREIGN KEY (assigned_to_user_id) REFERENCES public.system_users(id),
  CONSTRAINT ticket_activity_audit_previous_assignee_user_id_fkey FOREIGN KEY (previous_assignee_user_id) REFERENCES public.system_users(id),
  CONSTRAINT ticket_activity_audit_old_group_id_fkey FOREIGN KEY (old_group_id) REFERENCES public.ticket_groups(id),
  CONSTRAINT ticket_activity_audit_new_group_id_fkey FOREIGN KEY (new_group_id) REFERENCES public.ticket_groups(id),
  CONSTRAINT ticket_activity_audit_reopened_by_user_id_fkey FOREIGN KEY (reopened_by_user_id) REFERENCES public.system_users(id),
  CONSTRAINT ticket_activity_audit_response_message_id_fkey FOREIGN KEY (response_message_id) REFERENCES public.ticket_messages(id),
  CONSTRAINT ticket_activity_audit_resolved_by_user_id_fkey FOREIGN KEY (resolved_by_user_id) REFERENCES public.system_users(id),
  CONSTRAINT ticket_activity_audit_unassigned_by_user_id_fkey FOREIGN KEY (unassigned_by_user_id) REFERENCES public.system_users(id)
);
CREATE TABLE public.ticket_assignment_queue (
  id bigint NOT NULL DEFAULT nextval('ticket_assignment_queue_id_seq'::regclass),
  ticket_id bigint NOT NULL,
  queue_status text NOT NULL DEFAULT 'pending'::text CHECK (queue_status = ANY (ARRAY['pending'::text, 'processing'::text, 'assigned'::text, 'failed'::text, 'skipped'::text])),
  attempt_count integer DEFAULT 0,
  max_attempts integer DEFAULT 3,
  routing_rule_id bigint,
  assigned_to_user_id bigint,
  assignment_method text,
  error_message text,
  queued_at timestamp with time zone NOT NULL DEFAULT now(),
  processed_at timestamp with time zone,
  assigned_at timestamp with time zone,
  CONSTRAINT ticket_assignment_queue_pkey PRIMARY KEY (id),
  CONSTRAINT ticket_assignment_queue_ticket_id_fkey FOREIGN KEY (ticket_id) REFERENCES public.tickets(id),
  CONSTRAINT ticket_assignment_queue_routing_rule_id_fkey FOREIGN KEY (routing_rule_id) REFERENCES public.ticket_routing_rules(id),
  CONSTRAINT ticket_assignment_queue_assigned_to_user_id_fkey FOREIGN KEY (assigned_to_user_id) REFERENCES public.system_users(id)
);
CREATE TABLE public.ticket_assignments (
  id bigint NOT NULL DEFAULT nextval('ticket_assignments_id_seq'::regclass),
  ticket_id bigint NOT NULL,
  assigned_to_user_id bigint NOT NULL,
  assigned_by_user_id bigint NOT NULL,
  assigned_at timestamp with time zone NOT NULL DEFAULT now(),
  unassigned_at timestamp with time zone,
  reason text,
  CONSTRAINT ticket_assignments_pkey PRIMARY KEY (id),
  CONSTRAINT ticket_assignments_ticket_id_fkey FOREIGN KEY (ticket_id) REFERENCES public.tickets(id),
  CONSTRAINT ticket_assignments_assigned_to_user_id_fkey FOREIGN KEY (assigned_to_user_id) REFERENCES public.system_users(id),
  CONSTRAINT ticket_assignments_assigned_by_user_id_fkey FOREIGN KEY (assigned_by_user_id) REFERENCES public.system_users(id)
);
CREATE TABLE public.ticket_attachments (
  id bigint NOT NULL DEFAULT nextval('ticket_attachments_id_seq'::regclass),
  ticket_id bigint NOT NULL,
  message_id bigint,
  file_name text NOT NULL,
  file_size_bytes bigint NOT NULL,
  mime_type text NOT NULL,
  file_extension text,
  r2_key text NOT NULL UNIQUE,
  r2_bucket text NOT NULL DEFAULT 'ticket-attachments'::text,
  r2_url text,
  r2_signed_url text,
  r2_signed_url_expires_at timestamp with time zone,
  file_type text NOT NULL CHECK (file_type = ANY (ARRAY['image'::text, 'document'::text, 'video'::text, 'audio'::text, 'other'::text])),
  image_width integer,
  image_height integer,
  image_format text,
  uploaded_by_user_id bigint,
  uploaded_at timestamp with time zone NOT NULL DEFAULT now(),
  is_deleted boolean DEFAULT false,
  deleted_at timestamp with time zone,
  CONSTRAINT ticket_attachments_pkey PRIMARY KEY (id),
  CONSTRAINT ticket_attachments_ticket_id_fkey FOREIGN KEY (ticket_id) REFERENCES public.tickets(id),
  CONSTRAINT ticket_attachments_message_id_fkey FOREIGN KEY (message_id) REFERENCES public.ticket_messages(id),
  CONSTRAINT ticket_attachments_uploaded_by_user_id_fkey FOREIGN KEY (uploaded_by_user_id) REFERENCES public.system_users(id)
);
CREATE TABLE public.ticket_auto_generation_rules (
  id bigint NOT NULL DEFAULT nextval('ticket_auto_generation_rules_id_seq'::regclass),
  rule_name text NOT NULL UNIQUE,
  rule_description text,
  trigger_event text NOT NULL,
  trigger_conditions jsonb NOT NULL DEFAULT '{}'::jsonb,
  ticket_title USER-DEFINED NOT NULL,
  ticket_type USER-DEFINED NOT NULL,
  ticket_category USER-DEFINED NOT NULL,
  service_type USER-DEFINED NOT NULL,
  priority USER-DEFINED NOT NULL DEFAULT 'MEDIUM'::unified_ticket_priority,
  auto_assign boolean DEFAULT false,
  auto_assign_to_agent_id integer,
  auto_assign_to_department text,
  is_active boolean DEFAULT true,
  is_enabled boolean DEFAULT true,
  metadata jsonb DEFAULT '{}'::jsonb,
  created_at timestamp with time zone NOT NULL DEFAULT now(),
  updated_at timestamp with time zone NOT NULL DEFAULT now(),
  CONSTRAINT ticket_auto_generation_rules_pkey PRIMARY KEY (id),
  CONSTRAINT ticket_auto_generation_rules_auto_assign_to_agent_id_fkey FOREIGN KEY (auto_assign_to_agent_id) REFERENCES public.system_users(id)
);
CREATE TABLE public.ticket_automation_executions (
  id bigint NOT NULL DEFAULT nextval('ticket_automation_executions_id_seq'::regclass),
  rule_id bigint NOT NULL,
  ticket_id bigint NOT NULL,
  execution_status text NOT NULL CHECK (execution_status = ANY (ARRAY['pending'::text, 'running'::text, 'completed'::text, 'failed'::text, 'skipped'::text])),
  actions_executed jsonb DEFAULT '[]'::jsonb,
  actions_failed jsonb DEFAULT '[]'::jsonb,
  error_message text,
  triggered_at timestamp with time zone NOT NULL DEFAULT now(),
  started_at timestamp with time zone,
  completed_at timestamp with time zone,
  execution_duration_ms integer,
  CONSTRAINT ticket_automation_executions_pkey PRIMARY KEY (id),
  CONSTRAINT ticket_automation_executions_rule_id_fkey FOREIGN KEY (rule_id) REFERENCES public.ticket_automation_rules(id),
  CONSTRAINT ticket_automation_executions_ticket_id_fkey FOREIGN KEY (ticket_id) REFERENCES public.tickets(id)
);
CREATE TABLE public.ticket_automation_rules (
  id bigint NOT NULL DEFAULT nextval('ticket_automation_rules_id_seq'::regclass),
  rule_code text NOT NULL UNIQUE,
  rule_name text NOT NULL,
  rule_description text,
  rule_priority integer NOT NULL DEFAULT 0,
  trigger_conditions jsonb NOT NULL DEFAULT '{}'::jsonb,
  actions jsonb NOT NULL DEFAULT '[]'::jsonb,
  execution_mode text NOT NULL DEFAULT 'immediate'::text CHECK (execution_mode = ANY (ARRAY['immediate'::text, 'scheduled'::text, 'delayed'::text])),
  execution_delay_seconds integer DEFAULT 0,
  is_active boolean DEFAULT true,
  created_at timestamp with time zone NOT NULL DEFAULT now(),
  updated_at timestamp with time zone NOT NULL DEFAULT now(),
  created_by_user_id bigint,
  CONSTRAINT ticket_automation_rules_pkey PRIMARY KEY (id),
  CONSTRAINT ticket_automation_rules_created_by_user_id_fkey FOREIGN KEY (created_by_user_id) REFERENCES public.system_users(id)
);
CREATE TABLE public.ticket_conversations (
  id bigint NOT NULL DEFAULT nextval('ticket_conversations_id_seq'::regclass),
  ticket_id bigint NOT NULL UNIQUE,
  conversation_type text NOT NULL DEFAULT 'ticket'::text CHECK (conversation_type = ANY (ARRAY['ticket'::text, 'internal'::text, 'external'::text])),
  participant_user_ids ARRAY,
  participant_external_ids ARRAY,
  is_active boolean DEFAULT true,
  is_archived boolean DEFAULT false,
  last_message_at timestamp with time zone,
  last_message_by_user_id bigint,
  created_at timestamp with time zone NOT NULL DEFAULT now(),
  updated_at timestamp with time zone NOT NULL DEFAULT now(),
  CONSTRAINT ticket_conversations_pkey PRIMARY KEY (id),
  CONSTRAINT ticket_conversations_ticket_id_fkey FOREIGN KEY (ticket_id) REFERENCES public.tickets(id),
  CONSTRAINT ticket_conversations_last_message_by_user_id_fkey FOREIGN KEY (last_message_by_user_id) REFERENCES public.system_users(id)
);
CREATE TABLE public.ticket_custom_field_values (
  id bigint NOT NULL DEFAULT nextval('ticket_custom_field_values_id_seq'::regclass),
  ticket_id bigint NOT NULL,
  field_id bigint NOT NULL,
  text_value text,
  number_value numeric,
  boolean_value boolean,
  date_value date,
  datetime_value timestamp with time zone,
  json_value jsonb,
  updated_by_user_id bigint,
  updated_at timestamp with time zone NOT NULL DEFAULT now(),
  CONSTRAINT ticket_custom_field_values_pkey PRIMARY KEY (id),
  CONSTRAINT ticket_custom_field_values_ticket_id_fkey FOREIGN KEY (ticket_id) REFERENCES public.tickets(id),
  CONSTRAINT ticket_custom_field_values_field_id_fkey FOREIGN KEY (field_id) REFERENCES public.ticket_custom_fields(id),
  CONSTRAINT ticket_custom_field_values_updated_by_user_id_fkey FOREIGN KEY (updated_by_user_id) REFERENCES public.system_users(id)
);
CREATE TABLE public.ticket_custom_fields (
  id bigint NOT NULL DEFAULT nextval('ticket_custom_fields_id_seq'::regclass),
  field_code text NOT NULL UNIQUE,
  field_name text NOT NULL,
  field_description text,
  field_type text NOT NULL CHECK (field_type = ANY (ARRAY['text'::text, 'number'::text, 'date'::text, 'datetime'::text, 'boolean'::text, 'select'::text, 'multiselect'::text, 'textarea'::text, 'url'::text, 'email'::text])),
  field_config jsonb NOT NULL DEFAULT '{}'::jsonb,
  service_type ARRAY,
  ticket_section ARRAY,
  ticket_category ARRAY,
  display_order integer DEFAULT 0,
  is_required boolean DEFAULT false,
  is_active boolean DEFAULT true,
  validation_rules jsonb DEFAULT '{}'::jsonb,
  created_at timestamp with time zone NOT NULL DEFAULT now(),
  updated_at timestamp with time zone NOT NULL DEFAULT now(),
  created_by_user_id bigint,
  CONSTRAINT ticket_custom_fields_pkey PRIMARY KEY (id),
  CONSTRAINT ticket_custom_fields_created_by_user_id_fkey FOREIGN KEY (created_by_user_id) REFERENCES public.system_users(id)
);
CREATE TABLE public.ticket_field_values (
  id bigint NOT NULL DEFAULT nextval('ticket_field_values_id_seq'::regclass),
  ticket_id bigint NOT NULL,
  field_id bigint NOT NULL,
  value jsonb,
  updated_at timestamp with time zone NOT NULL DEFAULT now(),
  CONSTRAINT ticket_field_values_pkey PRIMARY KEY (id),
  CONSTRAINT ticket_field_values_ticket_id_fkey FOREIGN KEY (ticket_id) REFERENCES public.tickets(id),
  CONSTRAINT ticket_field_values_field_id_fkey FOREIGN KEY (field_id) REFERENCES public.ticket_custom_fields(id)
);
CREATE TABLE public.ticket_groups (
  id bigint NOT NULL DEFAULT nextval('ticket_groups_id_seq'::regclass),
  group_code text NOT NULL UNIQUE,
  group_name text NOT NULL,
  group_description text,
  parent_group_id bigint,
  group_level integer NOT NULL DEFAULT 1,
  display_order integer DEFAULT 0,
  service_type USER-DEFINED,
  ticket_section USER-DEFINED,
  is_active boolean NOT NULL DEFAULT true,
  metadata jsonb DEFAULT '{}'::jsonb,
  created_at timestamp with time zone NOT NULL DEFAULT now(),
  updated_at timestamp with time zone NOT NULL DEFAULT now(),
  ticket_category USER-DEFINED,
  source_role USER-DEFINED,
  CONSTRAINT ticket_groups_pkey PRIMARY KEY (id),
  CONSTRAINT ticket_groups_parent_group_id_fkey FOREIGN KEY (parent_group_id) REFERENCES public.ticket_groups(id)
);
CREATE TABLE public.ticket_message_reads (
  id bigint NOT NULL DEFAULT nextval('ticket_message_reads_id_seq'::regclass),
  message_id bigint NOT NULL,
  user_id bigint NOT NULL,
  read_at timestamp with time zone NOT NULL DEFAULT now(),
  CONSTRAINT ticket_message_reads_pkey PRIMARY KEY (id),
  CONSTRAINT ticket_message_reads_message_id_fkey FOREIGN KEY (message_id) REFERENCES public.ticket_messages(id),
  CONSTRAINT ticket_message_reads_user_id_fkey FOREIGN KEY (user_id) REFERENCES public.system_users(id)
);
CREATE TABLE public.ticket_message_typing (
  id bigint NOT NULL DEFAULT nextval('ticket_message_typing_id_seq'::regclass),
  conversation_id bigint NOT NULL,
  user_id bigint NOT NULL,
  is_typing boolean DEFAULT true,
  started_typing_at timestamp with time zone NOT NULL DEFAULT now(),
  stopped_typing_at timestamp with time zone,
  expires_at timestamp with time zone NOT NULL DEFAULT (now() + '00:00:30'::interval),
  CONSTRAINT ticket_message_typing_pkey PRIMARY KEY (id),
  CONSTRAINT ticket_message_typing_conversation_id_fkey FOREIGN KEY (conversation_id) REFERENCES public.ticket_conversations(id),
  CONSTRAINT ticket_message_typing_user_id_fkey FOREIGN KEY (user_id) REFERENCES public.system_users(id)
);
CREATE TABLE public.ticket_messages (
  id bigint NOT NULL DEFAULT nextval('ticket_messages_id_seq'::regclass),
  ticket_id bigint NOT NULL,
  sender_type USER-DEFINED NOT NULL,
  sender_id bigint,
  message_type USER-DEFINED NOT NULL DEFAULT 'reply'::ticket_message_type,
  message text NOT NULL,
  attachments jsonb DEFAULT '[]'::jsonb,
  edited_at timestamp with time zone,
  created_at timestamp with time zone NOT NULL DEFAULT now(),
  updated_at timestamp with time zone NOT NULL DEFAULT now(),
  conversation_id bigint,
  parent_message_id bigint,
  thread_id bigint,
  read_count integer DEFAULT 0,
  read_by_user_ids ARRAY,
  last_typing_at timestamp with time zone,
  is_edited boolean DEFAULT false,
  is_deleted boolean DEFAULT false,
  deleted_at timestamp with time zone,
  content_type text DEFAULT 'text'::text CHECK (content_type = ANY (ARRAY['text'::text, 'html'::text, 'markdown'::text, 'image'::text, 'file'::text, 'system'::text])),
  rich_content jsonb DEFAULT '{}'::jsonb,
  search_vector tsvector,
  CONSTRAINT ticket_messages_pkey PRIMARY KEY (id),
  CONSTRAINT ticket_messages_ticket_id_fkey FOREIGN KEY (ticket_id) REFERENCES public.tickets(id),
  CONSTRAINT ticket_messages_parent_message_id_fkey FOREIGN KEY (parent_message_id) REFERENCES public.ticket_messages(id),
  CONSTRAINT ticket_messages_conversation_id_fkey FOREIGN KEY (conversation_id) REFERENCES public.ticket_conversations(id)
);
CREATE TABLE public.ticket_notifications (
  id bigint NOT NULL DEFAULT nextval('ticket_notifications_id_seq'::regclass),
  ticket_id bigint NOT NULL,
  user_id bigint NOT NULL,
  notification_type text NOT NULL CHECK (notification_type = ANY (ARRAY['ticket_assigned'::text, 'ticket_updated'::text, 'ticket_message'::text, 'ticket_resolved'::text, 'ticket_closed'::text, 'sla_breach'::text, 'sla_warning'::text])),
  channels ARRAY NOT NULL DEFAULT ARRAY['in_app'::text],
  title text NOT NULL,
  message text NOT NULL,
  metadata jsonb DEFAULT '{}'::jsonb,
  is_read boolean DEFAULT false,
  read_at timestamp with time zone,
  is_sent boolean DEFAULT false,
  sent_at timestamp with time zone,
  created_at timestamp with time zone NOT NULL DEFAULT now(),
  expires_at timestamp with time zone,
  CONSTRAINT ticket_notifications_pkey PRIMARY KEY (id),
  CONSTRAINT ticket_notifications_ticket_id_fkey FOREIGN KEY (ticket_id) REFERENCES public.tickets(id),
  CONSTRAINT ticket_notifications_user_id_fkey FOREIGN KEY (user_id) REFERENCES public.system_users(id)
);
CREATE TABLE public.ticket_participants (
  id bigint NOT NULL DEFAULT nextval('ticket_participants_id_seq'::regclass),
  ticket_id bigint NOT NULL,
  participant_role USER-DEFINED NOT NULL,
  entity_type USER-DEFINED NOT NULL,
  customer_id bigint,
  rider_id integer,
  rider_3pl_id text,
  merchant_id bigint,
  system_user_id bigint,
  provider_id bigint,
  external_provider_name text,
  external_entity_id text,
  external_entity_name text,
  created_at timestamp with time zone NOT NULL DEFAULT now(),
  CONSTRAINT ticket_participants_pkey PRIMARY KEY (id),
  CONSTRAINT ticket_participants_ticket_id_fkey FOREIGN KEY (ticket_id) REFERENCES public.tickets(id),
  CONSTRAINT ticket_participants_system_user_id_fkey FOREIGN KEY (system_user_id) REFERENCES public.system_users(id)
);
CREATE TABLE public.ticket_priorities (
  id bigint NOT NULL DEFAULT nextval('ticket_priorities_id_seq'::regclass),
  priority_code text NOT NULL UNIQUE,
  priority_name text NOT NULL,
  priority_description text,
  priority_level integer NOT NULL UNIQUE,
  display_color text,
  display_icon text,
  display_order integer DEFAULT 0,
  default_sla_minutes integer,
  is_active boolean DEFAULT true,
  created_at timestamp with time zone NOT NULL DEFAULT now(),
  updated_at timestamp with time zone NOT NULL DEFAULT now(),
  CONSTRAINT ticket_priorities_pkey PRIMARY KEY (id)
);
CREATE TABLE public.ticket_ratings (
  id bigint NOT NULL DEFAULT nextval('ticket_ratings_id_seq'::regclass),
  ticket_id bigint NOT NULL,
  rated_by_type USER-DEFINED NOT NULL,
  rated_by_id bigint NOT NULL,
  rating_value smallint NOT NULL CHECK (rating_value >= 1 AND rating_value <= 5),
  feedback_text text,
  created_at timestamp with time zone NOT NULL DEFAULT now(),
  sentiment_score numeric,
  sentiment_label text,
  sentiment_confidence numeric,
  feedback_category text,
  feedback_tags ARRAY,
  requires_followup boolean DEFAULT false,
  followup_scheduled_at timestamp with time zone,
  CONSTRAINT ticket_ratings_pkey PRIMARY KEY (id),
  CONSTRAINT ticket_ratings_ticket_id_fkey FOREIGN KEY (ticket_id) REFERENCES public.tickets(id)
);
CREATE TABLE public.ticket_routing_rules (
  id bigint NOT NULL DEFAULT nextval('ticket_routing_rules_id_seq'::regclass),
  rule_code text NOT NULL UNIQUE,
  rule_name text NOT NULL,
  rule_description text,
  rule_priority integer NOT NULL DEFAULT 0,
  conditions jsonb NOT NULL DEFAULT '{}'::jsonb,
  routing_strategy text NOT NULL CHECK (routing_strategy = ANY (ARRAY['round_robin'::text, 'least_assigned'::text, 'skill_based'::text, 'language_based'::text, 'load_based'::text, 'priority_based'::text, 'custom'::text])),
  routing_params jsonb DEFAULT '{}'::jsonb,
  target_group_id bigint,
  target_role_id bigint,
  fallback_strategy text,
  fallback_group_id bigint,
  is_active boolean DEFAULT true,
  created_at timestamp with time zone NOT NULL DEFAULT now(),
  updated_at timestamp with time zone NOT NULL DEFAULT now(),
  created_by_user_id bigint,
  CONSTRAINT ticket_routing_rules_pkey PRIMARY KEY (id),
  CONSTRAINT ticket_routing_rules_target_group_id_fkey FOREIGN KEY (target_group_id) REFERENCES public.ticket_groups(id),
  CONSTRAINT ticket_routing_rules_target_role_id_fkey FOREIGN KEY (target_role_id) REFERENCES public.roles(id),
  CONSTRAINT ticket_routing_rules_fallback_group_id_fkey FOREIGN KEY (fallback_group_id) REFERENCES public.ticket_groups(id),
  CONSTRAINT ticket_routing_rules_created_by_user_id_fkey FOREIGN KEY (created_by_user_id) REFERENCES public.system_users(id)
);
CREATE TABLE public.ticket_saved_filters (
  id bigint NOT NULL DEFAULT nextval('ticket_saved_filters_id_seq'::regclass),
  user_id bigint NOT NULL,
  filter_name text NOT NULL,
  filter_description text,
  filter_config jsonb NOT NULL DEFAULT '{}'::jsonb,
  is_shared boolean DEFAULT false,
  is_default boolean DEFAULT false,
  created_at timestamp with time zone NOT NULL DEFAULT now(),
  updated_at timestamp with time zone NOT NULL DEFAULT now(),
  CONSTRAINT ticket_saved_filters_pkey PRIMARY KEY (id),
  CONSTRAINT ticket_saved_filters_user_id_fkey FOREIGN KEY (user_id) REFERENCES public.system_users(id)
);
CREATE TABLE public.ticket_sla_policies (
  id bigint NOT NULL DEFAULT nextval('ticket_sla_policies_id_seq'::regclass),
  policy_code text NOT NULL UNIQUE,
  policy_name text NOT NULL,
  policy_description text,
  applicability_rules jsonb NOT NULL DEFAULT '{}'::jsonb,
  first_response_target_minutes integer,
  resolution_target_minutes integer NOT NULL,
  update_target_minutes integer,
  business_hours_config jsonb DEFAULT '{}'::jsonb,
  escalation_rules jsonb DEFAULT '{}'::jsonb,
  is_active boolean DEFAULT true,
  priority integer DEFAULT 0,
  created_at timestamp with time zone NOT NULL DEFAULT now(),
  updated_at timestamp with time zone NOT NULL DEFAULT now(),
  created_by_user_id bigint,
  CONSTRAINT ticket_sla_policies_pkey PRIMARY KEY (id),
  CONSTRAINT ticket_sla_policies_created_by_user_id_fkey FOREIGN KEY (created_by_user_id) REFERENCES public.system_users(id)
);
CREATE TABLE public.ticket_status_history (
  id bigint NOT NULL DEFAULT nextval('ticket_status_history_id_seq'::regclass),
  ticket_id bigint NOT NULL,
  old_status USER-DEFINED NOT NULL,
  new_status USER-DEFINED NOT NULL,
  changed_by_user_id bigint NOT NULL,
  reason text,
  created_at timestamp with time zone NOT NULL DEFAULT now(),
  CONSTRAINT ticket_status_history_pkey PRIMARY KEY (id),
  CONSTRAINT ticket_status_history_ticket_id_fkey FOREIGN KEY (ticket_id) REFERENCES public.tickets(id),
  CONSTRAINT ticket_status_history_changed_by_user_id_fkey FOREIGN KEY (changed_by_user_id) REFERENCES public.system_users(id)
);
CREATE TABLE public.ticket_statuses (
  id bigint NOT NULL DEFAULT nextval('ticket_statuses_id_seq'::regclass),
  status_code text NOT NULL UNIQUE,
  status_name text NOT NULL,
  status_description text,
  status_category text NOT NULL CHECK (status_category = ANY (ARRAY['open'::text, 'in_progress'::text, 'resolved'::text, 'closed'::text, 'rejected'::text])),
  display_color text,
  display_icon text,
  display_order integer DEFAULT 0,
  allowed_transitions ARRAY,
  requires_reason boolean DEFAULT false,
  requires_resolution boolean DEFAULT false,
  is_active boolean DEFAULT true,
  created_at timestamp with time zone NOT NULL DEFAULT now(),
  updated_at timestamp with time zone NOT NULL DEFAULT now(),
  CONSTRAINT ticket_statuses_pkey PRIMARY KEY (id)
);
CREATE TABLE public.ticket_tag_map (
  id bigint NOT NULL DEFAULT nextval('ticket_tag_map_id_seq'::regclass),
  ticket_id bigint NOT NULL,
  tag_id bigint NOT NULL,
  added_by_user_id bigint NOT NULL,
  added_at timestamp with time zone NOT NULL DEFAULT now(),
  CONSTRAINT ticket_tag_map_pkey PRIMARY KEY (id),
  CONSTRAINT ticket_tag_map_ticket_id_fkey FOREIGN KEY (ticket_id) REFERENCES public.tickets(id),
  CONSTRAINT ticket_tag_map_tag_id_fkey FOREIGN KEY (tag_id) REFERENCES public.ticket_tags(id),
  CONSTRAINT ticket_tag_map_added_by_user_id_fkey FOREIGN KEY (added_by_user_id) REFERENCES public.system_users(id)
);
CREATE TABLE public.ticket_tags (
  id bigint NOT NULL DEFAULT nextval('ticket_tags_id_seq'::regclass),
  tag_code text NOT NULL UNIQUE,
  tag_name text NOT NULL,
  tag_description text,
  tag_color text,
  is_active boolean NOT NULL DEFAULT true,
  created_at timestamp with time zone NOT NULL DEFAULT now(),
  CONSTRAINT ticket_tags_pkey PRIMARY KEY (id)
);
CREATE TABLE public.ticket_title_config (
  id bigint NOT NULL DEFAULT nextval('ticket_title_config_id_seq'::regclass),
  ticket_title USER-DEFINED NOT NULL UNIQUE,
  display_name text NOT NULL,
  description text,
  applicable_to_ticket_type ARRAY,
  applicable_to_service_type ARRAY,
  applicable_to_source ARRAY,
  default_priority USER-DEFINED,
  default_category USER-DEFINED,
  default_auto_assign boolean DEFAULT false,
  default_auto_assign_to_agent_id integer,
  is_active boolean DEFAULT true,
  display_order integer DEFAULT 0,
  metadata jsonb DEFAULT '{}'::jsonb,
  created_at timestamp with time zone NOT NULL DEFAULT now(),
  updated_at timestamp with time zone NOT NULL DEFAULT now(),
  CONSTRAINT ticket_title_config_pkey PRIMARY KEY (id),
  CONSTRAINT ticket_title_config_default_auto_assign_to_agent_id_fkey FOREIGN KEY (default_auto_assign_to_agent_id) REFERENCES public.system_users(id)
);
CREATE TABLE public.ticket_titles (
  id bigint NOT NULL DEFAULT nextval('ticket_titles_id_seq'::regclass),
  group_id bigint,
  service_type USER-DEFINED NOT NULL,
  ticket_section USER-DEFINED NOT NULL,
  source_role USER-DEFINED NOT NULL,
  title_code text NOT NULL UNIQUE,
  title_text text NOT NULL,
  description text,
  display_order integer DEFAULT 0,
  is_active boolean NOT NULL DEFAULT true,
  metadata jsonb DEFAULT '{}'::jsonb,
  created_at timestamp with time zone NOT NULL DEFAULT now(),
  updated_at timestamp with time zone NOT NULL DEFAULT now(),
  CONSTRAINT ticket_titles_pkey PRIMARY KEY (id),
  CONSTRAINT ticket_titles_group_id_fkey FOREIGN KEY (group_id) REFERENCES public.ticket_groups(id)
);
CREATE TABLE public.tickets (
  id bigint NOT NULL DEFAULT nextval('tickets_id_seq'::regclass),
  rider_id integer NOT NULL,
  order_id bigint,
  category text NOT NULL,
  priority text NOT NULL DEFAULT 'medium'::text,
  subject text NOT NULL,
  message text NOT NULL,
  status USER-DEFINED NOT NULL DEFAULT 'open'::ticket_status,
  assigned_to integer,
  resolution text,
  metadata jsonb DEFAULT '{}'::jsonb,
  created_at timestamp with time zone NOT NULL DEFAULT now(),
  updated_at timestamp with time zone NOT NULL DEFAULT now(),
  resolved_at timestamp with time zone,
  ticket_number text UNIQUE CHECK (ticket_number ~ '^TKT-\d{4}-\d{6}$'::text),
  service_type USER-DEFINED,
  ticket_category USER-DEFINED,
  ticket_section USER-DEFINED,
  source_role USER-DEFINED,
  description text,
  order_service_type USER-DEFINED,
  title_id bigint,
  created_by_user_id bigint,
  current_assignee_user_id bigint,
  sla_due_at timestamp with time zone,
  closed_at timestamp with time zone,
  is_3pl_order boolean DEFAULT false,
  tpl_provider_id bigint,
  tpl_direction text CHECK ((tpl_direction = ANY (ARRAY['inbound'::text, 'outbound'::text])) OR tpl_direction IS NULL),
  external_order_id text,
  external_provider_name text,
  custom_field_values jsonb DEFAULT '{}'::jsonb,
  is_high_value_order boolean DEFAULT false,
  first_response_at timestamp with time zone,
  first_response_time_minutes integer,
  csat_score smallint CHECK (csat_score >= 1 AND csat_score <= 5),
  dsat_score smallint CHECK (dsat_score >= 1 AND dsat_score <= 5),
  csat_feedback text,
  dsat_feedback text,
  reopen_count integer DEFAULT 0,
  last_reopened_at timestamp with time zone,
  locked_by_user_id bigint,
  locked_at timestamp with time zone,
  lock_expires_at timestamp with time zone,
  search_vector tsvector,
  automation_metadata jsonb DEFAULT '{}'::jsonb,
  group_id integer,
  requester_id bigint,
  requester_type text,
  is_merged boolean NOT NULL DEFAULT false,
  merged_into_ticket_id bigint,
  spam_at timestamp with time zone,
  reopened_at timestamp with time zone,
  source_channel text,
  CONSTRAINT tickets_pkey PRIMARY KEY (id),
  CONSTRAINT tickets_rider_id_fkey FOREIGN KEY (rider_id) REFERENCES public.riders(id),
  CONSTRAINT tickets_order_id_fkey FOREIGN KEY (order_id) REFERENCES public.orders(id),
  CONSTRAINT tickets_locked_by_user_id_fkey FOREIGN KEY (locked_by_user_id) REFERENCES public.system_users(id),
  CONSTRAINT tickets_group_id_fkey FOREIGN KEY (group_id) REFERENCES public.ticket_groups(id),
  CONSTRAINT tickets_merged_into_ticket_id_fkey FOREIGN KEY (merged_into_ticket_id) REFERENCES public.tickets(id)
);
CREATE TABLE public.tpl_inbound_orders (
  id bigint NOT NULL DEFAULT nextval('tpl_inbound_orders_id_seq'::regclass),
  tpl_order_id text NOT NULL,
  tpl_provider_id bigint NOT NULL,
  internal_order_id bigint,
  order_type text NOT NULL CHECK (order_type = ANY (ARRAY['food'::text, 'parcel'::text, 'person_ride'::text])),
  order_status text NOT NULL DEFAULT 'pending'::text CHECK (order_status = ANY (ARRAY['pending'::text, 'accepted'::text, 'rejected'::text, 'processing'::text, 'assigned'::text, 'picked_up'::text, 'in_transit'::text, 'delivered'::text, 'completed'::text, 'cancelled'::text])),
  order_payload jsonb NOT NULL,
  acceptance_status text DEFAULT 'pending'::text CHECK (acceptance_status = ANY (ARRAY['pending'::text, 'accepted'::text, 'rejected'::text, 'auto_accepted'::text])),
  rejection_reason text,
  rejection_code text,
  accepted_at timestamp with time zone,
  rejected_at timestamp with time zone,
  accepted_by bigint,
  assigned_rider_id integer,
  tpl_rider_id text,
  sync_status text DEFAULT 'pending'::text CHECK (sync_status = ANY (ARRAY['pending'::text, 'synced'::text, 'failed'::text, 'conflict'::text])),
  sync_error text,
  sync_retry_count integer DEFAULT 0,
  last_sync_at timestamp with time zone,
  metadata jsonb DEFAULT '{}'::jsonb,
  created_at timestamp with time zone NOT NULL DEFAULT now(),
  updated_at timestamp with time zone NOT NULL DEFAULT now(),
  CONSTRAINT tpl_inbound_orders_pkey PRIMARY KEY (id),
  CONSTRAINT tpl_inbound_orders_tpl_provider_id_fkey FOREIGN KEY (tpl_provider_id) REFERENCES public.tpl_providers(id),
  CONSTRAINT tpl_inbound_orders_internal_order_id_fkey FOREIGN KEY (internal_order_id) REFERENCES public.orders(id),
  CONSTRAINT tpl_inbound_orders_accepted_by_fkey FOREIGN KEY (accepted_by) REFERENCES public.system_users(id),
  CONSTRAINT tpl_inbound_orders_assigned_rider_id_fkey FOREIGN KEY (assigned_rider_id) REFERENCES public.riders(id)
);
CREATE TABLE public.tpl_order_requests (
  id bigint NOT NULL DEFAULT nextval('tpl_order_requests_id_seq'::regclass),
  request_id text NOT NULL UNIQUE,
  internal_order_id bigint NOT NULL,
  tpl_provider_id bigint NOT NULL,
  order_type text NOT NULL CHECK (order_type = ANY (ARRAY['food'::text, 'parcel'::text, 'person_ride'::text])),
  request_status text NOT NULL DEFAULT 'pending'::text CHECK (request_status = ANY (ARRAY['pending'::text, 'sent'::text, 'accepted'::text, 'rejected'::text, 'cancelled'::text, 'expired'::text])),
  request_payload jsonb NOT NULL,
  tpl_order_id text,
  tpl_reference text,
  rejection_reason text,
  rejection_code text,
  accepted_at timestamp with time zone,
  rejected_at timestamp with time zone,
  cancelled_at timestamp with time zone,
  response_payload jsonb,
  retry_count integer DEFAULT 0,
  max_retries integer DEFAULT 3,
  last_retry_at timestamp with time zone,
  next_retry_at timestamp with time zone,
  error_message text,
  error_code text,
  http_status_code integer,
  request_metadata jsonb DEFAULT '{}'::jsonb,
  created_at timestamp with time zone NOT NULL DEFAULT now(),
  updated_at timestamp with time zone NOT NULL DEFAULT now(),
  CONSTRAINT tpl_order_requests_pkey PRIMARY KEY (id),
  CONSTRAINT tpl_order_requests_internal_order_id_fkey FOREIGN KEY (internal_order_id) REFERENCES public.orders(id),
  CONSTRAINT tpl_order_requests_tpl_provider_id_fkey FOREIGN KEY (tpl_provider_id) REFERENCES public.tpl_providers(id)
);
CREATE TABLE public.tpl_order_status_updates (
  id bigint NOT NULL DEFAULT nextval('tpl_order_status_updates_id_seq'::regclass),
  tpl_order_request_id bigint NOT NULL,
  internal_order_id bigint NOT NULL,
  tpl_provider_id bigint NOT NULL,
  update_type text NOT NULL CHECK (update_type = ANY (ARRAY['status_change'::text, 'rider_assigned'::text, 'rider_enroute'::text, 'picked_up'::text, 'delivered'::text, 'cancelled'::text, 'exception'::text])),
  tpl_status text NOT NULL,
  internal_status text,
  update_payload jsonb NOT NULL,
  rider_info jsonb,
  location_info jsonb,
  estimated_delivery_time timestamp with time zone,
  actual_delivery_time timestamp with time zone,
  exception_details jsonb,
  processed boolean DEFAULT false,
  processed_at timestamp with time zone,
  processing_error text,
  created_at timestamp with time zone NOT NULL DEFAULT now(),
  CONSTRAINT tpl_order_status_updates_pkey PRIMARY KEY (id),
  CONSTRAINT tpl_order_status_updates_tpl_provider_id_fkey FOREIGN KEY (tpl_provider_id) REFERENCES public.tpl_providers(id),
  CONSTRAINT tpl_order_status_updates_tpl_order_request_id_fkey FOREIGN KEY (tpl_order_request_id) REFERENCES public.tpl_order_requests(id),
  CONSTRAINT tpl_order_status_updates_internal_order_id_fkey FOREIGN KEY (internal_order_id) REFERENCES public.orders(id)
);
CREATE TABLE public.tpl_order_sync_log (
  id bigint NOT NULL DEFAULT nextval('tpl_order_sync_log_id_seq'::regclass),
  order_id bigint,
  tpl_provider_id bigint NOT NULL,
  tpl_order_request_id bigint,
  tpl_inbound_order_id bigint,
  sync_direction text NOT NULL CHECK (sync_direction = ANY (ARRAY['outbound'::text, 'inbound'::text])),
  sync_type text NOT NULL CHECK (sync_type = ANY (ARRAY['order_create'::text, 'order_update'::text, 'status_update'::text, 'rider_assignment'::text, 'cancellation'::text, 'webhook'::text, 'api_call'::text])),
  sync_status text NOT NULL DEFAULT 'pending'::text CHECK (sync_status = ANY (ARRAY['pending'::text, 'success'::text, 'failed'::text, 'retrying'::text, 'cancelled'::text])),
  request_payload jsonb,
  response_payload jsonb,
  error_message text,
  error_code text,
  retry_count integer DEFAULT 0,
  max_retries integer DEFAULT 3,
  http_status_code integer,
  response_time_ms integer,
  created_at timestamp with time zone NOT NULL DEFAULT now(),
  completed_at timestamp with time zone,
  CONSTRAINT tpl_order_sync_log_pkey PRIMARY KEY (id),
  CONSTRAINT tpl_order_sync_log_order_id_fkey FOREIGN KEY (order_id) REFERENCES public.orders(id),
  CONSTRAINT tpl_order_sync_log_tpl_provider_id_fkey FOREIGN KEY (tpl_provider_id) REFERENCES public.tpl_providers(id),
  CONSTRAINT tpl_order_sync_log_tpl_order_request_id_fkey FOREIGN KEY (tpl_order_request_id) REFERENCES public.tpl_order_requests(id),
  CONSTRAINT tpl_order_sync_log_tpl_inbound_order_id_fkey FOREIGN KEY (tpl_inbound_order_id) REFERENCES public.tpl_inbound_orders(id)
);
CREATE TABLE public.tpl_provider_capabilities (
  id bigint NOT NULL DEFAULT nextval('tpl_provider_capabilities_id_seq'::regclass),
  tpl_provider_id bigint NOT NULL,
  order_type text NOT NULL CHECK (order_type = ANY (ARRAY['food'::text, 'parcel'::text, 'person_ride'::text])),
  supported_features ARRAY DEFAULT ARRAY[]::text[],
  max_weight_kg numeric,
  max_distance_km numeric,
  min_distance_km numeric DEFAULT 0,
  service_areas jsonb DEFAULT '{}'::jsonb,
  operating_hours jsonb DEFAULT '{}'::jsonb,
  pricing_model text CHECK (pricing_model = ANY (ARRAY['fixed'::text, 'distance_based'::text, 'time_based'::text, 'weight_based'::text, 'hybrid'::text])),
  commission_structure jsonb DEFAULT '{}'::jsonb,
  is_active boolean DEFAULT true,
  created_at timestamp with time zone NOT NULL DEFAULT now(),
  updated_at timestamp with time zone NOT NULL DEFAULT now(),
  CONSTRAINT tpl_provider_capabilities_pkey PRIMARY KEY (id),
  CONSTRAINT tpl_provider_capabilities_tpl_provider_id_fkey FOREIGN KEY (tpl_provider_id) REFERENCES public.tpl_providers(id)
);
CREATE TABLE public.tpl_providers (
  id bigint NOT NULL DEFAULT nextval('tpl_providers_id_seq'::regclass),
  provider_id text NOT NULL UNIQUE,
  provider_name text NOT NULL,
  provider_type text NOT NULL CHECK (provider_type = ANY (ARRAY['food'::text, 'parcel'::text, 'person_ride'::text, 'multi'::text])),
  integration_type text NOT NULL CHECK (integration_type = ANY (ARRAY['inbound'::text, 'outbound'::text, 'bidirectional'::text])),
  api_base_url text,
  api_key text,
  api_secret text,
  webhook_url text,
  webhook_secret text,
  status text NOT NULL DEFAULT 'active'::text CHECK (status = ANY (ARRAY['active'::text, 'inactive'::text, 'suspended'::text, 'testing'::text])),
  supported_order_types ARRAY NOT NULL DEFAULT ARRAY[]::text[],
  commission_rate numeric,
  service_areas jsonb DEFAULT '{}'::jsonb,
  capabilities jsonb DEFAULT '{}'::jsonb,
  metadata jsonb DEFAULT '{}'::jsonb,
  created_at timestamp with time zone NOT NULL DEFAULT now(),
  updated_at timestamp with time zone NOT NULL DEFAULT now(),
  CONSTRAINT tpl_providers_pkey PRIMARY KEY (id)
);
CREATE TABLE public.unified_ticket_activities (
  id bigint NOT NULL DEFAULT nextval('unified_ticket_activities_id_seq'::regclass),
  ticket_id bigint NOT NULL,
  activity_type text NOT NULL,
  activity_description text NOT NULL,
  actor_type USER-DEFINED NOT NULL,
  actor_id bigint,
  actor_name text,
  old_value jsonb,
  new_value jsonb,
  created_at timestamp with time zone NOT NULL DEFAULT now(),
  CONSTRAINT unified_ticket_activities_pkey PRIMARY KEY (id),
  CONSTRAINT unified_ticket_activities_ticket_id_fkey FOREIGN KEY (ticket_id) REFERENCES public.unified_tickets(id)
);
CREATE TABLE public.unified_ticket_messages (
  id bigint NOT NULL DEFAULT nextval('unified_ticket_messages_id_seq'::regclass),
  ticket_id bigint NOT NULL,
  message_text text NOT NULL,
  message_type text NOT NULL DEFAULT 'TEXT'::text,
  sender_type USER-DEFINED NOT NULL,
  sender_id bigint,
  sender_name text,
  sender_email text,
  sender_mobile text,
  attachments ARRAY,
  is_internal_note boolean DEFAULT false,
  internal_note_for_agent_id integer,
  is_read boolean DEFAULT false,
  read_at timestamp with time zone,
  read_by integer,
  email_message_id text,
  email_in_reply_to text,
  created_at timestamp with time zone NOT NULL DEFAULT now(),
  updated_at timestamp with time zone NOT NULL DEFAULT now(),
  CONSTRAINT unified_ticket_messages_pkey PRIMARY KEY (id),
  CONSTRAINT unified_ticket_messages_ticket_id_fkey FOREIGN KEY (ticket_id) REFERENCES public.unified_tickets(id),
  CONSTRAINT unified_ticket_messages_internal_note_for_agent_id_fkey FOREIGN KEY (internal_note_for_agent_id) REFERENCES public.system_users(id),
  CONSTRAINT unified_ticket_messages_read_by_fkey FOREIGN KEY (read_by) REFERENCES public.system_users(id)
);
CREATE TABLE public.unified_tickets (
  id bigint NOT NULL DEFAULT nextval('unified_tickets_id_seq'::regclass),
  ticket_id text NOT NULL UNIQUE,
  ticket_type USER-DEFINED NOT NULL,
  ticket_source USER-DEFINED NOT NULL,
  service_type USER-DEFINED NOT NULL,
  ticket_title USER-DEFINED NOT NULL,
  ticket_category USER-DEFINED NOT NULL,
  order_id bigint,
  customer_id bigint,
  rider_id integer,
  merchant_store_id bigint,
  merchant_parent_id bigint,
  raised_by_type USER-DEFINED NOT NULL,
  raised_by_id bigint,
  raised_by_name text,
  raised_by_mobile text,
  raised_by_email text,
  subject text NOT NULL,
  description text NOT NULL,
  attachments ARRAY,
  priority USER-DEFINED NOT NULL DEFAULT 'MEDIUM'::unified_ticket_priority,
  status USER-DEFINED NOT NULL DEFAULT 'OPEN'::unified_ticket_status,
  assigned_to_agent_id integer,
  assigned_to_agent_name text,
  assigned_at timestamp with time zone,
  auto_assigned boolean DEFAULT false,
  resolution text,
  resolution_time_minutes integer,
  resolved_at timestamp with time zone,
  resolved_by integer,
  resolved_by_name text,
  escalated boolean DEFAULT false,
  escalated_at timestamp with time zone,
  escalated_to integer,
  escalated_reason text,
  escalation_level integer DEFAULT 0,
  first_response_at timestamp with time zone,
  first_response_time_minutes integer,
  last_response_at timestamp with time zone,
  last_response_by_type USER-DEFINED,
  last_response_by_id bigint,
  follow_up_required boolean DEFAULT false,
  follow_up_date timestamp with time zone,
  follow_up_notes text,
  satisfaction_rating smallint CHECK (satisfaction_rating >= 1 AND satisfaction_rating <= 5),
  satisfaction_feedback text,
  satisfaction_collected_at timestamp with time zone,
  parent_ticket_id bigint,
  related_ticket_ids ARRAY,
  tags ARRAY,
  email_message_id text,
  email_thread_id text,
  email_from_address text,
  email_subject text,
  auto_generated boolean DEFAULT false,
  auto_generation_rule text,
  auto_generation_metadata jsonb DEFAULT '{}'::jsonb,
  metadata jsonb DEFAULT '{}'::jsonb,
  created_at timestamp with time zone NOT NULL DEFAULT now(),
  updated_at timestamp with time zone NOT NULL DEFAULT now(),
  closed_at timestamp with time zone,
  order_type text,
  CONSTRAINT unified_tickets_pkey PRIMARY KEY (id),
  CONSTRAINT unified_tickets_order_id_fkey FOREIGN KEY (order_id) REFERENCES public.orders(id),
  CONSTRAINT unified_tickets_customer_id_fkey FOREIGN KEY (customer_id) REFERENCES public.customers(id),
  CONSTRAINT unified_tickets_rider_id_fkey FOREIGN KEY (rider_id) REFERENCES public.riders(id),
  CONSTRAINT unified_tickets_merchant_parent_id_fkey FOREIGN KEY (merchant_parent_id) REFERENCES public.merchant_parents(id),
  CONSTRAINT unified_tickets_assigned_to_agent_id_fkey FOREIGN KEY (assigned_to_agent_id) REFERENCES public.system_users(id),
  CONSTRAINT unified_tickets_resolved_by_fkey FOREIGN KEY (resolved_by) REFERENCES public.system_users(id),
  CONSTRAINT unified_tickets_escalated_to_fkey FOREIGN KEY (escalated_to) REFERENCES public.system_users(id),
  CONSTRAINT unified_tickets_parent_ticket_id_fkey FOREIGN KEY (parent_ticket_id) REFERENCES public.unified_tickets(id)
);
CREATE TABLE public.user_data (
  id uuid NOT NULL DEFAULT gen_random_uuid(),
  email text NOT NULL UNIQUE,
  otp text,
  system_details jsonb,
  login_time timestamp without time zone,
  logout_time timestamp without time zone,
  created_at timestamp without time zone DEFAULT now(),
  updated_at timestamp without time zone DEFAULT now(),
  expires_at_ms bigint,
  CONSTRAINT user_data_pkey PRIMARY KEY (id)
);
CREATE TABLE public.user_permission_overrides (
  id bigint NOT NULL DEFAULT nextval('user_permission_overrides_id_seq'::regclass),
  system_user_id bigint NOT NULL,
  permission_id bigint NOT NULL,
  override_type text NOT NULL,
  is_allowed boolean NOT NULL,
  override_reason text NOT NULL,
  service_scope ARRAY,
  geo_scope ARRAY,
  valid_from timestamp with time zone DEFAULT now(),
  valid_until timestamp with time zone,
  is_active boolean DEFAULT true,
  granted_by bigint NOT NULL,
  granted_by_name text,
  granted_at timestamp with time zone NOT NULL DEFAULT now(),
  revoked_at timestamp with time zone,
  revoked_by bigint,
  created_at timestamp with time zone NOT NULL DEFAULT now(),
  CONSTRAINT user_permission_overrides_pkey PRIMARY KEY (id),
  CONSTRAINT user_permission_overrides_system_user_id_fkey FOREIGN KEY (system_user_id) REFERENCES public.system_users(id),
  CONSTRAINT user_permission_overrides_permission_id_fkey FOREIGN KEY (permission_id) REFERENCES public.system_permissions(id),
  CONSTRAINT user_permission_overrides_granted_by_fkey FOREIGN KEY (granted_by) REFERENCES public.system_users(id),
  CONSTRAINT user_permission_overrides_revoked_by_fkey FOREIGN KEY (revoked_by) REFERENCES public.system_users(id)
);
CREATE TABLE public.user_roles (
  id bigint NOT NULL DEFAULT nextval('user_roles_id_seq'::regclass),
  system_user_id bigint NOT NULL,
  role_id bigint NOT NULL,
  is_primary boolean DEFAULT false,
  valid_from timestamp with time zone DEFAULT now(),
  valid_until timestamp with time zone,
  is_active boolean DEFAULT true,
  assigned_by bigint NOT NULL,
  assigned_by_name text,
  assigned_at timestamp with time zone NOT NULL DEFAULT now(),
  revoked_at timestamp with time zone,
  revoked_by bigint,
  revoke_reason text,
  created_at timestamp with time zone NOT NULL DEFAULT now(),
  service_type ARRAY,
  ticket_section ARRAY,
  assigned_by_user_id bigint,
  expires_at timestamp with time zone,
  CONSTRAINT user_roles_pkey PRIMARY KEY (id),
  CONSTRAINT user_roles_system_user_id_fkey FOREIGN KEY (system_user_id) REFERENCES public.system_users(id),
  CONSTRAINT user_roles_role_id_fkey FOREIGN KEY (role_id) REFERENCES public.system_roles(id),
  CONSTRAINT user_roles_assigned_by_fkey FOREIGN KEY (assigned_by) REFERENCES public.system_users(id),
  CONSTRAINT user_roles_revoked_by_fkey FOREIGN KEY (revoked_by) REFERENCES public.system_users(id),
  CONSTRAINT user_roles_assigned_by_user_id_fkey FOREIGN KEY (assigned_by_user_id) REFERENCES public.system_users(id)
);
CREATE TABLE public.vehicle_service_mapping (
  id bigint NOT NULL DEFAULT nextval('vehicle_service_mapping_id_seq'::regclass),
  vehicle_type text NOT NULL,
  service_type_id bigint NOT NULL,
  allowed boolean NOT NULL DEFAULT true,
  created_at timestamp with time zone NOT NULL DEFAULT now(),
  updated_at timestamp with time zone NOT NULL DEFAULT now(),
  CONSTRAINT vehicle_service_mapping_pkey PRIMARY KEY (id),
  CONSTRAINT vehicle_service_mapping_service_type_id_fkey FOREIGN KEY (service_type_id) REFERENCES public.service_types(id)
);
CREATE TABLE public.wallet_credit_requests (
  id bigint NOT NULL DEFAULT nextval('wallet_credit_requests_id_seq'::regclass),
  rider_id integer NOT NULL,
  order_id bigint,
  service_type text CHECK (service_type = ANY (ARRAY['food'::text, 'parcel'::text, 'person_ride'::text])),
  amount numeric NOT NULL CHECK (amount > 0::numeric),
  reason text NOT NULL,
  status text NOT NULL DEFAULT 'pending'::text CHECK (status = ANY (ARRAY['pending'::text, 'approved'::text, 'rejected'::text])),
  idempotency_key text,
  requested_by_system_user_id integer NOT NULL,
  requested_by_email text,
  requested_at timestamp with time zone NOT NULL DEFAULT now(),
  reviewed_by_system_user_id integer,
  reviewed_by_email text,
  reviewed_at timestamp with time zone,
  review_note text,
  approved_ledger_ref text UNIQUE,
  metadata jsonb NOT NULL DEFAULT '{}'::jsonb,
  CONSTRAINT wallet_credit_requests_pkey PRIMARY KEY (id),
  CONSTRAINT wallet_credit_requests_rider_id_fkey FOREIGN KEY (rider_id) REFERENCES public.riders(id),
  CONSTRAINT wallet_credit_requests_order_id_fkey FOREIGN KEY (order_id) REFERENCES public.orders(id),
  CONSTRAINT wallet_credit_requests_requested_by_system_user_id_fkey FOREIGN KEY (requested_by_system_user_id) REFERENCES public.system_users(id),
  CONSTRAINT wallet_credit_requests_reviewed_by_system_user_id_fkey FOREIGN KEY (reviewed_by_system_user_id) REFERENCES public.system_users(id)
);
CREATE TABLE public.wallet_ledger (
  id bigint NOT NULL DEFAULT nextval('wallet_ledger_id_seq'::regclass),
  rider_id integer NOT NULL,
  entry_type USER-DEFINED NOT NULL,
  amount numeric NOT NULL CHECK (amount >= 0::numeric),
  balance numeric,
  ref text,
  ref_type text,
  description text,
  metadata jsonb DEFAULT '{}'::jsonb,
  created_at timestamp with time zone NOT NULL DEFAULT now(),
  service_type text,
  performed_by_type text DEFAULT 'system'::text,
  performed_by_id integer,
  CONSTRAINT wallet_ledger_pkey PRIMARY KEY (id, rider_id),
  CONSTRAINT wallet_ledger_rider_id_fkey FOREIGN KEY (rider_id) REFERENCES public.riders(id),
  CONSTRAINT wallet_ledger_performed_by_id_fkey FOREIGN KEY (performed_by_id) REFERENCES public.system_users(id)
);
CREATE TABLE public.wallet_ledger_0 (
  id bigint NOT NULL DEFAULT nextval('wallet_ledger_id_seq'::regclass),
  rider_id integer NOT NULL,
  entry_type USER-DEFINED NOT NULL,
  amount numeric NOT NULL CHECK (amount >= 0::numeric),
  balance numeric,
  ref text,
  ref_type text,
  description text,
  metadata jsonb DEFAULT '{}'::jsonb,
  created_at timestamp with time zone NOT NULL DEFAULT now(),
  service_type text,
  performed_by_type text DEFAULT 'system'::text,
  performed_by_id integer,
  CONSTRAINT wallet_ledger_0_pkey PRIMARY KEY (id, rider_id),
  CONSTRAINT wallet_ledger_rider_id_fkey FOREIGN KEY (rider_id) REFERENCES public.riders(id),
  CONSTRAINT wallet_ledger_performed_by_id_fkey FOREIGN KEY (performed_by_id) REFERENCES public.system_users(id)
);
CREATE TABLE public.wallet_ledger_1 (
  id bigint NOT NULL DEFAULT nextval('wallet_ledger_id_seq'::regclass),
  rider_id integer NOT NULL,
  entry_type USER-DEFINED NOT NULL,
  amount numeric NOT NULL CHECK (amount >= 0::numeric),
  balance numeric,
  ref text,
  ref_type text,
  description text,
  metadata jsonb DEFAULT '{}'::jsonb,
  created_at timestamp with time zone NOT NULL DEFAULT now(),
  service_type text,
  performed_by_type text DEFAULT 'system'::text,
  performed_by_id integer,
  CONSTRAINT wallet_ledger_1_pkey PRIMARY KEY (id, rider_id),
  CONSTRAINT wallet_ledger_rider_id_fkey FOREIGN KEY (rider_id) REFERENCES public.riders(id),
  CONSTRAINT wallet_ledger_performed_by_id_fkey FOREIGN KEY (performed_by_id) REFERENCES public.system_users(id)
);
CREATE TABLE public.wallet_ledger_2 (
  id bigint NOT NULL DEFAULT nextval('wallet_ledger_id_seq'::regclass),
  rider_id integer NOT NULL,
  entry_type USER-DEFINED NOT NULL,
  amount numeric NOT NULL CHECK (amount >= 0::numeric),
  balance numeric,
  ref text,
  ref_type text,
  description text,
  metadata jsonb DEFAULT '{}'::jsonb,
  created_at timestamp with time zone NOT NULL DEFAULT now(),
  service_type text,
  performed_by_type text DEFAULT 'system'::text,
  performed_by_id integer,
  CONSTRAINT wallet_ledger_2_pkey PRIMARY KEY (id, rider_id),
  CONSTRAINT wallet_ledger_rider_id_fkey FOREIGN KEY (rider_id) REFERENCES public.riders(id),
  CONSTRAINT wallet_ledger_performed_by_id_fkey FOREIGN KEY (performed_by_id) REFERENCES public.system_users(id)
);
CREATE TABLE public.wallet_ledger_3 (
  id bigint NOT NULL DEFAULT nextval('wallet_ledger_id_seq'::regclass),
  rider_id integer NOT NULL,
  entry_type USER-DEFINED NOT NULL,
  amount numeric NOT NULL CHECK (amount >= 0::numeric),
  balance numeric,
  ref text,
  ref_type text,
  description text,
  metadata jsonb DEFAULT '{}'::jsonb,
  created_at timestamp with time zone NOT NULL DEFAULT now(),
  service_type text,
  performed_by_type text DEFAULT 'system'::text,
  performed_by_id integer,
  CONSTRAINT wallet_ledger_3_pkey PRIMARY KEY (id, rider_id),
  CONSTRAINT wallet_ledger_rider_id_fkey FOREIGN KEY (rider_id) REFERENCES public.riders(id),
  CONSTRAINT wallet_ledger_performed_by_id_fkey FOREIGN KEY (performed_by_id) REFERENCES public.system_users(id)
);
CREATE TABLE public.webhook_configurations (
  id bigint NOT NULL DEFAULT nextval('webhook_configurations_id_seq'::regclass),
  provider_type USER-DEFINED NOT NULL,
  event_type text NOT NULL,
  webhook_url text NOT NULL,
  secret_key text NOT NULL,
  enabled boolean DEFAULT true,
  retry_on_failure boolean DEFAULT true,
  max_retries integer DEFAULT 3,
  timeout_seconds integer DEFAULT 30,
  metadata jsonb DEFAULT '{}'::jsonb,
  created_at timestamp with time zone NOT NULL DEFAULT now(),
  updated_at timestamp with time zone NOT NULL DEFAULT now(),
  CONSTRAINT webhook_configurations_pkey PRIMARY KEY (id)
);
CREATE TABLE public.webhook_events (
  id bigint NOT NULL DEFAULT nextval('webhook_events_id_seq'::regclass),
  provider_type USER-DEFINED NOT NULL,
  event_type text NOT NULL,
  event_id text,
  payload jsonb NOT NULL,
  signature text,
  signature_verified boolean DEFAULT false,
  status USER-DEFINED NOT NULL DEFAULT 'pending'::webhook_event_status,
  processing_attempts integer DEFAULT 0,
  max_attempts integer DEFAULT 3,
  error_message text,
  error_stack text,
  processed_order_id bigint,
  processed_at timestamp with time zone,
  created_at timestamp with time zone NOT NULL DEFAULT now(),
  order_id bigint,
  CONSTRAINT webhook_events_pkey PRIMARY KEY (id),
  CONSTRAINT webhook_events_processed_order_id_fkey FOREIGN KEY (processed_order_id) REFERENCES public.orders(id),
  CONSTRAINT webhook_events_order_id_fkey FOREIGN KEY (order_id) REFERENCES public.orders(id)
);
CREATE TABLE public.withdrawal_requests (
  id bigint NOT NULL DEFAULT nextval('withdrawal_requests_id_seq'::regclass),
  rider_id integer NOT NULL,
  amount numeric NOT NULL CHECK (amount > 0::numeric),
  status USER-DEFINED NOT NULL DEFAULT 'pending'::withdrawal_status,
  bank_acc text NOT NULL,
  ifsc text NOT NULL,
  account_holder_name text NOT NULL,
  upi_id text,
  transaction_id text,
  failure_reason text,
  processed_at timestamp with time zone,
  metadata jsonb DEFAULT '{}'::jsonb,
  created_at timestamp with time zone NOT NULL DEFAULT now(),
  updated_at timestamp with time zone NOT NULL DEFAULT now(),
  settlement_batch_id bigint,
  payment_method_id bigint,
  CONSTRAINT withdrawal_requests_pkey PRIMARY KEY (id),
  CONSTRAINT withdrawal_requests_rider_id_fkey FOREIGN KEY (rider_id) REFERENCES public.riders(id),
  CONSTRAINT withdrawal_requests_settlement_batch_id_fkey FOREIGN KEY (settlement_batch_id) REFERENCES public.settlement_batches(id),
  CONSTRAINT withdrawal_requests_payment_method_id_fkey FOREIGN KEY (payment_method_id) REFERENCES public.rider_payment_methods(id)
);